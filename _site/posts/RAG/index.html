<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.8.25">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Tony D">
<meta name="dcterms.date" content="2025-11-02">

<title>Retrieval-Augmented Generation(RAG) in R &amp; Python – AI Blog</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
html { -webkit-text-size-adjust: 100%; }
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="../../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../../site_libs/clipboard/clipboard.min.js"></script>
<script src="../../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../../site_libs/quarto-search/fuse.min.js"></script>
<script src="../../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../../">
<script src="../../site_libs/quarto-html/quarto.js" type="module"></script>
<script src="../../site_libs/quarto-html/tabsets/tabsets.js" type="module"></script>
<script src="../../site_libs/quarto-html/axe/axe-check.js" type="module"></script>
<script src="../../site_libs/quarto-html/popper.min.js"></script>
<script src="../../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../../site_libs/quarto-html/anchor.min.js"></script>
<link href="../../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../../site_libs/quarto-html/quarto-syntax-highlighting-7b89279ff1a6dce999919e0e67d4d9ec.css" rel="stylesheet" class="quarto-color-scheme" id="quarto-text-highlighting-styles">
<link href="../../site_libs/quarto-html/quarto-syntax-highlighting-dark-707d8167ce6003fca903bfe2be84ab7f.css" rel="stylesheet" class="quarto-color-scheme quarto-color-alternate" id="quarto-text-highlighting-styles">
<link href="../../site_libs/quarto-html/quarto-syntax-highlighting-7b89279ff1a6dce999919e0e67d4d9ec.css" rel="stylesheet" class="quarto-color-scheme-extra" id="quarto-text-highlighting-styles">
<script src="../../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../../site_libs/bootstrap/bootstrap-28ad77b932cb64f076aa57a7485efe60.min.css" rel="stylesheet" append-hash="true" class="quarto-color-scheme" id="quarto-bootstrap" data-mode="light">
<link href="../../site_libs/bootstrap/bootstrap-dark-6f7adc439b99bc5791e8a7d0c278bee2.min.css" rel="stylesheet" append-hash="true" class="quarto-color-scheme quarto-color-alternate" id="quarto-bootstrap" data-mode="dark">
<link href="../../site_libs/bootstrap/bootstrap-28ad77b932cb64f076aa57a7485efe60.min.css" rel="stylesheet" append-hash="true" class="quarto-color-scheme-extra" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>


<link rel="stylesheet" href="../../styles.css">
</head>

<body class="nav-fixed quarto-light"><script id="quarto-html-before-body" type="application/javascript">
    const toggleBodyColorMode = (bsSheetEl) => {
      const mode = bsSheetEl.getAttribute("data-mode");
      const bodyEl = window.document.querySelector("body");
      if (mode === "dark") {
        bodyEl.classList.add("quarto-dark");
        bodyEl.classList.remove("quarto-light");
      } else {
        bodyEl.classList.add("quarto-light");
        bodyEl.classList.remove("quarto-dark");
      }
    }
    const toggleBodyColorPrimary = () => {
      const bsSheetEl = window.document.querySelector("link#quarto-bootstrap:not([rel=disabled-stylesheet])");
      if (bsSheetEl) {
        toggleBodyColorMode(bsSheetEl);
      }
    }
    const setColorSchemeToggle = (alternate) => {
      const toggles = window.document.querySelectorAll('.quarto-color-scheme-toggle');
      for (let i=0; i < toggles.length; i++) {
        const toggle = toggles[i];
        if (toggle) {
          if (alternate) {
            toggle.classList.add("alternate");
          } else {
            toggle.classList.remove("alternate");
          }
        }
      }
    };
    const toggleColorMode = (alternate) => {
      // Switch the stylesheets
      const primaryStylesheets = window.document.querySelectorAll('link.quarto-color-scheme:not(.quarto-color-alternate)');
      const alternateStylesheets = window.document.querySelectorAll('link.quarto-color-scheme.quarto-color-alternate');
      manageTransitions('#quarto-margin-sidebar .nav-link', false);
      if (alternate) {
        // note: dark is layered on light, we don't disable primary!
        enableStylesheet(alternateStylesheets);
        for (const sheetNode of alternateStylesheets) {
          if (sheetNode.id === "quarto-bootstrap") {
            toggleBodyColorMode(sheetNode);
          }
        }
      } else {
        disableStylesheet(alternateStylesheets);
        enableStylesheet(primaryStylesheets)
        toggleBodyColorPrimary();
      }
      manageTransitions('#quarto-margin-sidebar .nav-link', true);
      // Switch the toggles
      setColorSchemeToggle(alternate)
      // Hack to workaround the fact that safari doesn't
      // properly recolor the scrollbar when toggling (#1455)
      if (navigator.userAgent.indexOf('Safari') > 0 && navigator.userAgent.indexOf('Chrome') == -1) {
        manageTransitions("body", false);
        window.scrollTo(0, 1);
        setTimeout(() => {
          window.scrollTo(0, 0);
          manageTransitions("body", true);
        }, 40);
      }
    }
    const disableStylesheet = (stylesheets) => {
      for (let i=0; i < stylesheets.length; i++) {
        const stylesheet = stylesheets[i];
        stylesheet.rel = 'disabled-stylesheet';
      }
    }
    const enableStylesheet = (stylesheets) => {
      for (let i=0; i < stylesheets.length; i++) {
        const stylesheet = stylesheets[i];
        if(stylesheet.rel !== 'stylesheet') { // for Chrome, which will still FOUC without this check
          stylesheet.rel = 'stylesheet';
        }
      }
    }
    const manageTransitions = (selector, allowTransitions) => {
      const els = window.document.querySelectorAll(selector);
      for (let i=0; i < els.length; i++) {
        const el = els[i];
        if (allowTransitions) {
          el.classList.remove('notransition');
        } else {
          el.classList.add('notransition');
        }
      }
    }
    const isFileUrl = () => {
      return window.location.protocol === 'file:';
    }
    const hasAlternateSentinel = () => {
      let styleSentinel = getColorSchemeSentinel();
      if (styleSentinel !== null) {
        return styleSentinel === "alternate";
      } else {
        return false;
      }
    }
    const setStyleSentinel = (alternate) => {
      const value = alternate ? "alternate" : "default";
      if (!isFileUrl()) {
        window.localStorage.setItem("quarto-color-scheme", value);
      } else {
        localAlternateSentinel = value;
      }
    }
    const getColorSchemeSentinel = () => {
      if (!isFileUrl()) {
        const storageValue = window.localStorage.getItem("quarto-color-scheme");
        return storageValue != null ? storageValue : localAlternateSentinel;
      } else {
        return localAlternateSentinel;
      }
    }
    const toggleGiscusIfUsed = (isAlternate, darkModeDefault) => {
      const baseTheme = document.querySelector('#giscus-base-theme')?.value ?? 'light';
      const alternateTheme = document.querySelector('#giscus-alt-theme')?.value ?? 'dark';
      let newTheme = '';
      if(authorPrefersDark) {
        newTheme = isAlternate ? baseTheme : alternateTheme;
      } else {
        newTheme = isAlternate ? alternateTheme : baseTheme;
      }
      const changeGiscusTheme = () => {
        // From: https://github.com/giscus/giscus/issues/336
        const sendMessage = (message) => {
          const iframe = document.querySelector('iframe.giscus-frame');
          if (!iframe) return;
          iframe.contentWindow.postMessage({ giscus: message }, 'https://giscus.app');
        }
        sendMessage({
          setConfig: {
            theme: newTheme
          }
        });
      }
      const isGiscussLoaded = window.document.querySelector('iframe.giscus-frame') !== null;
      if (isGiscussLoaded) {
        changeGiscusTheme();
      }
    };
    const authorPrefersDark = false;
    const darkModeDefault = authorPrefersDark;
      document.querySelector('link#quarto-text-highlighting-styles.quarto-color-scheme-extra').rel = 'disabled-stylesheet';
      document.querySelector('link#quarto-bootstrap.quarto-color-scheme-extra').rel = 'disabled-stylesheet';
    let localAlternateSentinel = darkModeDefault ? 'alternate' : 'default';
    // Dark / light mode switch
    window.quartoToggleColorScheme = () => {
      // Read the current dark / light value
      let toAlternate = !hasAlternateSentinel();
      toggleColorMode(toAlternate);
      setStyleSentinel(toAlternate);
      toggleGiscusIfUsed(toAlternate, darkModeDefault);
      window.dispatchEvent(new Event('resize'));
    };
    // Switch to dark mode if need be
    if (hasAlternateSentinel()) {
      toggleColorMode(true);
    } else {
      toggleColorMode(false);
    }
  </script>

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a href="../../index.html" class="navbar-brand navbar-brand-logo">
    </a>
    <a class="navbar-brand" href="../../index.html">
    <span class="navbar-title">AI Blog</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" role="menu" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item">
    <a class="nav-link" href="../../about.html"> 
<span class="menu-text">About</span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://github.com/"> <i class="bi bi-github" role="img">
</i> 
<span class="menu-text"></span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://twitter.com"> <i class="bi bi-twitter" role="img">
</i> 
<span class="menu-text"></span></a>
  </li>  
</ul>
          </div> <!-- /navcollapse -->
            <div class="quarto-navbar-tools">
  <a href="" class="quarto-color-scheme-toggle quarto-navigation-tool  px-1" onclick="window.quartoToggleColorScheme(); return false;" title="Toggle dark mode"><i class="bi"></i></a>
</div>
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-full page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#introduction" id="toc-introduction" class="nav-link active" data-scroll-target="#introduction">Introduction</a></li>
  <li><a href="#data-collection" id="toc-data-collection" class="nav-link" data-scroll-target="#data-collection">Data Collection</a></li>
  <li><a href="#save-web-to-local-data" id="toc-save-web-to-local-data" class="nav-link" data-scroll-target="#save-web-to-local-data">Save web to local data</a></li>
  <li><a href="#retrieval" id="toc-retrieval" class="nav-link" data-scroll-target="#retrieval">Retrieval</a></li>
  <li><a href="#chat-with-rag" id="toc-chat-with-rag" class="nav-link" data-scroll-target="#chat-with-rag">Chat with RAG</a></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content column-page-left" id="quarto-document-content">


<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<div class="quarto-title-block"><div><h1 class="title">Retrieval-Augmented Generation(RAG) in R &amp; Python</h1><button type="button" class="btn code-tools-button" id="quarto-code-tools-source"><i class="bi"></i> Code</button></div></div>
  <div class="quarto-categories">
    <div class="quarto-category">AI</div>
    <div class="quarto-category">API</div>
    <div class="quarto-category">tutorial</div>
  </div>
  </div>



<div class="quarto-title-meta column-page-left">

    <div>
    <div class="quarto-title-meta-heading">Author</div>
    <div class="quarto-title-meta-contents">
             <p>Tony D </p>
          </div>
  </div>
    
    <div>
    <div class="quarto-title-meta-heading">Published</div>
    <div class="quarto-title-meta-contents">
      <p class="date">November 2, 2025</p>
    </div>
  </div>
  
    
  </div>
  


</header>


<section id="introduction" class="level1">
<h1>Introduction</h1>
<p>Retrieval-Augmented Generation (RAG) is a powerful technique that combines the generative capabilities of Large Language Models (LLMs) with the precision of information retrieval. By grounding LLM responses in external, verifiable data, RAG reduces hallucinations and enables the model to answer questions about specific, private, or up-to-date information.</p>
<p>In this tutorial, we will build a RAG system using both R and Python.</p>
<p>In R, we’ll leverage the <code>ragnar</code> package for RAG workflows and <code>ellmer</code> for chat interfaces.</p>
<p>In Python, we’ll use <code>LangChain</code> for the RAG pipeline, <code>ChromaDB</code> for the vector store, and <code>OpenAI</code> for model interaction.</p>
<p>Our goal is to create a system that can answer questions about the OpenRouter API by scraping its documentation.</p>
</section>
<section id="data-collection" class="level1">
<h1>Data Collection</h1>
<div class="tabset-margin-container"></div><div class="panel-tabset">
<ul class="nav nav-tabs" role="tablist"><li class="nav-item" role="presentation"><a class="nav-link active" id="tabset-1-1-tab" data-bs-toggle="tab" data-bs-target="#tabset-1-1" role="tab" aria-controls="tabset-1-1" aria-selected="true" href="">R</a></li><li class="nav-item" role="presentation"><a class="nav-link" id="tabset-1-2-tab" data-bs-toggle="tab" data-bs-target="#tabset-1-2" role="tab" aria-controls="tabset-1-2" aria-selected="false" href="">Python</a></li></ul>
<div class="tab-content">
<div id="tabset-1-1" class="tab-pane active" role="tabpanel" aria-labelledby="tabset-1-1-tab">
<p>First, we need to gather the data for our knowledge base. We’ll use the <code>rvest</code> package to scrape URLs from the OpenRouter documentation. This will give us a list of pages to ingest.</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ragnar)</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ellmer)</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(dotenv)</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="fu">load_dot_env</span>(<span class="at">file =</span> <span class="st">".env"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb2"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(rvest)</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a><span class="co"># URL to scrape</span></span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a>url <span class="ot">&lt;-</span> <span class="st">"https://openrouter.ai/docs/quickstart"</span></span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Read the HTML content of the page</span></span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a>page <span class="ot">&lt;-</span> <span class="fu">read_html</span>(url)</span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a><span class="co"># Extract all &lt;a&gt; tags with href</span></span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a>links <span class="ot">&lt;-</span> page <span class="sc">%&gt;%</span></span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true" tabindex="-1"></a>    <span class="fu">html_nodes</span>(<span class="st">"a"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb2-12"><a href="#cb2-12" aria-hidden="true" tabindex="-1"></a>    <span class="fu">html_attr</span>(<span class="st">"href"</span>)</span>
<span id="cb2-13"><a href="#cb2-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-14"><a href="#cb2-14" aria-hidden="true" tabindex="-1"></a><span class="co"># Remove NAs and duplicates</span></span>
<span id="cb2-15"><a href="#cb2-15" aria-hidden="true" tabindex="-1"></a>links <span class="ot">&lt;-</span> <span class="fu">unique</span>(<span class="fu">na.omit</span>(links))</span>
<span id="cb2-16"><a href="#cb2-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-17"><a href="#cb2-17" aria-hidden="true" tabindex="-1"></a><span class="co"># Optional: keep only full URLs</span></span>
<span id="cb2-18"><a href="#cb2-18" aria-hidden="true" tabindex="-1"></a>links_full <span class="ot">&lt;-</span> <span class="fu">paste0</span>(<span class="st">"https://openrouter.ai"</span>, links[<span class="fu">grepl</span>(<span class="st">"^/docs/"</span>, links)])</span>
<span id="cb2-19"><a href="#cb2-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-20"><a href="#cb2-20" aria-hidden="true" tabindex="-1"></a><span class="co"># Print all links</span></span>
<span id="cb2-21"><a href="#cb2-21" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(links_full)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
</div>
<div id="tabset-1-2" class="tab-pane" role="tabpanel" aria-labelledby="tabset-1-2-tab">
<p>First, we need to gather the data for our knowledge base. We’ll use <code>requests</code> and <code>BeautifulSoup</code> to scrape URLs from the OpenRouter documentation. This will give us a list of pages to ingest.</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb3"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> sys</span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(sys.executable)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb4"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> requests</span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> bs4 <span class="im">import</span> BeautifulSoup</span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> dotenv <span class="im">import</span> load_dotenv</span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> os</span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> markitdown <span class="im">import</span> MarkItDown</span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> io <span class="im">import</span> BytesIO</span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> re</span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-9"><a href="#cb4-9" aria-hidden="true" tabindex="-1"></a><span class="co"># Load environment variables</span></span>
<span id="cb4-10"><a href="#cb4-10" aria-hidden="true" tabindex="-1"></a>load_dotenv()</span>
<span id="cb4-11"><a href="#cb4-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-12"><a href="#cb4-12" aria-hidden="true" tabindex="-1"></a><span class="co"># Helper functions</span></span>
<span id="cb4-13"><a href="#cb4-13" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> fetch_html(url: <span class="bu">str</span>) <span class="op">-&gt;</span> <span class="bu">bytes</span>:</span>
<span id="cb4-14"><a href="#cb4-14" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Fetch HTML content from URL and return as bytes."""</span></span>
<span id="cb4-15"><a href="#cb4-15" aria-hidden="true" tabindex="-1"></a>    resp <span class="op">=</span> requests.get(url)</span>
<span id="cb4-16"><a href="#cb4-16" aria-hidden="true" tabindex="-1"></a>    resp.raise_for_status()</span>
<span id="cb4-17"><a href="#cb4-17" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> resp.content</span>
<span id="cb4-18"><a href="#cb4-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-19"><a href="#cb4-19" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> html_to_markdown(html_bytes: <span class="bu">bytes</span>) <span class="op">-&gt;</span> <span class="bu">str</span>:</span>
<span id="cb4-20"><a href="#cb4-20" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Convert HTML bytes to markdown using MarkItDown."""</span></span>
<span id="cb4-21"><a href="#cb4-21" aria-hidden="true" tabindex="-1"></a>    md <span class="op">=</span> MarkItDown()</span>
<span id="cb4-22"><a href="#cb4-22" aria-hidden="true" tabindex="-1"></a>    stream <span class="op">=</span> BytesIO(html_bytes)</span>
<span id="cb4-23"><a href="#cb4-23" aria-hidden="true" tabindex="-1"></a>    result <span class="op">=</span> md.convert_stream(stream, mime_type<span class="op">=</span><span class="st">"text/html"</span>)</span>
<span id="cb4-24"><a href="#cb4-24" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> result.markdown</span>
<span id="cb4-25"><a href="#cb4-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-26"><a href="#cb4-26" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> save_markdown(md_content: <span class="bu">str</span>, output_path: <span class="bu">str</span>):</span>
<span id="cb4-27"><a href="#cb4-27" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Save markdown content to file."""</span></span>
<span id="cb4-28"><a href="#cb4-28" aria-hidden="true" tabindex="-1"></a>    <span class="cf">with</span> <span class="bu">open</span>(output_path, <span class="st">"w"</span>, encoding<span class="op">=</span><span class="st">"utf-8"</span>) <span class="im">as</span> f:</span>
<span id="cb4-29"><a href="#cb4-29" aria-hidden="true" tabindex="-1"></a>        f.write(md_content)</span>
<span id="cb4-30"><a href="#cb4-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-31"><a href="#cb4-31" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> sanitize_filename(filename: <span class="bu">str</span>) <span class="op">-&gt;</span> <span class="bu">str</span>:</span>
<span id="cb4-32"><a href="#cb4-32" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Sanitize URL to create a valid filename."""</span></span>
<span id="cb4-33"><a href="#cb4-33" aria-hidden="true" tabindex="-1"></a>    filename <span class="op">=</span> re.sub(<span class="vs">r'</span><span class="dv">^</span><span class="vs">https</span><span class="op">?</span><span class="vs">://</span><span class="pp">[^/]</span><span class="op">+</span><span class="vs">'</span>, <span class="st">''</span>, filename)</span>
<span id="cb4-34"><a href="#cb4-34" aria-hidden="true" tabindex="-1"></a>    filename <span class="op">=</span> re.sub(<span class="vs">r'</span><span class="pp">[^</span><span class="dv">\w</span><span class="ch">\-</span><span class="pp">_.]</span><span class="vs">'</span>, <span class="st">'_'</span>, filename)</span>
<span id="cb4-35"><a href="#cb4-35" aria-hidden="true" tabindex="-1"></a>    filename <span class="op">=</span> filename.strip(<span class="st">'_'</span>)</span>
<span id="cb4-36"><a href="#cb4-36" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="kw">not</span> filename.endswith(<span class="st">'.md'</span>):</span>
<span id="cb4-37"><a href="#cb4-37" aria-hidden="true" tabindex="-1"></a>        filename <span class="op">+=</span> <span class="st">'.md'</span></span>
<span id="cb4-38"><a href="#cb4-38" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> filename</span>
<span id="cb4-39"><a href="#cb4-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-40"><a href="#cb4-40" aria-hidden="true" tabindex="-1"></a><span class="co"># URL to scrape</span></span>
<span id="cb4-41"><a href="#cb4-41" aria-hidden="true" tabindex="-1"></a>url <span class="op">=</span> <span class="st">"https://openrouter.ai/docs/quickstart"</span></span>
<span id="cb4-42"><a href="#cb4-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-43"><a href="#cb4-43" aria-hidden="true" tabindex="-1"></a><span class="co"># Read the HTML content of the page</span></span>
<span id="cb4-44"><a href="#cb4-44" aria-hidden="true" tabindex="-1"></a>response <span class="op">=</span> requests.get(url)</span>
<span id="cb4-45"><a href="#cb4-45" aria-hidden="true" tabindex="-1"></a>soup <span class="op">=</span> BeautifulSoup(response.content, <span class="st">'html.parser'</span>)</span>
<span id="cb4-46"><a href="#cb4-46" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-47"><a href="#cb4-47" aria-hidden="true" tabindex="-1"></a><span class="co"># Extract all &lt;a&gt; tags with href</span></span>
<span id="cb4-48"><a href="#cb4-48" aria-hidden="true" tabindex="-1"></a>links <span class="op">=</span> [a[<span class="st">'href'</span>] <span class="cf">for</span> a <span class="kw">in</span> soup.find_all(<span class="st">'a'</span>, href<span class="op">=</span><span class="va">True</span>)]</span>
<span id="cb4-49"><a href="#cb4-49" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-50"><a href="#cb4-50" aria-hidden="true" tabindex="-1"></a><span class="co"># Remove duplicates</span></span>
<span id="cb4-51"><a href="#cb4-51" aria-hidden="true" tabindex="-1"></a>links <span class="op">=</span> <span class="bu">list</span>(<span class="bu">set</span>(links))</span>
<span id="cb4-52"><a href="#cb4-52" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-53"><a href="#cb4-53" aria-hidden="true" tabindex="-1"></a><span class="co"># Keep only full URLs for docs</span></span>
<span id="cb4-54"><a href="#cb4-54" aria-hidden="true" tabindex="-1"></a>links_full <span class="op">=</span> [<span class="ss">f"https://openrouter.ai</span><span class="sc">{</span>link<span class="sc">}</span><span class="ss">"</span> <span class="cf">for</span> link <span class="kw">in</span> links <span class="cf">if</span> link.startswith(<span class="st">"/docs/"</span>)]</span>
<span id="cb4-55"><a href="#cb4-55" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-56"><a href="#cb4-56" aria-hidden="true" tabindex="-1"></a><span class="co"># Explicitly add FAQ</span></span>
<span id="cb4-57"><a href="#cb4-57" aria-hidden="true" tabindex="-1"></a>links_full.append(<span class="st">"https://openrouter.ai/docs/faq"</span>)</span>
<span id="cb4-58"><a href="#cb4-58" aria-hidden="true" tabindex="-1"></a>links_full <span class="op">=</span> <span class="bu">list</span>(<span class="bu">set</span>(links_full))</span>
<span id="cb4-59"><a href="#cb4-59" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-60"><a href="#cb4-60" aria-hidden="true" tabindex="-1"></a><span class="co"># Print all links</span></span>
<span id="cb4-61"><a href="#cb4-61" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Found </span><span class="sc">{</span><span class="bu">len</span>(links_full)<span class="sc">}</span><span class="ss"> documentation URLs"</span>)</span>
<span id="cb4-62"><a href="#cb4-62" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(links_full)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
</div>
</div>
</div>
</section>
<section id="save-web-to-local-data" class="level1">
<h1>Save web to local data</h1>
<div class="tabset-margin-container"></div><div class="panel-tabset">
<ul class="nav nav-tabs" role="tablist"><li class="nav-item" role="presentation"><a class="nav-link active" id="tabset-2-1-tab" data-bs-toggle="tab" data-bs-target="#tabset-2-1" role="tab" aria-controls="tabset-2-1" aria-selected="true" href="">R</a></li><li class="nav-item" role="presentation"><a class="nav-link" id="tabset-2-2-tab" data-bs-toggle="tab" data-bs-target="#tabset-2-2" role="tab" aria-controls="tabset-2-2" aria-selected="false" href="">Python DuckDB</a></li><li class="nav-item" role="presentation"><a class="nav-link" id="tabset-2-3-tab" data-bs-toggle="tab" data-bs-target="#tabset-2-3" role="tab" aria-controls="tabset-2-3" aria-selected="false" href="">Python Chroma</a></li></ul>
<div class="tab-content">
<div id="tabset-2-1" class="tab-pane active" role="tabpanel" aria-labelledby="tabset-2-1-tab">
<p>To perform semantic search, we need to store our text data as vectors (embeddings). We’ll use <code>DuckDB</code> as our local vector store. We also need an embedding model to convert text into vectors. Here, we configure <code>ragnar</code> to use a specific embedding model via an OpenAI-compatible API (SiliconFlow).</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb5"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="co"># pages &lt;- ragnar_find_links(base_url)</span></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>pages <span class="ot">&lt;-</span> links_full</span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a>store_location <span class="ot">&lt;-</span> <span class="st">"openrouter.duckdb"</span></span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a>store <span class="ot">&lt;-</span> <span class="fu">ragnar_store_create</span>(</span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a>    store_location,</span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">overwrite =</span> <span class="cn">TRUE</span>,</span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">embed =</span> \(x) ragnar<span class="sc">::</span><span class="fu">embed_openai</span>(x,</span>
<span id="cb5-9"><a href="#cb5-9" aria-hidden="true" tabindex="-1"></a>        <span class="at">model =</span> <span class="st">"BAAI/bge-m3"</span>,</span>
<span id="cb5-10"><a href="#cb5-10" aria-hidden="true" tabindex="-1"></a>        <span class="at">base_url =</span> <span class="st">"https://api.siliconflow.cn/v1"</span>,</span>
<span id="cb5-11"><a href="#cb5-11" aria-hidden="true" tabindex="-1"></a>        <span class="at">api_key =</span> <span class="fu">Sys.getenv</span>(<span class="st">"siliconflow"</span>)</span>
<span id="cb5-12"><a href="#cb5-12" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb5-13"><a href="#cb5-13" aria-hidden="true" tabindex="-1"></a>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<p>With our store initialized, we can now ingest the data. We iterate through the list of pages we scraped earlier. For each page, we: 1. Read the content as markdown. 2. Split the content into smaller chunks (approx. 600 characters). 3. Insert these chunks into our vector store.</p>
<p>This process builds the index that we’ll search against.</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb6"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="co"># page="https://openrouter.ai/docs/faq"</span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a><span class="co"># chunks &lt;- page |&gt;read_as_markdown() |&gt;markdown_chunk(target_size = 2000)</span></span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a><span class="co"># ragnar_chunks_view(chunks)</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb7"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (page <span class="cf">in</span> pages) {</span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>    <span class="fu">message</span>(<span class="st">"ingesting: "</span>, page)</span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>    <span class="fu">print</span>(page)</span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a>    chunks <span class="ot">&lt;-</span> page <span class="sc">|&gt;</span></span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a>        <span class="fu">read_as_markdown</span>() <span class="sc">|&gt;</span></span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a>        <span class="fu">markdown_chunk</span>(<span class="at">target_size =</span> <span class="dv">2000</span>)</span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a>    <span class="co"># print(chunks)</span></span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true" tabindex="-1"></a>    <span class="co"># print('chunks done')</span></span>
<span id="cb7-9"><a href="#cb7-9" aria-hidden="true" tabindex="-1"></a>    <span class="fu">ragnar_store_insert</span>(store, chunks)</span>
<span id="cb7-10"><a href="#cb7-10" aria-hidden="true" tabindex="-1"></a>    <span class="fu">print</span>(<span class="st">"insrt done"</span>)</span>
<span id="cb7-11"><a href="#cb7-11" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb8"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ragnar_store_build_index</span>(store)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
</div>
<div id="tabset-2-2" class="tab-pane" role="tabpanel" aria-labelledby="tabset-2-2-tab">
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb9"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> os</span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> llama_index.core <span class="im">import</span> SimpleDirectoryReader, VectorStoreIndex, StorageContext, Settings</span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> llama_index.vector_stores.duckdb <span class="im">import</span> DuckDBVectorStore</span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> llama_index.embeddings.openai <span class="im">import</span> OpenAIEmbedding</span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a><span class="co"># --- 1. Configuration ---</span></span>
<span id="cb9-7"><a href="#cb9-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-8"><a href="#cb9-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Ensure your API key is available</span></span>
<span id="cb9-9"><a href="#cb9-9" aria-hidden="true" tabindex="-1"></a>openrouter_api_key <span class="op">=</span> os.getenv(<span class="st">"OPENROUTER_API_KEY"</span>) <span class="co"># or paste string directly</span></span>
<span id="cb9-10"><a href="#cb9-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-11"><a href="#cb9-11" aria-hidden="true" tabindex="-1"></a><span class="co"># Initialize the embedding model pointing to OpenRouter</span></span>
<span id="cb9-12"><a href="#cb9-12" aria-hidden="true" tabindex="-1"></a><span class="co"># We use the OpenAI class because OpenRouter uses an OpenAI-compatible API structure</span></span>
<span id="cb9-13"><a href="#cb9-13" aria-hidden="true" tabindex="-1"></a>embed_model <span class="op">=</span> OpenAIEmbedding(</span>
<span id="cb9-14"><a href="#cb9-14" aria-hidden="true" tabindex="-1"></a>    api_key<span class="op">=</span>openrouter_api_key,</span>
<span id="cb9-15"><a href="#cb9-15" aria-hidden="true" tabindex="-1"></a>    api_base<span class="op">=</span><span class="st">"https://openrouter.ai/api/v1"</span>,</span>
<span id="cb9-16"><a href="#cb9-16" aria-hidden="true" tabindex="-1"></a>    model_name<span class="op">=</span><span class="st">"qwen/qwen3-embedding-8b"</span></span>
<span id="cb9-17"><a href="#cb9-17" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb9-18"><a href="#cb9-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-19"><a href="#cb9-19" aria-hidden="true" tabindex="-1"></a><span class="co"># Update the global settings so LlamaIndex knows to use this model</span></span>
<span id="cb9-20"><a href="#cb9-20" aria-hidden="true" tabindex="-1"></a>Settings.embed_model <span class="op">=</span> embed_model</span>
<span id="cb9-21"><a href="#cb9-21" aria-hidden="true" tabindex="-1"></a>Settings.chunk_size <span class="op">=</span> <span class="dv">2000</span></span>
<span id="cb9-22"><a href="#cb9-22" aria-hidden="true" tabindex="-1"></a>Settings.chunk_overlap <span class="op">=</span> <span class="dv">200</span></span>
<span id="cb9-23"><a href="#cb9-23" aria-hidden="true" tabindex="-1"></a><span class="co"># --- 2. Ingestion and Indexing ---</span></span>
<span id="cb9-24"><a href="#cb9-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-25"><a href="#cb9-25" aria-hidden="true" tabindex="-1"></a><span class="co"># Load data</span></span>
<span id="cb9-26"><a href="#cb9-26" aria-hidden="true" tabindex="-1"></a>documents <span class="op">=</span> SimpleDirectoryReader(<span class="st">"markdown_docs"</span>).load_data()</span>
<span id="cb9-27"><a href="#cb9-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-28"><a href="#cb9-28" aria-hidden="true" tabindex="-1"></a><span class="co"># Initialize DuckDB Vector Store</span></span>
<span id="cb9-29"><a href="#cb9-29" aria-hidden="true" tabindex="-1"></a>vector_store <span class="op">=</span> DuckDBVectorStore(<span class="st">"open.duckdb"</span>, persist_dir<span class="op">=</span><span class="st">"./persist/"</span>)</span>
<span id="cb9-30"><a href="#cb9-30" aria-hidden="true" tabindex="-1"></a>storage_context <span class="op">=</span> StorageContext.from_defaults(vector_store<span class="op">=</span>vector_store)</span>
<span id="cb9-31"><a href="#cb9-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-32"><a href="#cb9-32" aria-hidden="true" tabindex="-1"></a><span class="co"># Create the index</span></span>
<span id="cb9-33"><a href="#cb9-33" aria-hidden="true" tabindex="-1"></a><span class="co"># This will now automatically use the Qwen embeddings defined in Settings</span></span>
<span id="cb9-34"><a href="#cb9-34" aria-hidden="true" tabindex="-1"></a>index <span class="op">=</span> VectorStoreIndex.from_documents(</span>
<span id="cb9-35"><a href="#cb9-35" aria-hidden="true" tabindex="-1"></a>    documents, </span>
<span id="cb9-36"><a href="#cb9-36" aria-hidden="true" tabindex="-1"></a>    storage_context<span class="op">=</span>storage_context</span>
<span id="cb9-37"><a href="#cb9-37" aria-hidden="true" tabindex="-1"></a>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
</div>
<div id="tabset-2-3" class="tab-pane" role="tabpanel" aria-labelledby="tabset-2-3-tab">
<p>To perform semantic search, we need to store our text data as vectors (embeddings). We’ll use <code>ChromaDB</code> as our local vector store. We also need an embedding model to convert text into vectors. Here, we configure a custom <code>OpenRouterEmbeddings</code> class to use the <code>qwen/qwen3-embedding-8b</code> model via the OpenRouter API.</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb10"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> openai <span class="im">import</span> OpenAI</span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> langchain_core.embeddings <span class="im">import</span> Embeddings</span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> langchain_chroma <span class="im">import</span> Chroma</span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> typing <span class="im">import</span> List</span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> os</span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> dotenv <span class="im">import</span> load_dotenv</span>
<span id="cb10-7"><a href="#cb10-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-8"><a href="#cb10-8" aria-hidden="true" tabindex="-1"></a>load_dotenv()</span>
<span id="cb10-9"><a href="#cb10-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-10"><a href="#cb10-10" aria-hidden="true" tabindex="-1"></a><span class="co"># Custom embeddings class for OpenRouter API</span></span>
<span id="cb10-11"><a href="#cb10-11" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> OpenRouterEmbeddings(Embeddings):</span>
<span id="cb10-12"><a href="#cb10-12" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Custom embeddings class for OpenRouter API."""</span></span>
<span id="cb10-13"><a href="#cb10-13" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb10-14"><a href="#cb10-14" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>, api_key: <span class="bu">str</span>, model: <span class="bu">str</span> <span class="op">=</span> <span class="st">"qwen/qwen3-embedding-8b"</span>):</span>
<span id="cb10-15"><a href="#cb10-15" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.client <span class="op">=</span> OpenAI(</span>
<span id="cb10-16"><a href="#cb10-16" aria-hidden="true" tabindex="-1"></a>            base_url<span class="op">=</span><span class="st">"https://openrouter.ai/api/v1"</span>,</span>
<span id="cb10-17"><a href="#cb10-17" aria-hidden="true" tabindex="-1"></a>            api_key<span class="op">=</span>api_key,</span>
<span id="cb10-18"><a href="#cb10-18" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb10-19"><a href="#cb10-19" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.model <span class="op">=</span> model</span>
<span id="cb10-20"><a href="#cb10-20" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb10-21"><a href="#cb10-21" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> embed_documents(<span class="va">self</span>, texts: List[<span class="bu">str</span>]) <span class="op">-&gt;</span> List[List[<span class="bu">float</span>]]:</span>
<span id="cb10-22"><a href="#cb10-22" aria-hidden="true" tabindex="-1"></a>        <span class="co">"""Embed a list of documents."""</span></span>
<span id="cb10-23"><a href="#cb10-23" aria-hidden="true" tabindex="-1"></a>        response <span class="op">=</span> <span class="va">self</span>.client.embeddings.create(</span>
<span id="cb10-24"><a href="#cb10-24" aria-hidden="true" tabindex="-1"></a>            extra_headers<span class="op">=</span>{</span>
<span id="cb10-25"><a href="#cb10-25" aria-hidden="true" tabindex="-1"></a>                <span class="st">"HTTP-Referer"</span>: <span class="st">"https://ai-blog.com"</span>,</span>
<span id="cb10-26"><a href="#cb10-26" aria-hidden="true" tabindex="-1"></a>                <span class="st">"X-Title"</span>: <span class="st">"AI Blog RAG"</span>,</span>
<span id="cb10-27"><a href="#cb10-27" aria-hidden="true" tabindex="-1"></a>            },</span>
<span id="cb10-28"><a href="#cb10-28" aria-hidden="true" tabindex="-1"></a>            model<span class="op">=</span><span class="va">self</span>.model,</span>
<span id="cb10-29"><a href="#cb10-29" aria-hidden="true" tabindex="-1"></a>            <span class="bu">input</span><span class="op">=</span>texts,</span>
<span id="cb10-30"><a href="#cb10-30" aria-hidden="true" tabindex="-1"></a>            encoding_format<span class="op">=</span><span class="st">"float"</span></span>
<span id="cb10-31"><a href="#cb10-31" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb10-32"><a href="#cb10-32" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> [item.embedding <span class="cf">for</span> item <span class="kw">in</span> response.data]</span>
<span id="cb10-33"><a href="#cb10-33" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb10-34"><a href="#cb10-34" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> embed_query(<span class="va">self</span>, text: <span class="bu">str</span>) <span class="op">-&gt;</span> List[<span class="bu">float</span>]:</span>
<span id="cb10-35"><a href="#cb10-35" aria-hidden="true" tabindex="-1"></a>        <span class="co">"""Embed a single query."""</span></span>
<span id="cb10-36"><a href="#cb10-36" aria-hidden="true" tabindex="-1"></a>        response <span class="op">=</span> <span class="va">self</span>.client.embeddings.create(</span>
<span id="cb10-37"><a href="#cb10-37" aria-hidden="true" tabindex="-1"></a>            extra_headers<span class="op">=</span>{</span>
<span id="cb10-38"><a href="#cb10-38" aria-hidden="true" tabindex="-1"></a>                <span class="st">"HTTP-Referer"</span>: <span class="st">"https://ai-blog.com"</span>,</span>
<span id="cb10-39"><a href="#cb10-39" aria-hidden="true" tabindex="-1"></a>                <span class="st">"X-Title"</span>: <span class="st">"AI Blog RAG"</span>,</span>
<span id="cb10-40"><a href="#cb10-40" aria-hidden="true" tabindex="-1"></a>            },</span>
<span id="cb10-41"><a href="#cb10-41" aria-hidden="true" tabindex="-1"></a>            model<span class="op">=</span><span class="va">self</span>.model,</span>
<span id="cb10-42"><a href="#cb10-42" aria-hidden="true" tabindex="-1"></a>            <span class="bu">input</span><span class="op">=</span>text,</span>
<span id="cb10-43"><a href="#cb10-43" aria-hidden="true" tabindex="-1"></a>            encoding_format<span class="op">=</span><span class="st">"float"</span></span>
<span id="cb10-44"><a href="#cb10-44" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb10-45"><a href="#cb10-45" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> response.data[<span class="dv">0</span>].embedding</span>
<span id="cb10-46"><a href="#cb10-46" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-47"><a href="#cb10-47" aria-hidden="true" tabindex="-1"></a><span class="co"># Get OpenRouter API key</span></span>
<span id="cb10-48"><a href="#cb10-48" aria-hidden="true" tabindex="-1"></a>openrouter_api_key <span class="op">=</span> os.getenv(<span class="st">"OPENROUTER_API_KEY"</span>)</span>
<span id="cb10-49"><a href="#cb10-49" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> <span class="kw">not</span> openrouter_api_key:</span>
<span id="cb10-50"><a href="#cb10-50" aria-hidden="true" tabindex="-1"></a>    <span class="cf">raise</span> <span class="pp">ValueError</span>(<span class="st">"OPENROUTER_API_KEY not found in environment variables"</span>)</span>
<span id="cb10-51"><a href="#cb10-51" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-52"><a href="#cb10-52" aria-hidden="true" tabindex="-1"></a><span class="co"># Create embeddings instance using OpenRouter</span></span>
<span id="cb10-53"><a href="#cb10-53" aria-hidden="true" tabindex="-1"></a>embeddings <span class="op">=</span> OpenRouterEmbeddings(</span>
<span id="cb10-54"><a href="#cb10-54" aria-hidden="true" tabindex="-1"></a>    api_key<span class="op">=</span>openrouter_api_key,</span>
<span id="cb10-55"><a href="#cb10-55" aria-hidden="true" tabindex="-1"></a>    model<span class="op">=</span><span class="st">"qwen/qwen3-embedding-8b"</span></span>
<span id="cb10-56"><a href="#cb10-56" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb10-57"><a href="#cb10-57" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-58"><a href="#cb10-58" aria-hidden="true" tabindex="-1"></a><span class="co"># Define vector store location</span></span>
<span id="cb10-59"><a href="#cb10-59" aria-hidden="true" tabindex="-1"></a>persist_directory <span class="op">=</span> <span class="st">"chroma_db_data"</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<p>With our store initialized, we can now ingest the data. We iterate through the markdown files we saved earlier. For each file, we: 1. Load the content. 2. Split the content into smaller chunks (approx. 2000 characters) using <code>RecursiveCharacterTextSplitter</code>. 3. Create a new <code>Chroma</code> vector store from these chunks.</p>
<p>This process builds the index that we’ll search against.</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb11"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> langchain_core.documents <span class="im">import</span> Document</span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> langchain_text_splitters <span class="im">import</span> RecursiveCharacterTextSplitter</span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> shutil</span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Helper function to load markdown files</span></span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> load_markdown_files(directory: <span class="bu">str</span>) <span class="op">-&gt;</span> <span class="bu">list</span>[Document]:</span>
<span id="cb11-7"><a href="#cb11-7" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Load all markdown files from directory and create Document objects."""</span></span>
<span id="cb11-8"><a href="#cb11-8" aria-hidden="true" tabindex="-1"></a>    documents <span class="op">=</span> []</span>
<span id="cb11-9"><a href="#cb11-9" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="kw">not</span> os.path.exists(directory):</span>
<span id="cb11-10"><a href="#cb11-10" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> documents</span>
<span id="cb11-11"><a href="#cb11-11" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb11-12"><a href="#cb11-12" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> filename <span class="kw">in</span> os.listdir(directory):</span>
<span id="cb11-13"><a href="#cb11-13" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> filename.endswith(<span class="st">'.md'</span>):</span>
<span id="cb11-14"><a href="#cb11-14" aria-hidden="true" tabindex="-1"></a>            filepath <span class="op">=</span> os.path.join(directory, filename)</span>
<span id="cb11-15"><a href="#cb11-15" aria-hidden="true" tabindex="-1"></a>            <span class="cf">with</span> <span class="bu">open</span>(filepath, <span class="st">'r'</span>, encoding<span class="op">=</span><span class="st">'utf-8'</span>) <span class="im">as</span> f:</span>
<span id="cb11-16"><a href="#cb11-16" aria-hidden="true" tabindex="-1"></a>                content <span class="op">=</span> f.read()</span>
<span id="cb11-17"><a href="#cb11-17" aria-hidden="true" tabindex="-1"></a>                doc <span class="op">=</span> Document(</span>
<span id="cb11-18"><a href="#cb11-18" aria-hidden="true" tabindex="-1"></a>                    page_content<span class="op">=</span>content,</span>
<span id="cb11-19"><a href="#cb11-19" aria-hidden="true" tabindex="-1"></a>                    metadata<span class="op">=</span>{</span>
<span id="cb11-20"><a href="#cb11-20" aria-hidden="true" tabindex="-1"></a>                        <span class="st">"source"</span>: filename,</span>
<span id="cb11-21"><a href="#cb11-21" aria-hidden="true" tabindex="-1"></a>                        <span class="st">"filepath"</span>: filepath</span>
<span id="cb11-22"><a href="#cb11-22" aria-hidden="true" tabindex="-1"></a>                    }</span>
<span id="cb11-23"><a href="#cb11-23" aria-hidden="true" tabindex="-1"></a>                )</span>
<span id="cb11-24"><a href="#cb11-24" aria-hidden="true" tabindex="-1"></a>                documents.append(doc)</span>
<span id="cb11-25"><a href="#cb11-25" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> documents</span>
<span id="cb11-26"><a href="#cb11-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-27"><a href="#cb11-27" aria-hidden="true" tabindex="-1"></a><span class="co"># Create output directory for markdown files</span></span>
<span id="cb11-28"><a href="#cb11-28" aria-hidden="true" tabindex="-1"></a>output_dir <span class="op">=</span> <span class="st">"markdown_docs"</span></span>
<span id="cb11-29"><a href="#cb11-29" aria-hidden="true" tabindex="-1"></a>os.makedirs(output_dir, exist_ok<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb11-30"><a href="#cb11-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-31"><a href="#cb11-31" aria-hidden="true" tabindex="-1"></a><span class="co"># Convert each URL to markdown and save</span></span>
<span id="cb11-32"><a href="#cb11-32" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> i, link_url <span class="kw">in</span> <span class="bu">enumerate</span>(links_full, <span class="dv">1</span>):</span>
<span id="cb11-33"><a href="#cb11-33" aria-hidden="true" tabindex="-1"></a>    <span class="cf">try</span>:</span>
<span id="cb11-34"><a href="#cb11-34" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"Processing </span><span class="sc">{</span>i<span class="sc">}</span><span class="ss">/</span><span class="sc">{</span><span class="bu">len</span>(links_full)<span class="sc">}</span><span class="ss">: </span><span class="sc">{</span>link_url<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb11-35"><a href="#cb11-35" aria-hidden="true" tabindex="-1"></a>        html_content <span class="op">=</span> fetch_html(link_url)</span>
<span id="cb11-36"><a href="#cb11-36" aria-hidden="true" tabindex="-1"></a>        markdown_content <span class="op">=</span> html_to_markdown(html_content)</span>
<span id="cb11-37"><a href="#cb11-37" aria-hidden="true" tabindex="-1"></a>        filename <span class="op">=</span> sanitize_filename(link_url)</span>
<span id="cb11-38"><a href="#cb11-38" aria-hidden="true" tabindex="-1"></a>        output_path <span class="op">=</span> os.path.join(output_dir, filename)</span>
<span id="cb11-39"><a href="#cb11-39" aria-hidden="true" tabindex="-1"></a>        save_markdown(markdown_content, output_path)</span>
<span id="cb11-40"><a href="#cb11-40" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"  ✓ Saved to </span><span class="sc">{</span>output_path<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb11-41"><a href="#cb11-41" aria-hidden="true" tabindex="-1"></a>    <span class="cf">except</span> <span class="pp">Exception</span> <span class="im">as</span> e:</span>
<span id="cb11-42"><a href="#cb11-42" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"  ✗ Error processing </span><span class="sc">{</span>link_url<span class="sc">}</span><span class="ss">: </span><span class="sc">{</span><span class="bu">str</span>(e)<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb11-43"><a href="#cb11-43" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-44"><a href="#cb11-44" aria-hidden="true" tabindex="-1"></a><span class="co"># Load markdown documents</span></span>
<span id="cb11-45"><a href="#cb11-45" aria-hidden="true" tabindex="-1"></a>documents <span class="op">=</span> load_markdown_files(output_dir)</span>
<span id="cb11-46"><a href="#cb11-46" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">Loaded </span><span class="sc">{</span><span class="bu">len</span>(documents)<span class="sc">}</span><span class="ss"> markdown documents"</span>)</span>
<span id="cb11-47"><a href="#cb11-47" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-48"><a href="#cb11-48" aria-hidden="true" tabindex="-1"></a><span class="co"># Split documents into chunks</span></span>
<span id="cb11-49"><a href="#cb11-49" aria-hidden="true" tabindex="-1"></a>text_splitter <span class="op">=</span> RecursiveCharacterTextSplitter(</span>
<span id="cb11-50"><a href="#cb11-50" aria-hidden="true" tabindex="-1"></a>    chunk_size<span class="op">=</span><span class="dv">2000</span>,</span>
<span id="cb11-51"><a href="#cb11-51" aria-hidden="true" tabindex="-1"></a>    chunk_overlap<span class="op">=</span><span class="dv">200</span>,</span>
<span id="cb11-52"><a href="#cb11-52" aria-hidden="true" tabindex="-1"></a>    length_function<span class="op">=</span><span class="bu">len</span>,</span>
<span id="cb11-53"><a href="#cb11-53" aria-hidden="true" tabindex="-1"></a>    is_separator_regex<span class="op">=</span><span class="va">False</span>,</span>
<span id="cb11-54"><a href="#cb11-54" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb11-55"><a href="#cb11-55" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-56"><a href="#cb11-56" aria-hidden="true" tabindex="-1"></a>splits <span class="op">=</span> text_splitter.split_documents(documents)</span>
<span id="cb11-57"><a href="#cb11-57" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Split into </span><span class="sc">{</span><span class="bu">len</span>(splits)<span class="sc">}</span><span class="ss"> chunks"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb12"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Remove existing database if it exists</span></span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> os.path.exists(persist_directory):</span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"Removing existing database at </span><span class="sc">{</span>persist_directory<span class="sc">}</span><span class="ss">..."</span>)</span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a>    shutil.rmtree(persist_directory)</span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Create new vector store</span></span>
<span id="cb12-7"><a href="#cb12-7" aria-hidden="true" tabindex="-1"></a>vectorstore <span class="op">=</span> Chroma.from_documents(</span>
<span id="cb12-8"><a href="#cb12-8" aria-hidden="true" tabindex="-1"></a>    documents<span class="op">=</span>splits,</span>
<span id="cb12-9"><a href="#cb12-9" aria-hidden="true" tabindex="-1"></a>    embedding<span class="op">=</span>embeddings,</span>
<span id="cb12-10"><a href="#cb12-10" aria-hidden="true" tabindex="-1"></a>    persist_directory<span class="op">=</span>persist_directory</span>
<span id="cb12-11"><a href="#cb12-11" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb12-12"><a href="#cb12-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-13"><a href="#cb12-13" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">✓ Successfully created ChromaDB with </span><span class="sc">{</span><span class="bu">len</span>(splits)<span class="sc">}</span><span class="ss"> chunks!"</span>)</span>
<span id="cb12-14"><a href="#cb12-14" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"✓ Database saved to: </span><span class="sc">{</span>persist_directory<span class="sc">}</span><span class="ss">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
</div>
</div>
</div>
</section>
<section id="retrieval" class="level1">
<h1>Retrieval</h1>
<div class="tabset-margin-container"></div><div class="panel-tabset">
<ul class="nav nav-tabs" role="tablist"><li class="nav-item" role="presentation"><a class="nav-link active" id="tabset-3-1-tab" data-bs-toggle="tab" data-bs-target="#tabset-3-1" role="tab" aria-controls="tabset-3-1" aria-selected="true" href="">R</a></li><li class="nav-item" role="presentation"><a class="nav-link" id="tabset-3-2-tab" data-bs-toggle="tab" data-bs-target="#tabset-3-2" role="tab" aria-controls="tabset-3-2" aria-selected="false" href="">Python DuckDB</a></li><li class="nav-item" role="presentation"><a class="nav-link" id="tabset-3-3-tab" data-bs-toggle="tab" data-bs-target="#tabset-3-3" role="tab" aria-controls="tabset-3-3" aria-selected="false" href="">Python Chroma</a></li></ul>
<div class="tab-content">
<div id="tabset-3-1" class="tab-pane active" role="tabpanel" aria-labelledby="tabset-3-1-tab">
<p>Now that our knowledge base is populated, we can test the retrieval system. We can ask a specific question, like “What are model variants?”, and query the store to see which text chunks are most relevant. This confirms that our embeddings and search are working correctly.</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb13"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a>store_location <span class="ot">&lt;-</span> <span class="st">"openrouter.duckdb"</span></span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a>store <span class="ot">&lt;-</span> <span class="fu">ragnar_store_connect</span>(store_location)</span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a>text <span class="ot">&lt;-</span> <span class="st">"What are model variants?"</span></span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-6"><a href="#cb13-6" aria-hidden="true" tabindex="-1"></a><span class="co">#' # Retrieving Chunks</span></span>
<span id="cb13-7"><a href="#cb13-7" aria-hidden="true" tabindex="-1"></a><span class="co">#' Once the store is set up, retrieve the most relevant text chunks like this</span></span>
<span id="cb13-8"><a href="#cb13-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-9"><a href="#cb13-9" aria-hidden="true" tabindex="-1"></a>relevant_chunks <span class="ot">&lt;-</span> <span class="fu">ragnar_retrieve</span>(store, text, <span class="at">top_k =</span> <span class="dv">3</span>)</span>
<span id="cb13-10"><a href="#cb13-10" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Retrieved"</span>, <span class="fu">nrow</span>(relevant_chunks), <span class="st">"chunks:</span><span class="sc">\n\n</span><span class="st">"</span>)</span>
<span id="cb13-11"><a href="#cb13-11" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (i <span class="cf">in</span> <span class="fu">seq_len</span>(<span class="fu">nrow</span>(relevant_chunks))) {</span>
<span id="cb13-12"><a href="#cb13-12" aria-hidden="true" tabindex="-1"></a>    <span class="fu">cat</span>(<span class="fu">sprintf</span>(<span class="st">"--- Chunk %d ---</span><span class="sc">\n</span><span class="st">%s</span><span class="sc">\n\n</span><span class="st">"</span>, i, relevant_chunks<span class="sc">$</span>text[i]))</span>
<span id="cb13-13"><a href="#cb13-13" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb14"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="co"># ragnar_store_inspect(store)</span></span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a><span class="co">#ragnar_chunks_view(chunks)</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
</div>
<div id="tabset-3-2" class="tab-pane" role="tabpanel" aria-labelledby="tabset-3-2-tab">
<p>In Python, we can use <code>LlamaIndex</code> to interact with our DuckDB vector store. In this step, we’ll configure the embedding model and retrieve the top relevant chunks for our query, saving them to a file for inspection. We won’t use an LLM for generation yet, focusing solely on verifying the retrieval quality.</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb15"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> os</span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> llama_index.core <span class="im">import</span> VectorStoreIndex, Settings</span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> llama_index.vector_stores.duckdb <span class="im">import</span> DuckDBVectorStore</span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> llama_index.embeddings.openai <span class="im">import</span> OpenAIEmbedding</span>
<span id="cb15-5"><a href="#cb15-5" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> dotenv <span class="im">import</span> load_dotenv</span>
<span id="cb15-6"><a href="#cb15-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-7"><a href="#cb15-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Load environment variables</span></span>
<span id="cb15-8"><a href="#cb15-8" aria-hidden="true" tabindex="-1"></a>load_dotenv()</span>
<span id="cb15-9"><a href="#cb15-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-10"><a href="#cb15-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-11"><a href="#cb15-11" aria-hidden="true" tabindex="-1"></a><span class="co"># Ensure your API key is available</span></span>
<span id="cb15-12"><a href="#cb15-12" aria-hidden="true" tabindex="-1"></a>openrouter_api_key <span class="op">=</span> os.getenv(<span class="st">"OPENROUTER_API_KEY"</span>)</span>
<span id="cb15-13"><a href="#cb15-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-14"><a href="#cb15-14" aria-hidden="true" tabindex="-1"></a><span class="co"># 1. Configure Embedding Model</span></span>
<span id="cb15-15"><a href="#cb15-15" aria-hidden="true" tabindex="-1"></a>embed_model <span class="op">=</span> OpenAIEmbedding(</span>
<span id="cb15-16"><a href="#cb15-16" aria-hidden="true" tabindex="-1"></a>    api_key<span class="op">=</span>openrouter_api_key,</span>
<span id="cb15-17"><a href="#cb15-17" aria-hidden="true" tabindex="-1"></a>    api_base<span class="op">=</span><span class="st">"https://openrouter.ai/api/v1"</span>,</span>
<span id="cb15-18"><a href="#cb15-18" aria-hidden="true" tabindex="-1"></a>    model_name<span class="op">=</span><span class="st">"qwen/qwen3-embedding-8b"</span></span>
<span id="cb15-19"><a href="#cb15-19" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb15-20"><a href="#cb15-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-21"><a href="#cb15-21" aria-hidden="true" tabindex="-1"></a><span class="co"># 2. Apply Settings</span></span>
<span id="cb15-22"><a href="#cb15-22" aria-hidden="true" tabindex="-1"></a>Settings.embed_model <span class="op">=</span> embed_model</span>
<span id="cb15-23"><a href="#cb15-23" aria-hidden="true" tabindex="-1"></a><span class="co">#Settings.llm = None # Disable LLM</span></span>
<span id="cb15-24"><a href="#cb15-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-25"><a href="#cb15-25" aria-hidden="true" tabindex="-1"></a><span class="co"># 3. Load and Retrieve</span></span>
<span id="cb15-26"><a href="#cb15-26" aria-hidden="true" tabindex="-1"></a><span class="co"># Load the existing DuckDB vector store</span></span>
<span id="cb15-27"><a href="#cb15-27" aria-hidden="true" tabindex="-1"></a>vector_store <span class="op">=</span> DuckDBVectorStore(database_name<span class="op">=</span><span class="st">"open.duckdb"</span>, persist_dir<span class="op">=</span><span class="st">"./persist/"</span>)</span>
<span id="cb15-28"><a href="#cb15-28" aria-hidden="true" tabindex="-1"></a>index <span class="op">=</span> VectorStoreIndex.from_vector_store(vector_store<span class="op">=</span>vector_store)</span>
<span id="cb15-29"><a href="#cb15-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-30"><a href="#cb15-30" aria-hidden="true" tabindex="-1"></a><span class="co"># Retrieve top 3 chunks</span></span>
<span id="cb15-31"><a href="#cb15-31" aria-hidden="true" tabindex="-1"></a>retriever <span class="op">=</span> index.as_retriever(similarity_top_k<span class="op">=</span><span class="dv">3</span>)</span>
<span id="cb15-32"><a href="#cb15-32" aria-hidden="true" tabindex="-1"></a>nodes <span class="op">=</span> retriever.retrieve(<span class="st">"What are model variants?"</span>)</span>
<span id="cb15-33"><a href="#cb15-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-34"><a href="#cb15-34" aria-hidden="true" tabindex="-1"></a><span class="co"># Save retrieved chunks to a markdown file for easy inspection</span></span>
<span id="cb15-35"><a href="#cb15-35" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> <span class="bu">open</span>(<span class="st">"retriever.md"</span>, <span class="st">"w"</span>, encoding<span class="op">=</span><span class="st">"utf-8"</span>) <span class="im">as</span> f:</span>
<span id="cb15-36"><a href="#cb15-36" aria-hidden="true" tabindex="-1"></a>    f.write(<span class="ss">f"# Retrieved </span><span class="sc">{</span><span class="bu">len</span>(nodes)<span class="sc">}</span><span class="ss"> chunks</span><span class="ch">\n\n</span><span class="ss">"</span>)</span>
<span id="cb15-37"><a href="#cb15-37" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> i, node <span class="kw">in</span> <span class="bu">enumerate</span>(nodes, <span class="dv">1</span>):</span>
<span id="cb15-38"><a href="#cb15-38" aria-hidden="true" tabindex="-1"></a>        content <span class="op">=</span> <span class="ss">f"## Chunk </span><span class="sc">{</span>i<span class="sc">}</span><span class="ch">\n\n</span><span class="sc">{</span>node<span class="sc">.</span>text<span class="sc">}</span><span class="ch">\n\n</span><span class="ss">"</span></span>
<span id="cb15-39"><a href="#cb15-39" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(content)</span>
<span id="cb15-40"><a href="#cb15-40" aria-hidden="true" tabindex="-1"></a>        f.write(content)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
</div>
<div id="tabset-3-3" class="tab-pane" role="tabpanel" aria-labelledby="tabset-3-3-tab">
<p>Now that our knowledge base is populated, we can test the retrieval system. We can ask a specific question, like “What are model variants?”, and query the <code>Chroma</code> store to see which text chunks are most relevant. This confirms that our embeddings and search are working correctly.</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb16"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> openai <span class="im">import</span> OpenAI</span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> langchain_core.embeddings <span class="im">import</span> Embeddings</span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> langchain_chroma <span class="im">import</span> Chroma</span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> typing <span class="im">import</span> List</span>
<span id="cb16-5"><a href="#cb16-5" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> os</span>
<span id="cb16-6"><a href="#cb16-6" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> dotenv <span class="im">import</span> load_dotenv</span>
<span id="cb16-7"><a href="#cb16-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-8"><a href="#cb16-8" aria-hidden="true" tabindex="-1"></a>load_dotenv()</span>
<span id="cb16-9"><a href="#cb16-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-10"><a href="#cb16-10" aria-hidden="true" tabindex="-1"></a><span class="co"># Custom embeddings class for OpenRouter API</span></span>
<span id="cb16-11"><a href="#cb16-11" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> OpenRouterEmbeddings(Embeddings):</span>
<span id="cb16-12"><a href="#cb16-12" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Custom embeddings class for OpenRouter API."""</span></span>
<span id="cb16-13"><a href="#cb16-13" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb16-14"><a href="#cb16-14" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>, api_key: <span class="bu">str</span>, model: <span class="bu">str</span> <span class="op">=</span> <span class="st">"qwen/qwen3-embedding-8b"</span>):</span>
<span id="cb16-15"><a href="#cb16-15" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.client <span class="op">=</span> OpenAI(</span>
<span id="cb16-16"><a href="#cb16-16" aria-hidden="true" tabindex="-1"></a>            base_url<span class="op">=</span><span class="st">"https://openrouter.ai/api/v1"</span>,</span>
<span id="cb16-17"><a href="#cb16-17" aria-hidden="true" tabindex="-1"></a>            api_key<span class="op">=</span>api_key,</span>
<span id="cb16-18"><a href="#cb16-18" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb16-19"><a href="#cb16-19" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.model <span class="op">=</span> model</span>
<span id="cb16-20"><a href="#cb16-20" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb16-21"><a href="#cb16-21" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> embed_documents(<span class="va">self</span>, texts: List[<span class="bu">str</span>]) <span class="op">-&gt;</span> List[List[<span class="bu">float</span>]]:</span>
<span id="cb16-22"><a href="#cb16-22" aria-hidden="true" tabindex="-1"></a>        <span class="co">"""Embed a list of documents."""</span></span>
<span id="cb16-23"><a href="#cb16-23" aria-hidden="true" tabindex="-1"></a>        response <span class="op">=</span> <span class="va">self</span>.client.embeddings.create(</span>
<span id="cb16-24"><a href="#cb16-24" aria-hidden="true" tabindex="-1"></a>            extra_headers<span class="op">=</span>{</span>
<span id="cb16-25"><a href="#cb16-25" aria-hidden="true" tabindex="-1"></a>                <span class="st">"HTTP-Referer"</span>: <span class="st">"https://ai-blog.com"</span>,</span>
<span id="cb16-26"><a href="#cb16-26" aria-hidden="true" tabindex="-1"></a>                <span class="st">"X-Title"</span>: <span class="st">"AI Blog RAG"</span>,</span>
<span id="cb16-27"><a href="#cb16-27" aria-hidden="true" tabindex="-1"></a>            },</span>
<span id="cb16-28"><a href="#cb16-28" aria-hidden="true" tabindex="-1"></a>            model<span class="op">=</span><span class="va">self</span>.model,</span>
<span id="cb16-29"><a href="#cb16-29" aria-hidden="true" tabindex="-1"></a>            <span class="bu">input</span><span class="op">=</span>texts,</span>
<span id="cb16-30"><a href="#cb16-30" aria-hidden="true" tabindex="-1"></a>            encoding_format<span class="op">=</span><span class="st">"float"</span></span>
<span id="cb16-31"><a href="#cb16-31" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb16-32"><a href="#cb16-32" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> [item.embedding <span class="cf">for</span> item <span class="kw">in</span> response.data]</span>
<span id="cb16-33"><a href="#cb16-33" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb16-34"><a href="#cb16-34" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> embed_query(<span class="va">self</span>, text: <span class="bu">str</span>) <span class="op">-&gt;</span> List[<span class="bu">float</span>]:</span>
<span id="cb16-35"><a href="#cb16-35" aria-hidden="true" tabindex="-1"></a>        <span class="co">"""Embed a single query."""</span></span>
<span id="cb16-36"><a href="#cb16-36" aria-hidden="true" tabindex="-1"></a>        response <span class="op">=</span> <span class="va">self</span>.client.embeddings.create(</span>
<span id="cb16-37"><a href="#cb16-37" aria-hidden="true" tabindex="-1"></a>            extra_headers<span class="op">=</span>{</span>
<span id="cb16-38"><a href="#cb16-38" aria-hidden="true" tabindex="-1"></a>                <span class="st">"HTTP-Referer"</span>: <span class="st">"https://ai-blog.com"</span>,</span>
<span id="cb16-39"><a href="#cb16-39" aria-hidden="true" tabindex="-1"></a>                <span class="st">"X-Title"</span>: <span class="st">"AI Blog RAG"</span>,</span>
<span id="cb16-40"><a href="#cb16-40" aria-hidden="true" tabindex="-1"></a>            },</span>
<span id="cb16-41"><a href="#cb16-41" aria-hidden="true" tabindex="-1"></a>            model<span class="op">=</span><span class="va">self</span>.model,</span>
<span id="cb16-42"><a href="#cb16-42" aria-hidden="true" tabindex="-1"></a>            <span class="bu">input</span><span class="op">=</span>text,</span>
<span id="cb16-43"><a href="#cb16-43" aria-hidden="true" tabindex="-1"></a>            encoding_format<span class="op">=</span><span class="st">"float"</span></span>
<span id="cb16-44"><a href="#cb16-44" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb16-45"><a href="#cb16-45" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> response.data[<span class="dv">0</span>].embedding</span>
<span id="cb16-46"><a href="#cb16-46" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-47"><a href="#cb16-47" aria-hidden="true" tabindex="-1"></a><span class="co"># Get OpenRouter API key</span></span>
<span id="cb16-48"><a href="#cb16-48" aria-hidden="true" tabindex="-1"></a>openrouter_api_key <span class="op">=</span> os.getenv(<span class="st">"OPENROUTER_API_KEY"</span>)</span>
<span id="cb16-49"><a href="#cb16-49" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> <span class="kw">not</span> openrouter_api_key:</span>
<span id="cb16-50"><a href="#cb16-50" aria-hidden="true" tabindex="-1"></a>    <span class="cf">raise</span> <span class="pp">ValueError</span>(<span class="st">"OPENROUTER_API_KEY not found in environment variables"</span>)</span>
<span id="cb16-51"><a href="#cb16-51" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-52"><a href="#cb16-52" aria-hidden="true" tabindex="-1"></a><span class="co"># Create embeddings instance using OpenRouter</span></span>
<span id="cb16-53"><a href="#cb16-53" aria-hidden="true" tabindex="-1"></a>embeddings <span class="op">=</span> OpenRouterEmbeddings(</span>
<span id="cb16-54"><a href="#cb16-54" aria-hidden="true" tabindex="-1"></a>    api_key<span class="op">=</span>openrouter_api_key,</span>
<span id="cb16-55"><a href="#cb16-55" aria-hidden="true" tabindex="-1"></a>    model<span class="op">=</span><span class="st">"qwen/qwen3-embedding-8b"</span></span>
<span id="cb16-56"><a href="#cb16-56" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb16-57"><a href="#cb16-57" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-58"><a href="#cb16-58" aria-hidden="true" tabindex="-1"></a><span class="co"># Define vector store location</span></span>
<span id="cb16-59"><a href="#cb16-59" aria-hidden="true" tabindex="-1"></a>persist_directory <span class="op">=</span> <span class="st">"chroma_db_data"</span></span>
<span id="cb16-60"><a href="#cb16-60" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-61"><a href="#cb16-61" aria-hidden="true" tabindex="-1"></a><span class="co"># Load existing vector store</span></span>
<span id="cb16-62"><a href="#cb16-62" aria-hidden="true" tabindex="-1"></a>vectorstore <span class="op">=</span> Chroma(</span>
<span id="cb16-63"><a href="#cb16-63" aria-hidden="true" tabindex="-1"></a>    persist_directory<span class="op">=</span>persist_directory,</span>
<span id="cb16-64"><a href="#cb16-64" aria-hidden="true" tabindex="-1"></a>    embedding_function<span class="op">=</span>embeddings</span>
<span id="cb16-65"><a href="#cb16-65" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb16-66"><a href="#cb16-66" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-67"><a href="#cb16-67" aria-hidden="true" tabindex="-1"></a><span class="co"># Test query</span></span>
<span id="cb16-68"><a href="#cb16-68" aria-hidden="true" tabindex="-1"></a>query <span class="op">=</span> <span class="st">"What are model variants?"</span></span>
<span id="cb16-69"><a href="#cb16-69" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-70"><a href="#cb16-70" aria-hidden="true" tabindex="-1"></a><span class="co"># Perform similarity search</span></span>
<span id="cb16-71"><a href="#cb16-71" aria-hidden="true" tabindex="-1"></a>results <span class="op">=</span> vectorstore.similarity_search(query, k<span class="op">=</span><span class="dv">5</span>)</span>
<span id="cb16-72"><a href="#cb16-72" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-73"><a href="#cb16-73" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">Query: '</span><span class="sc">{</span>query<span class="sc">}</span><span class="ss">'"</span>)</span>
<span id="cb16-74"><a href="#cb16-74" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Found </span><span class="sc">{</span><span class="bu">len</span>(results)<span class="sc">}</span><span class="ss"> relevant chunks:</span><span class="ch">\n</span><span class="ss">"</span>)</span>
<span id="cb16-75"><a href="#cb16-75" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-76"><a href="#cb16-76" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> i, doc <span class="kw">in</span> <span class="bu">enumerate</span>(results, <span class="dv">1</span>):</span>
<span id="cb16-77"><a href="#cb16-77" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"Result </span><span class="sc">{</span>i<span class="sc">}</span><span class="ss">:"</span>)</span>
<span id="cb16-78"><a href="#cb16-78" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"Source: </span><span class="sc">{</span>doc<span class="sc">.</span>metadata<span class="sc">.</span>get(<span class="st">'source'</span>, <span class="st">'unknown'</span>)<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb16-79"><a href="#cb16-79" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"Content preview: </span><span class="sc">{</span>doc<span class="sc">.</span>page_content[:<span class="dv">800</span>]<span class="sc">}</span><span class="ss">..."</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
</div>
</div>
</div>
</section>
<section id="chat-with-rag" class="level1">
<h1>Chat with RAG</h1>
<div class="tabset-margin-container"></div><div class="panel-tabset">
<ul class="nav nav-tabs" role="tablist"><li class="nav-item" role="presentation"><a class="nav-link active" id="tabset-4-1-tab" data-bs-toggle="tab" data-bs-target="#tabset-4-1" role="tab" aria-controls="tabset-4-1" aria-selected="true" href="">R</a></li><li class="nav-item" role="presentation"><a class="nav-link" id="tabset-4-2-tab" data-bs-toggle="tab" data-bs-target="#tabset-4-2" role="tab" aria-controls="tabset-4-2" aria-selected="false" href="">Python chatlas</a></li><li class="nav-item" role="presentation"><a class="nav-link" id="tabset-4-3-tab" data-bs-toggle="tab" data-bs-target="#tabset-4-3" role="tab" aria-controls="tabset-4-3" aria-selected="false" href="">Python LangChain</a></li></ul>
<div class="tab-content">
<div id="tabset-4-1" class="tab-pane active" role="tabpanel" aria-labelledby="tabset-4-1-tab">
<p>The final piece is to connect this retrieval capability to a chat interface. We use <code>ellmer</code> to create a chat client. Crucially, we register a “retrieval tool” using <code>ragnar_register_tool_retrieve</code>. This gives the LLM the ability to query our vector store whenever it needs information to answer a user’s question.</p>
<p>We also provide a system prompt that instructs the model to always check the knowledge base and cite its sources.</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb17"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ellmer)</span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(dotenv)</span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a><span class="fu">load_dot_env</span>(<span class="at">file =</span> <span class="st">".env"</span>)</span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-5"><a href="#cb17-5" aria-hidden="true" tabindex="-1"></a>chat <span class="ot">&lt;-</span> <span class="fu">chat_openrouter</span>(</span>
<span id="cb17-6"><a href="#cb17-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">api_key =</span> <span class="fu">Sys.getenv</span>(<span class="st">"OPENROUTER_API_KEY"</span>),</span>
<span id="cb17-7"><a href="#cb17-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">model =</span> <span class="st">"openai/gpt-oss-120b"</span>,</span>
<span id="cb17-8"><a href="#cb17-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">system_prompt =</span> glue<span class="sc">::</span><span class="fu">trim</span>(<span class="st">"</span></span>
<span id="cb17-9"><a href="#cb17-9" aria-hidden="true" tabindex="-1"></a><span class="st">  You are an assistant for question-answering tasks. You are concise.</span></span>
<span id="cb17-10"><a href="#cb17-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-11"><a href="#cb17-11" aria-hidden="true" tabindex="-1"></a><span class="st">  Before responding, retrieve relevant material from the knowledge store. Quote or</span></span>
<span id="cb17-12"><a href="#cb17-12" aria-hidden="true" tabindex="-1"></a><span class="st">  paraphrase passages, clearly marking your own words versus the source. Provide a</span></span>
<span id="cb17-13"><a href="#cb17-13" aria-hidden="true" tabindex="-1"></a><span class="st">  working link for every source cited, as well as any additional relevant links.</span></span>
<span id="cb17-14"><a href="#cb17-14" aria-hidden="true" tabindex="-1"></a><span class="st">  Do not answer unless you have retrieved and cited a source.If you do not find</span></span>
<span id="cb17-15"><a href="#cb17-15" aria-hidden="true" tabindex="-1"></a><span class="st">  relevant information, say 'I could not find anything relevant in the knowledge base</span></span>
<span id="cb17-16"><a href="#cb17-16" aria-hidden="true" tabindex="-1"></a><span class="st">    "</span>)</span>
<span id="cb17-17"><a href="#cb17-17" aria-hidden="true" tabindex="-1"></a>) <span class="sc">|&gt;</span></span>
<span id="cb17-18"><a href="#cb17-18" aria-hidden="true" tabindex="-1"></a>    <span class="fu">ragnar_register_tool_retrieve</span>(store, <span class="at">top_k =</span> <span class="dv">3</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb18"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a>chat<span class="sc">$</span><span class="fu">chat</span>(<span class="st">"What are model variants?"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div id="tabset-4-2" class="tab-pane" role="tabpanel" aria-labelledby="tabset-4-2-tab">
<p>We can also use the <code>chatlas</code> library to create a chat interface. Here, we define a custom tool <code>retrieve_trusted_content</code> that queries our DuckDB index. We then register this tool with the chat model, allowing it to pull in relevant information when answering user questions.</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb19"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> os</span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> chatlas <span class="im">as</span> ctl</span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> llama_index.core <span class="im">import</span> VectorStoreIndex, Settings</span>
<span id="cb19-4"><a href="#cb19-4" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> llama_index.vector_stores.duckdb <span class="im">import</span> DuckDBVectorStore</span>
<span id="cb19-5"><a href="#cb19-5" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> llama_index.embeddings.openai <span class="im">import</span> OpenAIEmbedding</span>
<span id="cb19-6"><a href="#cb19-6" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> dotenv <span class="im">import</span> load_dotenv</span>
<span id="cb19-7"><a href="#cb19-7" aria-hidden="true" tabindex="-1"></a>load_dotenv()</span>
<span id="cb19-8"><a href="#cb19-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Ensure API key</span></span>
<span id="cb19-9"><a href="#cb19-9" aria-hidden="true" tabindex="-1"></a>openrouter_api_key <span class="op">=</span> os.getenv(<span class="st">"OPENROUTER_API_KEY"</span>)</span>
<span id="cb19-10"><a href="#cb19-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-11"><a href="#cb19-11" aria-hidden="true" tabindex="-1"></a><span class="co"># 1. Configure Embedding Model (LlamaIndex)</span></span>
<span id="cb19-12"><a href="#cb19-12" aria-hidden="true" tabindex="-1"></a>embed_model <span class="op">=</span> OpenAIEmbedding(</span>
<span id="cb19-13"><a href="#cb19-13" aria-hidden="true" tabindex="-1"></a>    api_key<span class="op">=</span>openrouter_api_key,</span>
<span id="cb19-14"><a href="#cb19-14" aria-hidden="true" tabindex="-1"></a>    api_base<span class="op">=</span><span class="st">"https://openrouter.ai/api/v1"</span>,</span>
<span id="cb19-15"><a href="#cb19-15" aria-hidden="true" tabindex="-1"></a>    model_name<span class="op">=</span><span class="st">"qwen/qwen3-embedding-8b"</span></span>
<span id="cb19-16"><a href="#cb19-16" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb19-17"><a href="#cb19-17" aria-hidden="true" tabindex="-1"></a>Settings.embed_model <span class="op">=</span> embed_model</span>
<span id="cb19-18"><a href="#cb19-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-19"><a href="#cb19-19" aria-hidden="true" tabindex="-1"></a><span class="co"># 2. Load Vector Store</span></span>
<span id="cb19-20"><a href="#cb19-20" aria-hidden="true" tabindex="-1"></a>vector_store <span class="op">=</span> DuckDBVectorStore(database_name<span class="op">=</span><span class="st">"open.duckdb"</span>, persist_dir<span class="op">=</span><span class="st">"./persist/"</span>)</span>
<span id="cb19-21"><a href="#cb19-21" aria-hidden="true" tabindex="-1"></a>index <span class="op">=</span> VectorStoreIndex.from_vector_store(vector_store<span class="op">=</span>vector_store)</span>
<span id="cb19-22"><a href="#cb19-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-23"><a href="#cb19-23" aria-hidden="true" tabindex="-1"></a><span class="co"># 3. Define Retrieval Tool</span></span>
<span id="cb19-24"><a href="#cb19-24" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> retrieve_trusted_content(query: <span class="bu">str</span>, top_k: <span class="bu">int</span> <span class="op">=</span> <span class="dv">5</span>):</span>
<span id="cb19-25"><a href="#cb19-25" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb19-26"><a href="#cb19-26" aria-hidden="true" tabindex="-1"></a><span class="co">    Retrieve relevant content from the knowledge store.</span></span>
<span id="cb19-27"><a href="#cb19-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-28"><a href="#cb19-28" aria-hidden="true" tabindex="-1"></a><span class="co">    Parameters</span></span>
<span id="cb19-29"><a href="#cb19-29" aria-hidden="true" tabindex="-1"></a><span class="co">    ----------</span></span>
<span id="cb19-30"><a href="#cb19-30" aria-hidden="true" tabindex="-1"></a><span class="co">    query</span></span>
<span id="cb19-31"><a href="#cb19-31" aria-hidden="true" tabindex="-1"></a><span class="co">        The query used to semantically search the knowledge store.</span></span>
<span id="cb19-32"><a href="#cb19-32" aria-hidden="true" tabindex="-1"></a><span class="co">    top_k</span></span>
<span id="cb19-33"><a href="#cb19-33" aria-hidden="true" tabindex="-1"></a><span class="co">        The number of results to retrieve from the knowledge store.</span></span>
<span id="cb19-34"><a href="#cb19-34" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb19-35"><a href="#cb19-35" aria-hidden="true" tabindex="-1"></a>    <span class="co">#print(f"Retrieving content for query: '{query}'")</span></span>
<span id="cb19-36"><a href="#cb19-36" aria-hidden="true" tabindex="-1"></a>    retriever <span class="op">=</span> index.as_retriever(similarity_top_k<span class="op">=</span>top_k)</span>
<span id="cb19-37"><a href="#cb19-37" aria-hidden="true" tabindex="-1"></a>    nodes <span class="op">=</span> retriever.retrieve(query)</span>
<span id="cb19-38"><a href="#cb19-38" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> [<span class="ss">f"&lt;excerpt&gt;</span><span class="sc">{</span>x<span class="sc">.</span>text<span class="sc">}</span><span class="ss">&lt;/excerpt&gt;"</span> <span class="cf">for</span> x <span class="kw">in</span> nodes]</span>
<span id="cb19-39"><a href="#cb19-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-40"><a href="#cb19-40" aria-hidden="true" tabindex="-1"></a><span class="co"># 4. Initialize Chat with System Prompt</span></span>
<span id="cb19-41"><a href="#cb19-41" aria-hidden="true" tabindex="-1"></a>chat <span class="op">=</span> ctl.ChatOpenAI(</span>
<span id="cb19-42"><a href="#cb19-42" aria-hidden="true" tabindex="-1"></a>    model<span class="op">=</span><span class="st">"openai/gpt-oss-120b"</span>,</span>
<span id="cb19-43"><a href="#cb19-43" aria-hidden="true" tabindex="-1"></a>    api_key<span class="op">=</span>openrouter_api_key,</span>
<span id="cb19-44"><a href="#cb19-44" aria-hidden="true" tabindex="-1"></a>    base_url<span class="op">=</span><span class="st">"https://openrouter.ai/api/v1"</span>,</span>
<span id="cb19-45"><a href="#cb19-45" aria-hidden="true" tabindex="-1"></a>    system_prompt<span class="op">=</span>(</span>
<span id="cb19-46"><a href="#cb19-46" aria-hidden="true" tabindex="-1"></a>        <span class="st">"You are an assistant for question-answering tasks. "</span></span>
<span id="cb19-47"><a href="#cb19-47" aria-hidden="true" tabindex="-1"></a>        <span class="st">"Use the retrieve_trusted_content tool to find relevant information from the knowledge store. "</span></span>
<span id="cb19-48"><a href="#cb19-48" aria-hidden="true" tabindex="-1"></a>        <span class="st">"Answer questions based on the retrieved content. "</span></span>
<span id="cb19-49"><a href="#cb19-49" aria-hidden="true" tabindex="-1"></a>        <span class="st">"If you cannot find relevant information, say so clearly."</span></span>
<span id="cb19-50"><a href="#cb19-50" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb19-51"><a href="#cb19-51" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb19-52"><a href="#cb19-52" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-53"><a href="#cb19-53" aria-hidden="true" tabindex="-1"></a>chat.register_tool(retrieve_trusted_content)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb20"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a>response<span class="op">=</span>chat.chat(<span class="st">"What are model variants?"</span>, echo<span class="op">=</span><span class="st">"none"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb21"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(response)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
</div>
<div id="tabset-4-3" class="tab-pane" role="tabpanel" aria-labelledby="tabset-4-3-tab">
<p>The final piece is to connect this retrieval capability to a chat interface. We use <code>LangChain</code> to create a RAG chain. We create a <code>retriever</code> from our vector store and combine it with a <code>ChatOpenAI</code> model (using OpenRouter) and a prompt template. This gives the LLM the ability to query our vector store whenever it needs information to answer a user’s question.</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb22"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> langchain_openai <span class="im">import</span> ChatOpenAI</span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> langchain_core.prompts <span class="im">import</span> ChatPromptTemplate</span>
<span id="cb22-3"><a href="#cb22-3" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> langchain_core.runnables <span class="im">import</span> RunnablePassthrough</span>
<span id="cb22-4"><a href="#cb22-4" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> langchain_core.output_parsers <span class="im">import</span> StrOutputParser</span>
<span id="cb22-5"><a href="#cb22-5" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> openai <span class="im">import</span> OpenAI</span>
<span id="cb22-6"><a href="#cb22-6" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> langchain_core.embeddings <span class="im">import</span> Embeddings</span>
<span id="cb22-7"><a href="#cb22-7" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> langchain_chroma <span class="im">import</span> Chroma</span>
<span id="cb22-8"><a href="#cb22-8" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> typing <span class="im">import</span> List</span>
<span id="cb22-9"><a href="#cb22-9" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> os</span>
<span id="cb22-10"><a href="#cb22-10" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> dotenv <span class="im">import</span> load_dotenv</span>
<span id="cb22-11"><a href="#cb22-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-12"><a href="#cb22-12" aria-hidden="true" tabindex="-1"></a>load_dotenv()</span>
<span id="cb22-13"><a href="#cb22-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-14"><a href="#cb22-14" aria-hidden="true" tabindex="-1"></a><span class="co"># Custom embeddings class for OpenRouter API</span></span>
<span id="cb22-15"><a href="#cb22-15" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> OpenRouterEmbeddings(Embeddings):</span>
<span id="cb22-16"><a href="#cb22-16" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Custom embeddings class for OpenRouter API."""</span></span>
<span id="cb22-17"><a href="#cb22-17" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb22-18"><a href="#cb22-18" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>, api_key: <span class="bu">str</span>, model: <span class="bu">str</span> <span class="op">=</span> <span class="st">"qwen/qwen3-embedding-8b"</span>):</span>
<span id="cb22-19"><a href="#cb22-19" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.client <span class="op">=</span> OpenAI(</span>
<span id="cb22-20"><a href="#cb22-20" aria-hidden="true" tabindex="-1"></a>            base_url<span class="op">=</span><span class="st">"https://openrouter.ai/api/v1"</span>,</span>
<span id="cb22-21"><a href="#cb22-21" aria-hidden="true" tabindex="-1"></a>            api_key<span class="op">=</span>api_key,</span>
<span id="cb22-22"><a href="#cb22-22" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb22-23"><a href="#cb22-23" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.model <span class="op">=</span> model</span>
<span id="cb22-24"><a href="#cb22-24" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb22-25"><a href="#cb22-25" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> embed_documents(<span class="va">self</span>, texts: List[<span class="bu">str</span>]) <span class="op">-&gt;</span> List[List[<span class="bu">float</span>]]:</span>
<span id="cb22-26"><a href="#cb22-26" aria-hidden="true" tabindex="-1"></a>        <span class="co">"""Embed a list of documents."""</span></span>
<span id="cb22-27"><a href="#cb22-27" aria-hidden="true" tabindex="-1"></a>        response <span class="op">=</span> <span class="va">self</span>.client.embeddings.create(</span>
<span id="cb22-28"><a href="#cb22-28" aria-hidden="true" tabindex="-1"></a>            extra_headers<span class="op">=</span>{</span>
<span id="cb22-29"><a href="#cb22-29" aria-hidden="true" tabindex="-1"></a>                <span class="st">"HTTP-Referer"</span>: <span class="st">"https://ai-blog.com"</span>,</span>
<span id="cb22-30"><a href="#cb22-30" aria-hidden="true" tabindex="-1"></a>                <span class="st">"X-Title"</span>: <span class="st">"AI Blog RAG"</span>,</span>
<span id="cb22-31"><a href="#cb22-31" aria-hidden="true" tabindex="-1"></a>            },</span>
<span id="cb22-32"><a href="#cb22-32" aria-hidden="true" tabindex="-1"></a>            model<span class="op">=</span><span class="va">self</span>.model,</span>
<span id="cb22-33"><a href="#cb22-33" aria-hidden="true" tabindex="-1"></a>            <span class="bu">input</span><span class="op">=</span>texts,</span>
<span id="cb22-34"><a href="#cb22-34" aria-hidden="true" tabindex="-1"></a>            encoding_format<span class="op">=</span><span class="st">"float"</span></span>
<span id="cb22-35"><a href="#cb22-35" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb22-36"><a href="#cb22-36" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> [item.embedding <span class="cf">for</span> item <span class="kw">in</span> response.data]</span>
<span id="cb22-37"><a href="#cb22-37" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb22-38"><a href="#cb22-38" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> embed_query(<span class="va">self</span>, text: <span class="bu">str</span>) <span class="op">-&gt;</span> List[<span class="bu">float</span>]:</span>
<span id="cb22-39"><a href="#cb22-39" aria-hidden="true" tabindex="-1"></a>        <span class="co">"""Embed a single query."""</span></span>
<span id="cb22-40"><a href="#cb22-40" aria-hidden="true" tabindex="-1"></a>        response <span class="op">=</span> <span class="va">self</span>.client.embeddings.create(</span>
<span id="cb22-41"><a href="#cb22-41" aria-hidden="true" tabindex="-1"></a>            extra_headers<span class="op">=</span>{</span>
<span id="cb22-42"><a href="#cb22-42" aria-hidden="true" tabindex="-1"></a>                <span class="st">"HTTP-Referer"</span>: <span class="st">"https://ai-blog.com"</span>,</span>
<span id="cb22-43"><a href="#cb22-43" aria-hidden="true" tabindex="-1"></a>                <span class="st">"X-Title"</span>: <span class="st">"AI Blog RAG"</span>,</span>
<span id="cb22-44"><a href="#cb22-44" aria-hidden="true" tabindex="-1"></a>            },</span>
<span id="cb22-45"><a href="#cb22-45" aria-hidden="true" tabindex="-1"></a>            model<span class="op">=</span><span class="va">self</span>.model,</span>
<span id="cb22-46"><a href="#cb22-46" aria-hidden="true" tabindex="-1"></a>            <span class="bu">input</span><span class="op">=</span>text,</span>
<span id="cb22-47"><a href="#cb22-47" aria-hidden="true" tabindex="-1"></a>            encoding_format<span class="op">=</span><span class="st">"float"</span></span>
<span id="cb22-48"><a href="#cb22-48" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb22-49"><a href="#cb22-49" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> response.data[<span class="dv">0</span>].embedding</span>
<span id="cb22-50"><a href="#cb22-50" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-51"><a href="#cb22-51" aria-hidden="true" tabindex="-1"></a><span class="co"># Get OpenRouter API key</span></span>
<span id="cb22-52"><a href="#cb22-52" aria-hidden="true" tabindex="-1"></a>openrouter_api_key <span class="op">=</span> os.getenv(<span class="st">"OPENROUTER_API_KEY"</span>)</span>
<span id="cb22-53"><a href="#cb22-53" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> <span class="kw">not</span> openrouter_api_key:</span>
<span id="cb22-54"><a href="#cb22-54" aria-hidden="true" tabindex="-1"></a>    <span class="cf">raise</span> <span class="pp">ValueError</span>(<span class="st">"OPENROUTER_API_KEY not found in environment variables"</span>)</span>
<span id="cb22-55"><a href="#cb22-55" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-56"><a href="#cb22-56" aria-hidden="true" tabindex="-1"></a><span class="co"># Create embeddings instance using OpenRouter</span></span>
<span id="cb22-57"><a href="#cb22-57" aria-hidden="true" tabindex="-1"></a>embeddings <span class="op">=</span> OpenRouterEmbeddings(</span>
<span id="cb22-58"><a href="#cb22-58" aria-hidden="true" tabindex="-1"></a>    api_key<span class="op">=</span>openrouter_api_key,</span>
<span id="cb22-59"><a href="#cb22-59" aria-hidden="true" tabindex="-1"></a>    model<span class="op">=</span><span class="st">"qwen/qwen3-embedding-8b"</span></span>
<span id="cb22-60"><a href="#cb22-60" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb22-61"><a href="#cb22-61" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-62"><a href="#cb22-62" aria-hidden="true" tabindex="-1"></a><span class="co"># Define vector store location</span></span>
<span id="cb22-63"><a href="#cb22-63" aria-hidden="true" tabindex="-1"></a>persist_directory <span class="op">=</span> <span class="st">"chroma_db_data"</span></span>
<span id="cb22-64"><a href="#cb22-64" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-65"><a href="#cb22-65" aria-hidden="true" tabindex="-1"></a><span class="co"># Load existing vector store</span></span>
<span id="cb22-66"><a href="#cb22-66" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Loading existing vectorstore from </span><span class="sc">{</span>persist_directory<span class="sc">}</span><span class="ss">..."</span>)</span>
<span id="cb22-67"><a href="#cb22-67" aria-hidden="true" tabindex="-1"></a>vectorstore <span class="op">=</span> Chroma(</span>
<span id="cb22-68"><a href="#cb22-68" aria-hidden="true" tabindex="-1"></a>    persist_directory<span class="op">=</span>persist_directory,</span>
<span id="cb22-69"><a href="#cb22-69" aria-hidden="true" tabindex="-1"></a>    embedding_function<span class="op">=</span>embeddings</span>
<span id="cb22-70"><a href="#cb22-70" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb22-71"><a href="#cb22-71" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"✓ Loaded vectorstore"</span>)</span>
<span id="cb22-72"><a href="#cb22-72" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-73"><a href="#cb22-73" aria-hidden="true" tabindex="-1"></a><span class="co"># Initialize LLM using OpenRouter</span></span>
<span id="cb22-74"><a href="#cb22-74" aria-hidden="true" tabindex="-1"></a>llm <span class="op">=</span> ChatOpenAI(</span>
<span id="cb22-75"><a href="#cb22-75" aria-hidden="true" tabindex="-1"></a>    model<span class="op">=</span><span class="st">"openai/gpt-oss-120b"</span>,</span>
<span id="cb22-76"><a href="#cb22-76" aria-hidden="true" tabindex="-1"></a>    openai_api_key<span class="op">=</span>os.getenv(<span class="st">"OPENROUTER_API_KEY"</span>),</span>
<span id="cb22-77"><a href="#cb22-77" aria-hidden="true" tabindex="-1"></a>    openai_api_base<span class="op">=</span><span class="st">"https://openrouter.ai/api/v1"</span></span>
<span id="cb22-78"><a href="#cb22-78" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb22-79"><a href="#cb22-79" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-80"><a href="#cb22-80" aria-hidden="true" tabindex="-1"></a><span class="co"># Create prompt template</span></span>
<span id="cb22-81"><a href="#cb22-81" aria-hidden="true" tabindex="-1"></a>system_prompt <span class="op">=</span> (</span>
<span id="cb22-82"><a href="#cb22-82" aria-hidden="true" tabindex="-1"></a>    <span class="st">"You are an assistant for question-answering tasks. "</span></span>
<span id="cb22-83"><a href="#cb22-83" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Use the following pieces of retrieved context to answer "</span></span>
<span id="cb22-84"><a href="#cb22-84" aria-hidden="true" tabindex="-1"></a>    <span class="st">"the question. If you don't know the answer, say that you "</span></span>
<span id="cb22-85"><a href="#cb22-85" aria-hidden="true" tabindex="-1"></a>    <span class="st">"don't know. Use three sentences maximum and keep the "</span></span>
<span id="cb22-86"><a href="#cb22-86" aria-hidden="true" tabindex="-1"></a>    <span class="st">"answer concise."</span></span>
<span id="cb22-87"><a href="#cb22-87" aria-hidden="true" tabindex="-1"></a>    <span class="st">"</span><span class="ch">\n\n</span><span class="st">"</span></span>
<span id="cb22-88"><a href="#cb22-88" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Context: </span><span class="sc">{context}</span><span class="st">"</span></span>
<span id="cb22-89"><a href="#cb22-89" aria-hidden="true" tabindex="-1"></a>    <span class="st">"</span><span class="ch">\n\n</span><span class="st">"</span></span>
<span id="cb22-90"><a href="#cb22-90" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Question: </span><span class="sc">{question}</span><span class="st">"</span></span>
<span id="cb22-91"><a href="#cb22-91" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb22-92"><a href="#cb22-92" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-93"><a href="#cb22-93" aria-hidden="true" tabindex="-1"></a>prompt <span class="op">=</span> ChatPromptTemplate.from_template(system_prompt)</span>
<span id="cb22-94"><a href="#cb22-94" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-95"><a href="#cb22-95" aria-hidden="true" tabindex="-1"></a><span class="co"># Create retriever</span></span>
<span id="cb22-96"><a href="#cb22-96" aria-hidden="true" tabindex="-1"></a>retriever <span class="op">=</span> vectorstore.as_retriever(search_kwargs<span class="op">=</span>{<span class="st">"k"</span>: <span class="dv">3</span>})</span>
<span id="cb22-97"><a href="#cb22-97" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-98"><a href="#cb22-98" aria-hidden="true" tabindex="-1"></a><span class="co"># Helper function to format documents</span></span>
<span id="cb22-99"><a href="#cb22-99" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> format_docs(docs):</span>
<span id="cb22-100"><a href="#cb22-100" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="st">"</span><span class="ch">\n\n</span><span class="st">"</span>.join(doc.page_content <span class="cf">for</span> doc <span class="kw">in</span> docs)</span>
<span id="cb22-101"><a href="#cb22-101" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-102"><a href="#cb22-102" aria-hidden="true" tabindex="-1"></a><span class="co"># Create RAG chain using LCEL</span></span>
<span id="cb22-103"><a href="#cb22-103" aria-hidden="true" tabindex="-1"></a>rag_chain <span class="op">=</span> (</span>
<span id="cb22-104"><a href="#cb22-104" aria-hidden="true" tabindex="-1"></a>    {</span>
<span id="cb22-105"><a href="#cb22-105" aria-hidden="true" tabindex="-1"></a>        <span class="st">"context"</span>: retriever <span class="op">|</span> format_docs,</span>
<span id="cb22-106"><a href="#cb22-106" aria-hidden="true" tabindex="-1"></a>        <span class="st">"question"</span>: RunnablePassthrough()</span>
<span id="cb22-107"><a href="#cb22-107" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb22-108"><a href="#cb22-108" aria-hidden="true" tabindex="-1"></a>    <span class="op">|</span> prompt</span>
<span id="cb22-109"><a href="#cb22-109" aria-hidden="true" tabindex="-1"></a>    <span class="op">|</span> llm</span>
<span id="cb22-110"><a href="#cb22-110" aria-hidden="true" tabindex="-1"></a>    <span class="op">|</span> StrOutputParser()</span>
<span id="cb22-111"><a href="#cb22-111" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb22-112"><a href="#cb22-112" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-113"><a href="#cb22-113" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"✓ RAG chain created successfully!"</span>)</span>
<span id="cb22-114"><a href="#cb22-114" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-115"><a href="#cb22-115" aria-hidden="true" tabindex="-1"></a><span class="co"># Test the RAG chain</span></span>
<span id="cb22-116"><a href="#cb22-116" aria-hidden="true" tabindex="-1"></a>question <span class="op">=</span> <span class="st">"What are model variants?"</span></span>
<span id="cb22-117"><a href="#cb22-117" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-118"><a href="#cb22-118" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">Question: </span><span class="sc">{</span>question<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb22-119"><a href="#cb22-119" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-120"><a href="#cb22-120" aria-hidden="true" tabindex="-1"></a><span class="co"># Get context documents separately for display</span></span>
<span id="cb22-121"><a href="#cb22-121" aria-hidden="true" tabindex="-1"></a>context_docs <span class="op">=</span> retriever.invoke(question)</span>
<span id="cb22-122"><a href="#cb22-122" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-123"><a href="#cb22-123" aria-hidden="true" tabindex="-1"></a><span class="co"># Invoke the RAG chain</span></span>
<span id="cb22-124"><a href="#cb22-124" aria-hidden="true" tabindex="-1"></a>answer <span class="op">=</span> rag_chain.invoke(question)</span>
<span id="cb22-125"><a href="#cb22-125" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> textwrap</span>
<span id="cb22-126"><a href="#cb22-126" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-127"><a href="#cb22-127" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> line <span class="kw">in</span> answer.split(<span class="st">'</span><span class="ch">\n</span><span class="st">'</span>):</span>
<span id="cb22-128"><a href="#cb22-128" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(textwrap.fill(line, width<span class="op">=</span><span class="dv">80</span>))</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
</div>
</div>
</div>


<!-- -->

</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
  window.document.addEventListener("DOMContentLoaded", function (event) {
    // Ensure there is a toggle, if there isn't float one in the top right
    if (window.document.querySelector('.quarto-color-scheme-toggle') === null) {
      const a = window.document.createElement('a');
      a.classList.add('top-right');
      a.classList.add('quarto-color-scheme-toggle');
      a.href = "";
      a.onclick = function() { try { window.quartoToggleColorScheme(); } catch {} return false; };
      const i = window.document.createElement("i");
      i.classList.add('bi');
      a.appendChild(i);
      window.document.body.appendChild(a);
    }
    setColorSchemeToggle(hasAlternateSentinel())
    const icon = "";
    const anchorJS = new window.AnchorJS();
    anchorJS.options = {
      placement: 'right',
      icon: icon
    };
    anchorJS.add('.anchored');
    const isCodeAnnotation = (el) => {
      for (const clz of el.classList) {
        if (clz.startsWith('code-annotation-')) {                     
          return true;
        }
      }
      return false;
    }
    const onCopySuccess = function(e) {
      // button target
      const button = e.trigger;
      // don't keep focus
      button.blur();
      // flash "checked"
      button.classList.add('code-copy-button-checked');
      var currentTitle = button.getAttribute("title");
      button.setAttribute("title", "Copied!");
      let tooltip;
      if (window.bootstrap) {
        button.setAttribute("data-bs-toggle", "tooltip");
        button.setAttribute("data-bs-placement", "left");
        button.setAttribute("data-bs-title", "Copied!");
        tooltip = new bootstrap.Tooltip(button, 
          { trigger: "manual", 
            customClass: "code-copy-button-tooltip",
            offset: [0, -8]});
        tooltip.show();    
      }
      setTimeout(function() {
        if (tooltip) {
          tooltip.hide();
          button.removeAttribute("data-bs-title");
          button.removeAttribute("data-bs-toggle");
          button.removeAttribute("data-bs-placement");
        }
        button.setAttribute("title", currentTitle);
        button.classList.remove('code-copy-button-checked');
      }, 1000);
      // clear code selection
      e.clearSelection();
    }
    const getTextToCopy = function(trigger) {
      const outerScaffold = trigger.parentElement.cloneNode(true);
      const codeEl = outerScaffold.querySelector('code');
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
    const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
      text: getTextToCopy
    });
    clipboard.on('success', onCopySuccess);
    if (window.document.getElementById('quarto-embedded-source-code-modal')) {
      const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
        text: getTextToCopy,
        container: window.document.getElementById('quarto-embedded-source-code-modal')
      });
      clipboardModal.on('success', onCopySuccess);
    }
    const viewSource = window.document.getElementById('quarto-view-source') ||
                       window.document.getElementById('quarto-code-tools-source');
    if (viewSource) {
      const sourceUrl = viewSource.getAttribute("data-quarto-source-url");
      viewSource.addEventListener("click", function(e) {
        if (sourceUrl) {
          // rstudio viewer pane
          if (/\bcapabilities=\b/.test(window.location)) {
            window.open(sourceUrl);
          } else {
            window.location.href = sourceUrl;
          }
        } else {
          const modal = new bootstrap.Modal(document.getElementById('quarto-embedded-source-code-modal'));
          modal.show();
        }
        return false;
      });
    }
    function toggleCodeHandler(show) {
      return function(e) {
        const detailsSrc = window.document.querySelectorAll(".cell > details > .sourceCode");
        for (let i=0; i<detailsSrc.length; i++) {
          const details = detailsSrc[i].parentElement;
          if (show) {
            details.open = true;
          } else {
            details.removeAttribute("open");
          }
        }
        const cellCodeDivs = window.document.querySelectorAll(".cell > .sourceCode");
        const fromCls = show ? "hidden" : "unhidden";
        const toCls = show ? "unhidden" : "hidden";
        for (let i=0; i<cellCodeDivs.length; i++) {
          const codeDiv = cellCodeDivs[i];
          if (codeDiv.classList.contains(fromCls)) {
            codeDiv.classList.remove(fromCls);
            codeDiv.classList.add(toCls);
          } 
        }
        return false;
      }
    }
    const hideAllCode = window.document.getElementById("quarto-hide-all-code");
    if (hideAllCode) {
      hideAllCode.addEventListener("click", toggleCodeHandler(false));
    }
    const showAllCode = window.document.getElementById("quarto-show-all-code");
    if (showAllCode) {
      showAllCode.addEventListener("click", toggleCodeHandler(true));
    }
      var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
      var mailtoRegex = new RegExp(/^mailto:/);
        var filterRegex = new RegExp("https:\/\/your-website-url\.example\.com");
      var isInternal = (href) => {
          return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
      }
      // Inspect non-navigation links and adorn them if external
     var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
      for (var i=0; i<links.length; i++) {
        const link = links[i];
        if (!isInternal(link.href)) {
          // undo the damage that might have been done by quarto-nav.js in the case of
          // links that we want to consider external
          if (link.dataset.originalHref !== undefined) {
            link.href = link.dataset.originalHref;
          }
        }
      }
    function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
      const config = {
        allowHTML: true,
        maxWidth: 500,
        delay: 100,
        arrow: false,
        appendTo: function(el) {
            return el.parentElement;
        },
        interactive: true,
        interactiveBorder: 10,
        theme: 'quarto',
        placement: 'bottom-start',
      };
      if (contentFn) {
        config.content = contentFn;
      }
      if (onTriggerFn) {
        config.onTrigger = onTriggerFn;
      }
      if (onUntriggerFn) {
        config.onUntrigger = onUntriggerFn;
      }
      window.tippy(el, config); 
    }
    const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
    for (var i=0; i<noterefs.length; i++) {
      const ref = noterefs[i];
      tippyHover(ref, function() {
        // use id or data attribute instead here
        let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
        try { href = new URL(href).hash; } catch {}
        const id = href.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note) {
          return note.innerHTML;
        } else {
          return "";
        }
      });
    }
    const xrefs = window.document.querySelectorAll('a.quarto-xref');
    const processXRef = (id, note) => {
      // Strip column container classes
      const stripColumnClz = (el) => {
        el.classList.remove("page-full", "page-columns");
        if (el.children) {
          for (const child of el.children) {
            stripColumnClz(child);
          }
        }
      }
      stripColumnClz(note)
      if (id === null || id.startsWith('sec-')) {
        // Special case sections, only their first couple elements
        const container = document.createElement("div");
        if (note.children && note.children.length > 2) {
          container.appendChild(note.children[0].cloneNode(true));
          for (let i = 1; i < note.children.length; i++) {
            const child = note.children[i];
            if (child.tagName === "P" && child.innerText === "") {
              continue;
            } else {
              container.appendChild(child.cloneNode(true));
              break;
            }
          }
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(container);
          }
          return container.innerHTML
        } else {
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(note);
          }
          return note.innerHTML;
        }
      } else {
        // Remove any anchor links if they are present
        const anchorLink = note.querySelector('a.anchorjs-link');
        if (anchorLink) {
          anchorLink.remove();
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        if (note.classList.contains("callout")) {
          return note.outerHTML;
        } else {
          return note.innerHTML;
        }
      }
    }
    for (var i=0; i<xrefs.length; i++) {
      const xref = xrefs[i];
      tippyHover(xref, undefined, function(instance) {
        instance.disable();
        let url = xref.getAttribute('href');
        let hash = undefined; 
        if (url.startsWith('#')) {
          hash = url;
        } else {
          try { hash = new URL(url).hash; } catch {}
        }
        if (hash) {
          const id = hash.replace(/^#\/?/, "");
          const note = window.document.getElementById(id);
          if (note !== null) {
            try {
              const html = processXRef(id, note.cloneNode(true));
              instance.setContent(html);
            } finally {
              instance.enable();
              instance.show();
            }
          } else {
            // See if we can fetch this
            fetch(url.split('#')[0])
            .then(res => res.text())
            .then(html => {
              const parser = new DOMParser();
              const htmlDoc = parser.parseFromString(html, "text/html");
              const note = htmlDoc.getElementById(id);
              if (note !== null) {
                const html = processXRef(id, note);
                instance.setContent(html);
              } 
            }).finally(() => {
              instance.enable();
              instance.show();
            });
          }
        } else {
          // See if we can fetch a full url (with no hash to target)
          // This is a special case and we should probably do some content thinning / targeting
          fetch(url)
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.querySelector('main.content');
            if (note !== null) {
              // This should only happen for chapter cross references
              // (since there is no id in the URL)
              // remove the first header
              if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
                note.children[0].remove();
              }
              const html = processXRef(null, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      }, function(instance) {
      });
    }
        let selectedAnnoteEl;
        const selectorForAnnotation = ( cell, annotation) => {
          let cellAttr = 'data-code-cell="' + cell + '"';
          let lineAttr = 'data-code-annotation="' +  annotation + '"';
          const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
          return selector;
        }
        const selectCodeLines = (annoteEl) => {
          const doc = window.document;
          const targetCell = annoteEl.getAttribute("data-target-cell");
          const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
          const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
          const lines = annoteSpan.getAttribute("data-code-lines").split(",");
          const lineIds = lines.map((line) => {
            return targetCell + "-" + line;
          })
          let top = null;
          let height = null;
          let parent = null;
          if (lineIds.length > 0) {
              //compute the position of the single el (top and bottom and make a div)
              const el = window.document.getElementById(lineIds[0]);
              top = el.offsetTop;
              height = el.offsetHeight;
              parent = el.parentElement.parentElement;
            if (lineIds.length > 1) {
              const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
              const bottom = lastEl.offsetTop + lastEl.offsetHeight;
              height = bottom - top;
            }
            if (top !== null && height !== null && parent !== null) {
              // cook up a div (if necessary) and position it 
              let div = window.document.getElementById("code-annotation-line-highlight");
              if (div === null) {
                div = window.document.createElement("div");
                div.setAttribute("id", "code-annotation-line-highlight");
                div.style.position = 'absolute';
                parent.appendChild(div);
              }
              div.style.top = top - 2 + "px";
              div.style.height = height + 4 + "px";
              div.style.left = 0;
              let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
              if (gutterDiv === null) {
                gutterDiv = window.document.createElement("div");
                gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
                gutterDiv.style.position = 'absolute';
                const codeCell = window.document.getElementById(targetCell);
                const gutter = codeCell.querySelector('.code-annotation-gutter');
                gutter.appendChild(gutterDiv);
              }
              gutterDiv.style.top = top - 2 + "px";
              gutterDiv.style.height = height + 4 + "px";
            }
            selectedAnnoteEl = annoteEl;
          }
        };
        const unselectCodeLines = () => {
          const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
          elementsIds.forEach((elId) => {
            const div = window.document.getElementById(elId);
            if (div) {
              div.remove();
            }
          });
          selectedAnnoteEl = undefined;
        };
          // Handle positioning of the toggle
      window.addEventListener(
        "resize",
        throttle(() => {
          elRect = undefined;
          if (selectedAnnoteEl) {
            selectCodeLines(selectedAnnoteEl);
          }
        }, 10)
      );
      function throttle(fn, ms) {
      let throttle = false;
      let timer;
        return (...args) => {
          if(!throttle) { // first call gets through
              fn.apply(this, args);
              throttle = true;
          } else { // all the others get throttled
              if(timer) clearTimeout(timer); // cancel #2
              timer = setTimeout(() => {
                fn.apply(this, args);
                timer = throttle = false;
              }, ms);
          }
        };
      }
        // Attach click handler to the DT
        const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
        for (const annoteDlNode of annoteDls) {
          annoteDlNode.addEventListener('click', (event) => {
            const clickedEl = event.target;
            if (clickedEl !== selectedAnnoteEl) {
              unselectCodeLines();
              const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
              if (activeEl) {
                activeEl.classList.remove('code-annotation-active');
              }
              selectCodeLines(clickedEl);
              clickedEl.classList.add('code-annotation-active');
            } else {
              // Unselect the line
              unselectCodeLines();
              clickedEl.classList.remove('code-annotation-active');
            }
          });
        }
    const findCites = (el) => {
      const parentEl = el.parentElement;
      if (parentEl) {
        const cites = parentEl.dataset.cites;
        if (cites) {
          return {
            el,
            cites: cites.split(' ')
          };
        } else {
          return findCites(el.parentElement)
        }
      } else {
        return undefined;
      }
    };
    var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
    for (var i=0; i<bibliorefs.length; i++) {
      const ref = bibliorefs[i];
      const citeInfo = findCites(ref);
      if (citeInfo) {
        tippyHover(citeInfo.el, function() {
          var popup = window.document.createElement('div');
          citeInfo.cites.forEach(function(cite) {
            var citeDiv = window.document.createElement('div');
            citeDiv.classList.add('hanging-indent');
            citeDiv.classList.add('csl-entry');
            var biblioDiv = window.document.getElementById('ref-' + cite);
            if (biblioDiv) {
              citeDiv.innerHTML = biblioDiv.innerHTML;
            }
            popup.appendChild(citeDiv);
          });
          return popup.innerHTML;
        });
      }
    }
  });
  </script><div class="modal fade" id="quarto-embedded-source-code-modal" tabindex="-1" aria-labelledby="quarto-embedded-source-code-modal-label" aria-hidden="true"><div class="modal-dialog modal-dialog-scrollable"><div class="modal-content"><div class="modal-header"><h5 class="modal-title" id="quarto-embedded-source-code-modal-label">Source Code</h5><button class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><div class="">
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb23" data-shortcodes="false"><pre class="sourceCode markdown code-with-copy"><code class="sourceCode markdown"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a><span class="co">---</span></span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a><span class="an">title:</span><span class="co"> "Retrieval-Augmented Generation(RAG) in R &amp; Python"</span></span>
<span id="cb23-3"><a href="#cb23-3" aria-hidden="true" tabindex="-1"></a><span class="an">author:</span><span class="co"> "Tony D"</span></span>
<span id="cb23-4"><a href="#cb23-4" aria-hidden="true" tabindex="-1"></a><span class="an">date:</span><span class="co"> "2025-11-02"</span></span>
<span id="cb23-5"><a href="#cb23-5" aria-hidden="true" tabindex="-1"></a><span class="an">categories:</span><span class="co"> [AI, API, tutorial]</span></span>
<span id="cb23-6"><a href="#cb23-6" aria-hidden="true" tabindex="-1"></a><span class="an">image:</span><span class="co"> "images.png"</span></span>
<span id="cb23-7"><a href="#cb23-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-8"><a href="#cb23-8" aria-hidden="true" tabindex="-1"></a><span class="an">format:</span></span>
<span id="cb23-9"><a href="#cb23-9" aria-hidden="true" tabindex="-1"></a><span class="co">  html:</span></span>
<span id="cb23-10"><a href="#cb23-10" aria-hidden="true" tabindex="-1"></a><span class="co">    code-fold: false</span></span>
<span id="cb23-11"><a href="#cb23-11" aria-hidden="true" tabindex="-1"></a><span class="co">    code-tools: true</span></span>
<span id="cb23-12"><a href="#cb23-12" aria-hidden="true" tabindex="-1"></a><span class="co">    code-copy: true</span></span>
<span id="cb23-13"><a href="#cb23-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-14"><a href="#cb23-14" aria-hidden="true" tabindex="-1"></a><span class="an">execute:</span></span>
<span id="cb23-15"><a href="#cb23-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-16"><a href="#cb23-16" aria-hidden="true" tabindex="-1"></a><span class="co">  warning: false</span></span>
<span id="cb23-17"><a href="#cb23-17" aria-hidden="true" tabindex="-1"></a><span class="co">---</span></span>
<span id="cb23-18"><a href="#cb23-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-19"><a href="#cb23-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-20"><a href="#cb23-20" aria-hidden="true" tabindex="-1"></a><span class="in">```{r setup, include=FALSE}</span></span>
<span id="cb23-21"><a href="#cb23-21" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(reticulate)</span>
<span id="cb23-22"><a href="#cb23-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-23"><a href="#cb23-23" aria-hidden="true" tabindex="-1"></a><span class="co"># Use Python 3.13</span></span>
<span id="cb23-24"><a href="#cb23-24" aria-hidden="true" tabindex="-1"></a><span class="fu">use_python</span>(<span class="st">"/Library/Frameworks/Python.framework/Versions/3.13/bin/python3"</span>, <span class="at">required =</span> <span class="cn">TRUE</span>)</span>
<span id="cb23-25"><a href="#cb23-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-26"><a href="#cb23-26" aria-hidden="true" tabindex="-1"></a><span class="co"># Install required packages</span></span>
<span id="cb23-27"><a href="#cb23-27" aria-hidden="true" tabindex="-1"></a><span class="co"># py_install(c("openai", "langchain-core", "langchain-chroma", "langchain-community", "langchain-openai", "markitdown", "beautifulsoup4", "python-dotenv"), pip = TRUE)</span></span>
<span id="cb23-28"><a href="#cb23-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-29"><a href="#cb23-29" aria-hidden="true" tabindex="-1"></a><span class="co"># Verify Python</span></span>
<span id="cb23-30"><a href="#cb23-30" aria-hidden="true" tabindex="-1"></a><span class="fu">py_config</span>()</span>
<span id="cb23-31"><a href="#cb23-31" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb23-32"><a href="#cb23-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-33"><a href="#cb23-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-34"><a href="#cb23-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-35"><a href="#cb23-35" aria-hidden="true" tabindex="-1"></a><span class="fu"># Introduction</span></span>
<span id="cb23-36"><a href="#cb23-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-37"><a href="#cb23-37" aria-hidden="true" tabindex="-1"></a>Retrieval-Augmented Generation (RAG) is a powerful technique that combines the generative capabilities of Large Language Models (LLMs) with the precision of information retrieval. By grounding LLM responses in external, verifiable data, RAG reduces hallucinations and enables the model to answer questions about specific, private, or up-to-date information.</span>
<span id="cb23-38"><a href="#cb23-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-39"><a href="#cb23-39" aria-hidden="true" tabindex="-1"></a>In this tutorial, we will build a RAG system using both R and Python. </span>
<span id="cb23-40"><a href="#cb23-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-41"><a href="#cb23-41" aria-hidden="true" tabindex="-1"></a>In R, we'll leverage the <span class="in">`ragnar`</span> package for RAG workflows and <span class="in">`ellmer`</span> for chat interfaces. </span>
<span id="cb23-42"><a href="#cb23-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-43"><a href="#cb23-43" aria-hidden="true" tabindex="-1"></a>In Python, we'll use <span class="in">`LangChain`</span> for the RAG pipeline, <span class="in">`ChromaDB`</span> for the vector store, and <span class="in">`OpenAI`</span> for model interaction.</span>
<span id="cb23-44"><a href="#cb23-44" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-45"><a href="#cb23-45" aria-hidden="true" tabindex="-1"></a>Our goal is to create a system that can answer questions about the OpenRouter API by scraping its documentation.</span>
<span id="cb23-46"><a href="#cb23-46" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-47"><a href="#cb23-47" aria-hidden="true" tabindex="-1"></a><span class="fu"># Data Collection</span></span>
<span id="cb23-48"><a href="#cb23-48" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-49"><a href="#cb23-49" aria-hidden="true" tabindex="-1"></a>::: {.panel-tabset}</span>
<span id="cb23-50"><a href="#cb23-50" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-51"><a href="#cb23-51" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-52"><a href="#cb23-52" aria-hidden="true" tabindex="-1"></a><span class="fu">## R</span></span>
<span id="cb23-53"><a href="#cb23-53" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-54"><a href="#cb23-54" aria-hidden="true" tabindex="-1"></a>First, we need to gather the data for our knowledge base. We'll use the <span class="in">`rvest`</span> package to scrape URLs from the OpenRouter documentation. This will give us a list of pages to ingest.</span>
<span id="cb23-55"><a href="#cb23-55" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-56"><a href="#cb23-56" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-59"><a href="#cb23-59" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb23-60"><a href="#cb23-60" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ragnar)</span>
<span id="cb23-61"><a href="#cb23-61" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ellmer)</span>
<span id="cb23-62"><a href="#cb23-62" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(dotenv)</span>
<span id="cb23-63"><a href="#cb23-63" aria-hidden="true" tabindex="-1"></a><span class="fu">load_dot_env</span>(<span class="at">file =</span> <span class="st">".env"</span>)</span>
<span id="cb23-64"><a href="#cb23-64" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb23-65"><a href="#cb23-65" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-68"><a href="#cb23-68" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb23-69"><a href="#cb23-69" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(rvest)</span>
<span id="cb23-70"><a href="#cb23-70" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-71"><a href="#cb23-71" aria-hidden="true" tabindex="-1"></a><span class="co"># URL to scrape</span></span>
<span id="cb23-72"><a href="#cb23-72" aria-hidden="true" tabindex="-1"></a>url <span class="ot">&lt;-</span> <span class="st">"https://openrouter.ai/docs/quickstart"</span></span>
<span id="cb23-73"><a href="#cb23-73" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-74"><a href="#cb23-74" aria-hidden="true" tabindex="-1"></a><span class="co"># Read the HTML content of the page</span></span>
<span id="cb23-75"><a href="#cb23-75" aria-hidden="true" tabindex="-1"></a>page <span class="ot">&lt;-</span> <span class="fu">read_html</span>(url)</span>
<span id="cb23-76"><a href="#cb23-76" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-77"><a href="#cb23-77" aria-hidden="true" tabindex="-1"></a><span class="co"># Extract all &lt;a&gt; tags with href</span></span>
<span id="cb23-78"><a href="#cb23-78" aria-hidden="true" tabindex="-1"></a>links <span class="ot">&lt;-</span> page <span class="sc">%&gt;%</span></span>
<span id="cb23-79"><a href="#cb23-79" aria-hidden="true" tabindex="-1"></a>    <span class="fu">html_nodes</span>(<span class="st">"a"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb23-80"><a href="#cb23-80" aria-hidden="true" tabindex="-1"></a>    <span class="fu">html_attr</span>(<span class="st">"href"</span>)</span>
<span id="cb23-81"><a href="#cb23-81" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-82"><a href="#cb23-82" aria-hidden="true" tabindex="-1"></a><span class="co"># Remove NAs and duplicates</span></span>
<span id="cb23-83"><a href="#cb23-83" aria-hidden="true" tabindex="-1"></a>links <span class="ot">&lt;-</span> <span class="fu">unique</span>(<span class="fu">na.omit</span>(links))</span>
<span id="cb23-84"><a href="#cb23-84" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-85"><a href="#cb23-85" aria-hidden="true" tabindex="-1"></a><span class="co"># Optional: keep only full URLs</span></span>
<span id="cb23-86"><a href="#cb23-86" aria-hidden="true" tabindex="-1"></a>links_full <span class="ot">&lt;-</span> <span class="fu">paste0</span>(<span class="st">"https://openrouter.ai"</span>, links[<span class="fu">grepl</span>(<span class="st">"^/docs/"</span>, links)])</span>
<span id="cb23-87"><a href="#cb23-87" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-88"><a href="#cb23-88" aria-hidden="true" tabindex="-1"></a><span class="co"># Print all links</span></span>
<span id="cb23-89"><a href="#cb23-89" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(links_full)</span>
<span id="cb23-90"><a href="#cb23-90" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb23-91"><a href="#cb23-91" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-92"><a href="#cb23-92" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-93"><a href="#cb23-93" aria-hidden="true" tabindex="-1"></a><span class="fu">## Python </span></span>
<span id="cb23-94"><a href="#cb23-94" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-95"><a href="#cb23-95" aria-hidden="true" tabindex="-1"></a>First, we need to gather the data for our knowledge base. We'll use <span class="in">`requests`</span> and <span class="in">`BeautifulSoup`</span> to scrape URLs from the OpenRouter documentation. This will give us a list of pages to ingest.</span>
<span id="cb23-96"><a href="#cb23-96" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-99"><a href="#cb23-99" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb23-100"><a href="#cb23-100" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> sys</span>
<span id="cb23-101"><a href="#cb23-101" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(sys.executable)</span>
<span id="cb23-102"><a href="#cb23-102" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb23-103"><a href="#cb23-103" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-106"><a href="#cb23-106" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb23-107"><a href="#cb23-107" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> requests</span>
<span id="cb23-108"><a href="#cb23-108" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> bs4 <span class="im">import</span> BeautifulSoup</span>
<span id="cb23-109"><a href="#cb23-109" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> dotenv <span class="im">import</span> load_dotenv</span>
<span id="cb23-110"><a href="#cb23-110" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> os</span>
<span id="cb23-111"><a href="#cb23-111" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> markitdown <span class="im">import</span> MarkItDown</span>
<span id="cb23-112"><a href="#cb23-112" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> io <span class="im">import</span> BytesIO</span>
<span id="cb23-113"><a href="#cb23-113" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> re</span>
<span id="cb23-114"><a href="#cb23-114" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-115"><a href="#cb23-115" aria-hidden="true" tabindex="-1"></a><span class="co"># Load environment variables</span></span>
<span id="cb23-116"><a href="#cb23-116" aria-hidden="true" tabindex="-1"></a>load_dotenv()</span>
<span id="cb23-117"><a href="#cb23-117" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-118"><a href="#cb23-118" aria-hidden="true" tabindex="-1"></a><span class="co"># Helper functions</span></span>
<span id="cb23-119"><a href="#cb23-119" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> fetch_html(url: <span class="bu">str</span>) <span class="op">-&gt;</span> <span class="bu">bytes</span>:</span>
<span id="cb23-120"><a href="#cb23-120" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Fetch HTML content from URL and return as bytes."""</span></span>
<span id="cb23-121"><a href="#cb23-121" aria-hidden="true" tabindex="-1"></a>    resp <span class="op">=</span> requests.get(url)</span>
<span id="cb23-122"><a href="#cb23-122" aria-hidden="true" tabindex="-1"></a>    resp.raise_for_status()</span>
<span id="cb23-123"><a href="#cb23-123" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> resp.content</span>
<span id="cb23-124"><a href="#cb23-124" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-125"><a href="#cb23-125" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> html_to_markdown(html_bytes: <span class="bu">bytes</span>) <span class="op">-&gt;</span> <span class="bu">str</span>:</span>
<span id="cb23-126"><a href="#cb23-126" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Convert HTML bytes to markdown using MarkItDown."""</span></span>
<span id="cb23-127"><a href="#cb23-127" aria-hidden="true" tabindex="-1"></a>    md <span class="op">=</span> MarkItDown()</span>
<span id="cb23-128"><a href="#cb23-128" aria-hidden="true" tabindex="-1"></a>    stream <span class="op">=</span> BytesIO(html_bytes)</span>
<span id="cb23-129"><a href="#cb23-129" aria-hidden="true" tabindex="-1"></a>    result <span class="op">=</span> md.convert_stream(stream, mime_type<span class="op">=</span><span class="st">"text/html"</span>)</span>
<span id="cb23-130"><a href="#cb23-130" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> result.markdown</span>
<span id="cb23-131"><a href="#cb23-131" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-132"><a href="#cb23-132" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> save_markdown(md_content: <span class="bu">str</span>, output_path: <span class="bu">str</span>):</span>
<span id="cb23-133"><a href="#cb23-133" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Save markdown content to file."""</span></span>
<span id="cb23-134"><a href="#cb23-134" aria-hidden="true" tabindex="-1"></a>    <span class="cf">with</span> <span class="bu">open</span>(output_path, <span class="st">"w"</span>, encoding<span class="op">=</span><span class="st">"utf-8"</span>) <span class="im">as</span> f:</span>
<span id="cb23-135"><a href="#cb23-135" aria-hidden="true" tabindex="-1"></a>        f.write(md_content)</span>
<span id="cb23-136"><a href="#cb23-136" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-137"><a href="#cb23-137" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> sanitize_filename(filename: <span class="bu">str</span>) <span class="op">-&gt;</span> <span class="bu">str</span>:</span>
<span id="cb23-138"><a href="#cb23-138" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Sanitize URL to create a valid filename."""</span></span>
<span id="cb23-139"><a href="#cb23-139" aria-hidden="true" tabindex="-1"></a>    filename <span class="op">=</span> re.sub(<span class="vs">r'</span><span class="dv">^</span><span class="vs">https</span><span class="op">?</span><span class="vs">://</span><span class="pp">[^/]</span><span class="op">+</span><span class="vs">'</span>, <span class="st">''</span>, filename)</span>
<span id="cb23-140"><a href="#cb23-140" aria-hidden="true" tabindex="-1"></a>    filename <span class="op">=</span> re.sub(<span class="vs">r'</span><span class="pp">[^</span><span class="dv">\w</span><span class="ch">\-</span><span class="pp">_.]</span><span class="vs">'</span>, <span class="st">'_'</span>, filename)</span>
<span id="cb23-141"><a href="#cb23-141" aria-hidden="true" tabindex="-1"></a>    filename <span class="op">=</span> filename.strip(<span class="st">'_'</span>)</span>
<span id="cb23-142"><a href="#cb23-142" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="kw">not</span> filename.endswith(<span class="st">'.md'</span>):</span>
<span id="cb23-143"><a href="#cb23-143" aria-hidden="true" tabindex="-1"></a>        filename <span class="op">+=</span> <span class="st">'.md'</span></span>
<span id="cb23-144"><a href="#cb23-144" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> filename</span>
<span id="cb23-145"><a href="#cb23-145" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-146"><a href="#cb23-146" aria-hidden="true" tabindex="-1"></a><span class="co"># URL to scrape</span></span>
<span id="cb23-147"><a href="#cb23-147" aria-hidden="true" tabindex="-1"></a>url <span class="op">=</span> <span class="st">"https://openrouter.ai/docs/quickstart"</span></span>
<span id="cb23-148"><a href="#cb23-148" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-149"><a href="#cb23-149" aria-hidden="true" tabindex="-1"></a><span class="co"># Read the HTML content of the page</span></span>
<span id="cb23-150"><a href="#cb23-150" aria-hidden="true" tabindex="-1"></a>response <span class="op">=</span> requests.get(url)</span>
<span id="cb23-151"><a href="#cb23-151" aria-hidden="true" tabindex="-1"></a>soup <span class="op">=</span> BeautifulSoup(response.content, <span class="st">'html.parser'</span>)</span>
<span id="cb23-152"><a href="#cb23-152" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-153"><a href="#cb23-153" aria-hidden="true" tabindex="-1"></a><span class="co"># Extract all &lt;a&gt; tags with href</span></span>
<span id="cb23-154"><a href="#cb23-154" aria-hidden="true" tabindex="-1"></a>links <span class="op">=</span> [a[<span class="st">'href'</span>] <span class="cf">for</span> a <span class="kw">in</span> soup.find_all(<span class="st">'a'</span>, href<span class="op">=</span><span class="va">True</span>)]</span>
<span id="cb23-155"><a href="#cb23-155" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-156"><a href="#cb23-156" aria-hidden="true" tabindex="-1"></a><span class="co"># Remove duplicates</span></span>
<span id="cb23-157"><a href="#cb23-157" aria-hidden="true" tabindex="-1"></a>links <span class="op">=</span> <span class="bu">list</span>(<span class="bu">set</span>(links))</span>
<span id="cb23-158"><a href="#cb23-158" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-159"><a href="#cb23-159" aria-hidden="true" tabindex="-1"></a><span class="co"># Keep only full URLs for docs</span></span>
<span id="cb23-160"><a href="#cb23-160" aria-hidden="true" tabindex="-1"></a>links_full <span class="op">=</span> [<span class="ss">f"https://openrouter.ai</span><span class="sc">{</span>link<span class="sc">}</span><span class="ss">"</span> <span class="cf">for</span> link <span class="kw">in</span> links <span class="cf">if</span> link.startswith(<span class="st">"/docs/"</span>)]</span>
<span id="cb23-161"><a href="#cb23-161" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-162"><a href="#cb23-162" aria-hidden="true" tabindex="-1"></a><span class="co"># Explicitly add FAQ</span></span>
<span id="cb23-163"><a href="#cb23-163" aria-hidden="true" tabindex="-1"></a>links_full.append(<span class="st">"https://openrouter.ai/docs/faq"</span>)</span>
<span id="cb23-164"><a href="#cb23-164" aria-hidden="true" tabindex="-1"></a>links_full <span class="op">=</span> <span class="bu">list</span>(<span class="bu">set</span>(links_full))</span>
<span id="cb23-165"><a href="#cb23-165" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-166"><a href="#cb23-166" aria-hidden="true" tabindex="-1"></a><span class="co"># Print all links</span></span>
<span id="cb23-167"><a href="#cb23-167" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Found </span><span class="sc">{</span><span class="bu">len</span>(links_full)<span class="sc">}</span><span class="ss"> documentation URLs"</span>)</span>
<span id="cb23-168"><a href="#cb23-168" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(links_full)</span>
<span id="cb23-169"><a href="#cb23-169" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb23-170"><a href="#cb23-170" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-171"><a href="#cb23-171" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-172"><a href="#cb23-172" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb23-173"><a href="#cb23-173" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-174"><a href="#cb23-174" aria-hidden="true" tabindex="-1"></a><span class="fu"># Save web to local data</span></span>
<span id="cb23-175"><a href="#cb23-175" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-176"><a href="#cb23-176" aria-hidden="true" tabindex="-1"></a>::: {.panel-tabset}</span>
<span id="cb23-177"><a href="#cb23-177" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-178"><a href="#cb23-178" aria-hidden="true" tabindex="-1"></a><span class="fu">## R</span></span>
<span id="cb23-179"><a href="#cb23-179" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-180"><a href="#cb23-180" aria-hidden="true" tabindex="-1"></a>To perform semantic search, we need to store our text data as vectors (embeddings). We'll use <span class="in">`DuckDB`</span> as our local vector store. We also need an embedding model to convert text into vectors. Here, we configure <span class="in">`ragnar`</span> to use a specific embedding model via an OpenAI-compatible API (SiliconFlow).</span>
<span id="cb23-181"><a href="#cb23-181" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-182"><a href="#cb23-182" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-185"><a href="#cb23-185" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb23-186"><a href="#cb23-186" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: false</span></span>
<span id="cb23-187"><a href="#cb23-187" aria-hidden="true" tabindex="-1"></a><span class="co"># pages &lt;- ragnar_find_links(base_url)</span></span>
<span id="cb23-188"><a href="#cb23-188" aria-hidden="true" tabindex="-1"></a>pages <span class="ot">&lt;-</span> links_full</span>
<span id="cb23-189"><a href="#cb23-189" aria-hidden="true" tabindex="-1"></a>store_location <span class="ot">&lt;-</span> <span class="st">"openrouter.duckdb"</span></span>
<span id="cb23-190"><a href="#cb23-190" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-191"><a href="#cb23-191" aria-hidden="true" tabindex="-1"></a>store <span class="ot">&lt;-</span> <span class="fu">ragnar_store_create</span>(</span>
<span id="cb23-192"><a href="#cb23-192" aria-hidden="true" tabindex="-1"></a>    store_location,</span>
<span id="cb23-193"><a href="#cb23-193" aria-hidden="true" tabindex="-1"></a>    <span class="at">overwrite =</span> <span class="cn">TRUE</span>,</span>
<span id="cb23-194"><a href="#cb23-194" aria-hidden="true" tabindex="-1"></a>    <span class="at">embed =</span> \(x) ragnar<span class="sc">::</span><span class="fu">embed_openai</span>(x,</span>
<span id="cb23-195"><a href="#cb23-195" aria-hidden="true" tabindex="-1"></a>        <span class="at">model =</span> <span class="st">"BAAI/bge-m3"</span>,</span>
<span id="cb23-196"><a href="#cb23-196" aria-hidden="true" tabindex="-1"></a>        <span class="at">base_url =</span> <span class="st">"https://api.siliconflow.cn/v1"</span>,</span>
<span id="cb23-197"><a href="#cb23-197" aria-hidden="true" tabindex="-1"></a>        <span class="at">api_key =</span> <span class="fu">Sys.getenv</span>(<span class="st">"siliconflow"</span>)</span>
<span id="cb23-198"><a href="#cb23-198" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb23-199"><a href="#cb23-199" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb23-200"><a href="#cb23-200" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb23-201"><a href="#cb23-201" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-202"><a href="#cb23-202" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-203"><a href="#cb23-203" aria-hidden="true" tabindex="-1"></a>With our store initialized, we can now ingest the data. We iterate through the list of pages we scraped earlier. For each page, we:</span>
<span id="cb23-204"><a href="#cb23-204" aria-hidden="true" tabindex="-1"></a><span class="ss">1.  </span>Read the content as markdown.</span>
<span id="cb23-205"><a href="#cb23-205" aria-hidden="true" tabindex="-1"></a><span class="ss">2.  </span>Split the content into smaller chunks (approx. 600 characters).</span>
<span id="cb23-206"><a href="#cb23-206" aria-hidden="true" tabindex="-1"></a><span class="ss">3.  </span>Insert these chunks into our vector store.</span>
<span id="cb23-207"><a href="#cb23-207" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-208"><a href="#cb23-208" aria-hidden="true" tabindex="-1"></a>This process builds the index that we'll search against.</span>
<span id="cb23-209"><a href="#cb23-209" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-210"><a href="#cb23-210" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-213"><a href="#cb23-213" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb23-214"><a href="#cb23-214" aria-hidden="true" tabindex="-1"></a><span class="co"># page="https://openrouter.ai/docs/faq"</span></span>
<span id="cb23-215"><a href="#cb23-215" aria-hidden="true" tabindex="-1"></a><span class="co"># chunks &lt;- page |&gt;read_as_markdown() |&gt;markdown_chunk(target_size = 2000)</span></span>
<span id="cb23-216"><a href="#cb23-216" aria-hidden="true" tabindex="-1"></a><span class="co"># ragnar_chunks_view(chunks)</span></span>
<span id="cb23-217"><a href="#cb23-217" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb23-218"><a href="#cb23-218" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-219"><a href="#cb23-219" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-222"><a href="#cb23-222" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb23-223"><a href="#cb23-223" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: false</span></span>
<span id="cb23-224"><a href="#cb23-224" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (page <span class="cf">in</span> pages) {</span>
<span id="cb23-225"><a href="#cb23-225" aria-hidden="true" tabindex="-1"></a>    <span class="fu">message</span>(<span class="st">"ingesting: "</span>, page)</span>
<span id="cb23-226"><a href="#cb23-226" aria-hidden="true" tabindex="-1"></a>    <span class="fu">print</span>(page)</span>
<span id="cb23-227"><a href="#cb23-227" aria-hidden="true" tabindex="-1"></a>    chunks <span class="ot">&lt;-</span> page <span class="sc">|&gt;</span></span>
<span id="cb23-228"><a href="#cb23-228" aria-hidden="true" tabindex="-1"></a>        <span class="fu">read_as_markdown</span>() <span class="sc">|&gt;</span></span>
<span id="cb23-229"><a href="#cb23-229" aria-hidden="true" tabindex="-1"></a>        <span class="fu">markdown_chunk</span>(<span class="at">target_size =</span> <span class="dv">2000</span>)</span>
<span id="cb23-230"><a href="#cb23-230" aria-hidden="true" tabindex="-1"></a>    <span class="co"># print(chunks)</span></span>
<span id="cb23-231"><a href="#cb23-231" aria-hidden="true" tabindex="-1"></a>    <span class="co"># print('chunks done')</span></span>
<span id="cb23-232"><a href="#cb23-232" aria-hidden="true" tabindex="-1"></a>    <span class="fu">ragnar_store_insert</span>(store, chunks)</span>
<span id="cb23-233"><a href="#cb23-233" aria-hidden="true" tabindex="-1"></a>    <span class="fu">print</span>(<span class="st">"insrt done"</span>)</span>
<span id="cb23-234"><a href="#cb23-234" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb23-235"><a href="#cb23-235" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb23-236"><a href="#cb23-236" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-237"><a href="#cb23-237" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-238"><a href="#cb23-238" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-241"><a href="#cb23-241" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb23-242"><a href="#cb23-242" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: false</span></span>
<span id="cb23-243"><a href="#cb23-243" aria-hidden="true" tabindex="-1"></a><span class="fu">ragnar_store_build_index</span>(store)</span>
<span id="cb23-244"><a href="#cb23-244" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb23-245"><a href="#cb23-245" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-246"><a href="#cb23-246" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-247"><a href="#cb23-247" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-248"><a href="#cb23-248" aria-hidden="true" tabindex="-1"></a><span class="fu">## Python DuckDB</span></span>
<span id="cb23-251"><a href="#cb23-251" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb23-252"><a href="#cb23-252" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: false</span></span>
<span id="cb23-253"><a href="#cb23-253" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> os</span>
<span id="cb23-254"><a href="#cb23-254" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> llama_index.core <span class="im">import</span> SimpleDirectoryReader, VectorStoreIndex, StorageContext, Settings</span>
<span id="cb23-255"><a href="#cb23-255" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> llama_index.vector_stores.duckdb <span class="im">import</span> DuckDBVectorStore</span>
<span id="cb23-256"><a href="#cb23-256" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> llama_index.embeddings.openai <span class="im">import</span> OpenAIEmbedding</span>
<span id="cb23-257"><a href="#cb23-257" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-258"><a href="#cb23-258" aria-hidden="true" tabindex="-1"></a><span class="co"># --- 1. Configuration ---</span></span>
<span id="cb23-259"><a href="#cb23-259" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-260"><a href="#cb23-260" aria-hidden="true" tabindex="-1"></a><span class="co"># Ensure your API key is available</span></span>
<span id="cb23-261"><a href="#cb23-261" aria-hidden="true" tabindex="-1"></a>openrouter_api_key <span class="op">=</span> os.getenv(<span class="st">"OPENROUTER_API_KEY"</span>) <span class="co"># or paste string directly</span></span>
<span id="cb23-262"><a href="#cb23-262" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-263"><a href="#cb23-263" aria-hidden="true" tabindex="-1"></a><span class="co"># Initialize the embedding model pointing to OpenRouter</span></span>
<span id="cb23-264"><a href="#cb23-264" aria-hidden="true" tabindex="-1"></a><span class="co"># We use the OpenAI class because OpenRouter uses an OpenAI-compatible API structure</span></span>
<span id="cb23-265"><a href="#cb23-265" aria-hidden="true" tabindex="-1"></a>embed_model <span class="op">=</span> OpenAIEmbedding(</span>
<span id="cb23-266"><a href="#cb23-266" aria-hidden="true" tabindex="-1"></a>    api_key<span class="op">=</span>openrouter_api_key,</span>
<span id="cb23-267"><a href="#cb23-267" aria-hidden="true" tabindex="-1"></a>    api_base<span class="op">=</span><span class="st">"https://openrouter.ai/api/v1"</span>,</span>
<span id="cb23-268"><a href="#cb23-268" aria-hidden="true" tabindex="-1"></a>    model_name<span class="op">=</span><span class="st">"qwen/qwen3-embedding-8b"</span></span>
<span id="cb23-269"><a href="#cb23-269" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb23-270"><a href="#cb23-270" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-271"><a href="#cb23-271" aria-hidden="true" tabindex="-1"></a><span class="co"># Update the global settings so LlamaIndex knows to use this model</span></span>
<span id="cb23-272"><a href="#cb23-272" aria-hidden="true" tabindex="-1"></a>Settings.embed_model <span class="op">=</span> embed_model</span>
<span id="cb23-273"><a href="#cb23-273" aria-hidden="true" tabindex="-1"></a>Settings.chunk_size <span class="op">=</span> <span class="dv">2000</span></span>
<span id="cb23-274"><a href="#cb23-274" aria-hidden="true" tabindex="-1"></a>Settings.chunk_overlap <span class="op">=</span> <span class="dv">200</span></span>
<span id="cb23-275"><a href="#cb23-275" aria-hidden="true" tabindex="-1"></a><span class="co"># --- 2. Ingestion and Indexing ---</span></span>
<span id="cb23-276"><a href="#cb23-276" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-277"><a href="#cb23-277" aria-hidden="true" tabindex="-1"></a><span class="co"># Load data</span></span>
<span id="cb23-278"><a href="#cb23-278" aria-hidden="true" tabindex="-1"></a>documents <span class="op">=</span> SimpleDirectoryReader(<span class="st">"markdown_docs"</span>).load_data()</span>
<span id="cb23-279"><a href="#cb23-279" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-280"><a href="#cb23-280" aria-hidden="true" tabindex="-1"></a><span class="co"># Initialize DuckDB Vector Store</span></span>
<span id="cb23-281"><a href="#cb23-281" aria-hidden="true" tabindex="-1"></a>vector_store <span class="op">=</span> DuckDBVectorStore(<span class="st">"open.duckdb"</span>, persist_dir<span class="op">=</span><span class="st">"./persist/"</span>)</span>
<span id="cb23-282"><a href="#cb23-282" aria-hidden="true" tabindex="-1"></a>storage_context <span class="op">=</span> StorageContext.from_defaults(vector_store<span class="op">=</span>vector_store)</span>
<span id="cb23-283"><a href="#cb23-283" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-284"><a href="#cb23-284" aria-hidden="true" tabindex="-1"></a><span class="co"># Create the index</span></span>
<span id="cb23-285"><a href="#cb23-285" aria-hidden="true" tabindex="-1"></a><span class="co"># This will now automatically use the Qwen embeddings defined in Settings</span></span>
<span id="cb23-286"><a href="#cb23-286" aria-hidden="true" tabindex="-1"></a>index <span class="op">=</span> VectorStoreIndex.from_documents(</span>
<span id="cb23-287"><a href="#cb23-287" aria-hidden="true" tabindex="-1"></a>    documents, </span>
<span id="cb23-288"><a href="#cb23-288" aria-hidden="true" tabindex="-1"></a>    storage_context<span class="op">=</span>storage_context</span>
<span id="cb23-289"><a href="#cb23-289" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb23-290"><a href="#cb23-290" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-291"><a href="#cb23-291" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb23-292"><a href="#cb23-292" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-293"><a href="#cb23-293" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-294"><a href="#cb23-294" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-295"><a href="#cb23-295" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-296"><a href="#cb23-296" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-297"><a href="#cb23-297" aria-hidden="true" tabindex="-1"></a><span class="fu">## Python Chroma</span></span>
<span id="cb23-298"><a href="#cb23-298" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-299"><a href="#cb23-299" aria-hidden="true" tabindex="-1"></a>To perform semantic search, we need to store our text data as vectors (embeddings). We'll use <span class="in">`ChromaDB`</span> as our local vector store. We also need an embedding model to convert text into vectors. Here, we configure a custom <span class="in">`OpenRouterEmbeddings`</span> class to use the <span class="in">`qwen/qwen3-embedding-8b`</span> model via the OpenRouter API.</span>
<span id="cb23-300"><a href="#cb23-300" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-301"><a href="#cb23-301" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-304"><a href="#cb23-304" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb23-305"><a href="#cb23-305" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: false</span></span>
<span id="cb23-306"><a href="#cb23-306" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> openai <span class="im">import</span> OpenAI</span>
<span id="cb23-307"><a href="#cb23-307" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> langchain_core.embeddings <span class="im">import</span> Embeddings</span>
<span id="cb23-308"><a href="#cb23-308" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> langchain_chroma <span class="im">import</span> Chroma</span>
<span id="cb23-309"><a href="#cb23-309" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> typing <span class="im">import</span> List</span>
<span id="cb23-310"><a href="#cb23-310" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> os</span>
<span id="cb23-311"><a href="#cb23-311" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> dotenv <span class="im">import</span> load_dotenv</span>
<span id="cb23-312"><a href="#cb23-312" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-313"><a href="#cb23-313" aria-hidden="true" tabindex="-1"></a>load_dotenv()</span>
<span id="cb23-314"><a href="#cb23-314" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-315"><a href="#cb23-315" aria-hidden="true" tabindex="-1"></a><span class="co"># Custom embeddings class for OpenRouter API</span></span>
<span id="cb23-316"><a href="#cb23-316" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> OpenRouterEmbeddings(Embeddings):</span>
<span id="cb23-317"><a href="#cb23-317" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Custom embeddings class for OpenRouter API."""</span></span>
<span id="cb23-318"><a href="#cb23-318" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb23-319"><a href="#cb23-319" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>, api_key: <span class="bu">str</span>, model: <span class="bu">str</span> <span class="op">=</span> <span class="st">"qwen/qwen3-embedding-8b"</span>):</span>
<span id="cb23-320"><a href="#cb23-320" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.client <span class="op">=</span> OpenAI(</span>
<span id="cb23-321"><a href="#cb23-321" aria-hidden="true" tabindex="-1"></a>            base_url<span class="op">=</span><span class="st">"https://openrouter.ai/api/v1"</span>,</span>
<span id="cb23-322"><a href="#cb23-322" aria-hidden="true" tabindex="-1"></a>            api_key<span class="op">=</span>api_key,</span>
<span id="cb23-323"><a href="#cb23-323" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb23-324"><a href="#cb23-324" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.model <span class="op">=</span> model</span>
<span id="cb23-325"><a href="#cb23-325" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb23-326"><a href="#cb23-326" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> embed_documents(<span class="va">self</span>, texts: List[<span class="bu">str</span>]) <span class="op">-&gt;</span> List[List[<span class="bu">float</span>]]:</span>
<span id="cb23-327"><a href="#cb23-327" aria-hidden="true" tabindex="-1"></a>        <span class="co">"""Embed a list of documents."""</span></span>
<span id="cb23-328"><a href="#cb23-328" aria-hidden="true" tabindex="-1"></a>        response <span class="op">=</span> <span class="va">self</span>.client.embeddings.create(</span>
<span id="cb23-329"><a href="#cb23-329" aria-hidden="true" tabindex="-1"></a>            extra_headers<span class="op">=</span>{</span>
<span id="cb23-330"><a href="#cb23-330" aria-hidden="true" tabindex="-1"></a>                <span class="st">"HTTP-Referer"</span>: <span class="st">"https://ai-blog.com"</span>,</span>
<span id="cb23-331"><a href="#cb23-331" aria-hidden="true" tabindex="-1"></a>                <span class="st">"X-Title"</span>: <span class="st">"AI Blog RAG"</span>,</span>
<span id="cb23-332"><a href="#cb23-332" aria-hidden="true" tabindex="-1"></a>            },</span>
<span id="cb23-333"><a href="#cb23-333" aria-hidden="true" tabindex="-1"></a>            model<span class="op">=</span><span class="va">self</span>.model,</span>
<span id="cb23-334"><a href="#cb23-334" aria-hidden="true" tabindex="-1"></a>            <span class="bu">input</span><span class="op">=</span>texts,</span>
<span id="cb23-335"><a href="#cb23-335" aria-hidden="true" tabindex="-1"></a>            encoding_format<span class="op">=</span><span class="st">"float"</span></span>
<span id="cb23-336"><a href="#cb23-336" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb23-337"><a href="#cb23-337" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> [item.embedding <span class="cf">for</span> item <span class="kw">in</span> response.data]</span>
<span id="cb23-338"><a href="#cb23-338" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb23-339"><a href="#cb23-339" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> embed_query(<span class="va">self</span>, text: <span class="bu">str</span>) <span class="op">-&gt;</span> List[<span class="bu">float</span>]:</span>
<span id="cb23-340"><a href="#cb23-340" aria-hidden="true" tabindex="-1"></a>        <span class="co">"""Embed a single query."""</span></span>
<span id="cb23-341"><a href="#cb23-341" aria-hidden="true" tabindex="-1"></a>        response <span class="op">=</span> <span class="va">self</span>.client.embeddings.create(</span>
<span id="cb23-342"><a href="#cb23-342" aria-hidden="true" tabindex="-1"></a>            extra_headers<span class="op">=</span>{</span>
<span id="cb23-343"><a href="#cb23-343" aria-hidden="true" tabindex="-1"></a>                <span class="st">"HTTP-Referer"</span>: <span class="st">"https://ai-blog.com"</span>,</span>
<span id="cb23-344"><a href="#cb23-344" aria-hidden="true" tabindex="-1"></a>                <span class="st">"X-Title"</span>: <span class="st">"AI Blog RAG"</span>,</span>
<span id="cb23-345"><a href="#cb23-345" aria-hidden="true" tabindex="-1"></a>            },</span>
<span id="cb23-346"><a href="#cb23-346" aria-hidden="true" tabindex="-1"></a>            model<span class="op">=</span><span class="va">self</span>.model,</span>
<span id="cb23-347"><a href="#cb23-347" aria-hidden="true" tabindex="-1"></a>            <span class="bu">input</span><span class="op">=</span>text,</span>
<span id="cb23-348"><a href="#cb23-348" aria-hidden="true" tabindex="-1"></a>            encoding_format<span class="op">=</span><span class="st">"float"</span></span>
<span id="cb23-349"><a href="#cb23-349" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb23-350"><a href="#cb23-350" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> response.data[<span class="dv">0</span>].embedding</span>
<span id="cb23-351"><a href="#cb23-351" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-352"><a href="#cb23-352" aria-hidden="true" tabindex="-1"></a><span class="co"># Get OpenRouter API key</span></span>
<span id="cb23-353"><a href="#cb23-353" aria-hidden="true" tabindex="-1"></a>openrouter_api_key <span class="op">=</span> os.getenv(<span class="st">"OPENROUTER_API_KEY"</span>)</span>
<span id="cb23-354"><a href="#cb23-354" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> <span class="kw">not</span> openrouter_api_key:</span>
<span id="cb23-355"><a href="#cb23-355" aria-hidden="true" tabindex="-1"></a>    <span class="cf">raise</span> <span class="pp">ValueError</span>(<span class="st">"OPENROUTER_API_KEY not found in environment variables"</span>)</span>
<span id="cb23-356"><a href="#cb23-356" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-357"><a href="#cb23-357" aria-hidden="true" tabindex="-1"></a><span class="co"># Create embeddings instance using OpenRouter</span></span>
<span id="cb23-358"><a href="#cb23-358" aria-hidden="true" tabindex="-1"></a>embeddings <span class="op">=</span> OpenRouterEmbeddings(</span>
<span id="cb23-359"><a href="#cb23-359" aria-hidden="true" tabindex="-1"></a>    api_key<span class="op">=</span>openrouter_api_key,</span>
<span id="cb23-360"><a href="#cb23-360" aria-hidden="true" tabindex="-1"></a>    model<span class="op">=</span><span class="st">"qwen/qwen3-embedding-8b"</span></span>
<span id="cb23-361"><a href="#cb23-361" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb23-362"><a href="#cb23-362" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-363"><a href="#cb23-363" aria-hidden="true" tabindex="-1"></a><span class="co"># Define vector store location</span></span>
<span id="cb23-364"><a href="#cb23-364" aria-hidden="true" tabindex="-1"></a>persist_directory <span class="op">=</span> <span class="st">"chroma_db_data"</span></span>
<span id="cb23-365"><a href="#cb23-365" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb23-366"><a href="#cb23-366" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-367"><a href="#cb23-367" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-368"><a href="#cb23-368" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-369"><a href="#cb23-369" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-370"><a href="#cb23-370" aria-hidden="true" tabindex="-1"></a>With our store initialized, we can now ingest the data. We iterate through the markdown files we saved earlier. For each file, we:</span>
<span id="cb23-371"><a href="#cb23-371" aria-hidden="true" tabindex="-1"></a><span class="ss">1.  </span>Load the content.</span>
<span id="cb23-372"><a href="#cb23-372" aria-hidden="true" tabindex="-1"></a><span class="ss">2.  </span>Split the content into smaller chunks (approx. 2000 characters) using <span class="in">`RecursiveCharacterTextSplitter`</span>.</span>
<span id="cb23-373"><a href="#cb23-373" aria-hidden="true" tabindex="-1"></a><span class="ss">3.  </span>Create a new <span class="in">`Chroma`</span> vector store from these chunks.</span>
<span id="cb23-374"><a href="#cb23-374" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-375"><a href="#cb23-375" aria-hidden="true" tabindex="-1"></a>This process builds the index that we'll search against.</span>
<span id="cb23-376"><a href="#cb23-376" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-377"><a href="#cb23-377" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-378"><a href="#cb23-378" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-381"><a href="#cb23-381" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb23-382"><a href="#cb23-382" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: false</span></span>
<span id="cb23-383"><a href="#cb23-383" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> langchain_core.documents <span class="im">import</span> Document</span>
<span id="cb23-384"><a href="#cb23-384" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> langchain_text_splitters <span class="im">import</span> RecursiveCharacterTextSplitter</span>
<span id="cb23-385"><a href="#cb23-385" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> shutil</span>
<span id="cb23-386"><a href="#cb23-386" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-387"><a href="#cb23-387" aria-hidden="true" tabindex="-1"></a><span class="co"># Helper function to load markdown files</span></span>
<span id="cb23-388"><a href="#cb23-388" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> load_markdown_files(directory: <span class="bu">str</span>) <span class="op">-&gt;</span> <span class="bu">list</span>[Document]:</span>
<span id="cb23-389"><a href="#cb23-389" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Load all markdown files from directory and create Document objects."""</span></span>
<span id="cb23-390"><a href="#cb23-390" aria-hidden="true" tabindex="-1"></a>    documents <span class="op">=</span> []</span>
<span id="cb23-391"><a href="#cb23-391" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="kw">not</span> os.path.exists(directory):</span>
<span id="cb23-392"><a href="#cb23-392" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> documents</span>
<span id="cb23-393"><a href="#cb23-393" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb23-394"><a href="#cb23-394" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> filename <span class="kw">in</span> os.listdir(directory):</span>
<span id="cb23-395"><a href="#cb23-395" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> filename.endswith(<span class="st">'.md'</span>):</span>
<span id="cb23-396"><a href="#cb23-396" aria-hidden="true" tabindex="-1"></a>            filepath <span class="op">=</span> os.path.join(directory, filename)</span>
<span id="cb23-397"><a href="#cb23-397" aria-hidden="true" tabindex="-1"></a>            <span class="cf">with</span> <span class="bu">open</span>(filepath, <span class="st">'r'</span>, encoding<span class="op">=</span><span class="st">'utf-8'</span>) <span class="im">as</span> f:</span>
<span id="cb23-398"><a href="#cb23-398" aria-hidden="true" tabindex="-1"></a>                content <span class="op">=</span> f.read()</span>
<span id="cb23-399"><a href="#cb23-399" aria-hidden="true" tabindex="-1"></a>                doc <span class="op">=</span> Document(</span>
<span id="cb23-400"><a href="#cb23-400" aria-hidden="true" tabindex="-1"></a>                    page_content<span class="op">=</span>content,</span>
<span id="cb23-401"><a href="#cb23-401" aria-hidden="true" tabindex="-1"></a>                    metadata<span class="op">=</span>{</span>
<span id="cb23-402"><a href="#cb23-402" aria-hidden="true" tabindex="-1"></a>                        <span class="st">"source"</span>: filename,</span>
<span id="cb23-403"><a href="#cb23-403" aria-hidden="true" tabindex="-1"></a>                        <span class="st">"filepath"</span>: filepath</span>
<span id="cb23-404"><a href="#cb23-404" aria-hidden="true" tabindex="-1"></a>                    }</span>
<span id="cb23-405"><a href="#cb23-405" aria-hidden="true" tabindex="-1"></a>                )</span>
<span id="cb23-406"><a href="#cb23-406" aria-hidden="true" tabindex="-1"></a>                documents.append(doc)</span>
<span id="cb23-407"><a href="#cb23-407" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> documents</span>
<span id="cb23-408"><a href="#cb23-408" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-409"><a href="#cb23-409" aria-hidden="true" tabindex="-1"></a><span class="co"># Create output directory for markdown files</span></span>
<span id="cb23-410"><a href="#cb23-410" aria-hidden="true" tabindex="-1"></a>output_dir <span class="op">=</span> <span class="st">"markdown_docs"</span></span>
<span id="cb23-411"><a href="#cb23-411" aria-hidden="true" tabindex="-1"></a>os.makedirs(output_dir, exist_ok<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb23-412"><a href="#cb23-412" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-413"><a href="#cb23-413" aria-hidden="true" tabindex="-1"></a><span class="co"># Convert each URL to markdown and save</span></span>
<span id="cb23-414"><a href="#cb23-414" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> i, link_url <span class="kw">in</span> <span class="bu">enumerate</span>(links_full, <span class="dv">1</span>):</span>
<span id="cb23-415"><a href="#cb23-415" aria-hidden="true" tabindex="-1"></a>    <span class="cf">try</span>:</span>
<span id="cb23-416"><a href="#cb23-416" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"Processing </span><span class="sc">{</span>i<span class="sc">}</span><span class="ss">/</span><span class="sc">{</span><span class="bu">len</span>(links_full)<span class="sc">}</span><span class="ss">: </span><span class="sc">{</span>link_url<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb23-417"><a href="#cb23-417" aria-hidden="true" tabindex="-1"></a>        html_content <span class="op">=</span> fetch_html(link_url)</span>
<span id="cb23-418"><a href="#cb23-418" aria-hidden="true" tabindex="-1"></a>        markdown_content <span class="op">=</span> html_to_markdown(html_content)</span>
<span id="cb23-419"><a href="#cb23-419" aria-hidden="true" tabindex="-1"></a>        filename <span class="op">=</span> sanitize_filename(link_url)</span>
<span id="cb23-420"><a href="#cb23-420" aria-hidden="true" tabindex="-1"></a>        output_path <span class="op">=</span> os.path.join(output_dir, filename)</span>
<span id="cb23-421"><a href="#cb23-421" aria-hidden="true" tabindex="-1"></a>        save_markdown(markdown_content, output_path)</span>
<span id="cb23-422"><a href="#cb23-422" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"  ✓ Saved to </span><span class="sc">{</span>output_path<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb23-423"><a href="#cb23-423" aria-hidden="true" tabindex="-1"></a>    <span class="cf">except</span> <span class="pp">Exception</span> <span class="im">as</span> e:</span>
<span id="cb23-424"><a href="#cb23-424" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"  ✗ Error processing </span><span class="sc">{</span>link_url<span class="sc">}</span><span class="ss">: </span><span class="sc">{</span><span class="bu">str</span>(e)<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb23-425"><a href="#cb23-425" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-426"><a href="#cb23-426" aria-hidden="true" tabindex="-1"></a><span class="co"># Load markdown documents</span></span>
<span id="cb23-427"><a href="#cb23-427" aria-hidden="true" tabindex="-1"></a>documents <span class="op">=</span> load_markdown_files(output_dir)</span>
<span id="cb23-428"><a href="#cb23-428" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">Loaded </span><span class="sc">{</span><span class="bu">len</span>(documents)<span class="sc">}</span><span class="ss"> markdown documents"</span>)</span>
<span id="cb23-429"><a href="#cb23-429" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-430"><a href="#cb23-430" aria-hidden="true" tabindex="-1"></a><span class="co"># Split documents into chunks</span></span>
<span id="cb23-431"><a href="#cb23-431" aria-hidden="true" tabindex="-1"></a>text_splitter <span class="op">=</span> RecursiveCharacterTextSplitter(</span>
<span id="cb23-432"><a href="#cb23-432" aria-hidden="true" tabindex="-1"></a>    chunk_size<span class="op">=</span><span class="dv">2000</span>,</span>
<span id="cb23-433"><a href="#cb23-433" aria-hidden="true" tabindex="-1"></a>    chunk_overlap<span class="op">=</span><span class="dv">200</span>,</span>
<span id="cb23-434"><a href="#cb23-434" aria-hidden="true" tabindex="-1"></a>    length_function<span class="op">=</span><span class="bu">len</span>,</span>
<span id="cb23-435"><a href="#cb23-435" aria-hidden="true" tabindex="-1"></a>    is_separator_regex<span class="op">=</span><span class="va">False</span>,</span>
<span id="cb23-436"><a href="#cb23-436" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb23-437"><a href="#cb23-437" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-438"><a href="#cb23-438" aria-hidden="true" tabindex="-1"></a>splits <span class="op">=</span> text_splitter.split_documents(documents)</span>
<span id="cb23-439"><a href="#cb23-439" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Split into </span><span class="sc">{</span><span class="bu">len</span>(splits)<span class="sc">}</span><span class="ss"> chunks"</span>)</span>
<span id="cb23-440"><a href="#cb23-440" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb23-441"><a href="#cb23-441" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-442"><a href="#cb23-442" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-445"><a href="#cb23-445" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb23-446"><a href="#cb23-446" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: false</span></span>
<span id="cb23-447"><a href="#cb23-447" aria-hidden="true" tabindex="-1"></a><span class="co"># Remove existing database if it exists</span></span>
<span id="cb23-448"><a href="#cb23-448" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> os.path.exists(persist_directory):</span>
<span id="cb23-449"><a href="#cb23-449" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"Removing existing database at </span><span class="sc">{</span>persist_directory<span class="sc">}</span><span class="ss">..."</span>)</span>
<span id="cb23-450"><a href="#cb23-450" aria-hidden="true" tabindex="-1"></a>    shutil.rmtree(persist_directory)</span>
<span id="cb23-451"><a href="#cb23-451" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-452"><a href="#cb23-452" aria-hidden="true" tabindex="-1"></a><span class="co"># Create new vector store</span></span>
<span id="cb23-453"><a href="#cb23-453" aria-hidden="true" tabindex="-1"></a>vectorstore <span class="op">=</span> Chroma.from_documents(</span>
<span id="cb23-454"><a href="#cb23-454" aria-hidden="true" tabindex="-1"></a>    documents<span class="op">=</span>splits,</span>
<span id="cb23-455"><a href="#cb23-455" aria-hidden="true" tabindex="-1"></a>    embedding<span class="op">=</span>embeddings,</span>
<span id="cb23-456"><a href="#cb23-456" aria-hidden="true" tabindex="-1"></a>    persist_directory<span class="op">=</span>persist_directory</span>
<span id="cb23-457"><a href="#cb23-457" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb23-458"><a href="#cb23-458" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-459"><a href="#cb23-459" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">✓ Successfully created ChromaDB with </span><span class="sc">{</span><span class="bu">len</span>(splits)<span class="sc">}</span><span class="ss"> chunks!"</span>)</span>
<span id="cb23-460"><a href="#cb23-460" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"✓ Database saved to: </span><span class="sc">{</span>persist_directory<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb23-461"><a href="#cb23-461" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb23-462"><a href="#cb23-462" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-463"><a href="#cb23-463" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-464"><a href="#cb23-464" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-465"><a href="#cb23-465" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb23-466"><a href="#cb23-466" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-467"><a href="#cb23-467" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-468"><a href="#cb23-468" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-469"><a href="#cb23-469" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-470"><a href="#cb23-470" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-471"><a href="#cb23-471" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-472"><a href="#cb23-472" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-473"><a href="#cb23-473" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-474"><a href="#cb23-474" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-475"><a href="#cb23-475" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-476"><a href="#cb23-476" aria-hidden="true" tabindex="-1"></a><span class="fu"># Retrieval</span></span>
<span id="cb23-477"><a href="#cb23-477" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-478"><a href="#cb23-478" aria-hidden="true" tabindex="-1"></a>::: {.panel-tabset}</span>
<span id="cb23-479"><a href="#cb23-479" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-480"><a href="#cb23-480" aria-hidden="true" tabindex="-1"></a><span class="fu">## R</span></span>
<span id="cb23-481"><a href="#cb23-481" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-482"><a href="#cb23-482" aria-hidden="true" tabindex="-1"></a>Now that our knowledge base is populated, we can test the retrieval system. We can ask a specific question, like "What are model variants?", and query the store to see which text chunks are most relevant. This confirms that our embeddings and search are working correctly.</span>
<span id="cb23-483"><a href="#cb23-483" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-484"><a href="#cb23-484" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-487"><a href="#cb23-487" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb23-488"><a href="#cb23-488" aria-hidden="true" tabindex="-1"></a>store_location <span class="ot">&lt;-</span> <span class="st">"openrouter.duckdb"</span></span>
<span id="cb23-489"><a href="#cb23-489" aria-hidden="true" tabindex="-1"></a>store <span class="ot">&lt;-</span> <span class="fu">ragnar_store_connect</span>(store_location)</span>
<span id="cb23-490"><a href="#cb23-490" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-491"><a href="#cb23-491" aria-hidden="true" tabindex="-1"></a>text <span class="ot">&lt;-</span> <span class="st">"What are model variants?"</span></span>
<span id="cb23-492"><a href="#cb23-492" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-493"><a href="#cb23-493" aria-hidden="true" tabindex="-1"></a><span class="co">#' # Retrieving Chunks</span></span>
<span id="cb23-494"><a href="#cb23-494" aria-hidden="true" tabindex="-1"></a><span class="co">#' Once the store is set up, retrieve the most relevant text chunks like this</span></span>
<span id="cb23-495"><a href="#cb23-495" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-496"><a href="#cb23-496" aria-hidden="true" tabindex="-1"></a>relevant_chunks <span class="ot">&lt;-</span> <span class="fu">ragnar_retrieve</span>(store, text, <span class="at">top_k =</span> <span class="dv">3</span>)</span>
<span id="cb23-497"><a href="#cb23-497" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Retrieved"</span>, <span class="fu">nrow</span>(relevant_chunks), <span class="st">"chunks:</span><span class="sc">\n\n</span><span class="st">"</span>)</span>
<span id="cb23-498"><a href="#cb23-498" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (i <span class="cf">in</span> <span class="fu">seq_len</span>(<span class="fu">nrow</span>(relevant_chunks))) {</span>
<span id="cb23-499"><a href="#cb23-499" aria-hidden="true" tabindex="-1"></a>    <span class="fu">cat</span>(<span class="fu">sprintf</span>(<span class="st">"--- Chunk %d ---</span><span class="sc">\n</span><span class="st">%s</span><span class="sc">\n\n</span><span class="st">"</span>, i, relevant_chunks<span class="sc">$</span>text[i]))</span>
<span id="cb23-500"><a href="#cb23-500" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb23-501"><a href="#cb23-501" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb23-502"><a href="#cb23-502" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-503"><a href="#cb23-503" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-506"><a href="#cb23-506" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb23-507"><a href="#cb23-507" aria-hidden="true" tabindex="-1"></a><span class="co"># ragnar_store_inspect(store)</span></span>
<span id="cb23-508"><a href="#cb23-508" aria-hidden="true" tabindex="-1"></a><span class="co">#ragnar_chunks_view(chunks)</span></span>
<span id="cb23-509"><a href="#cb23-509" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb23-510"><a href="#cb23-510" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-511"><a href="#cb23-511" aria-hidden="true" tabindex="-1"></a><span class="fu">## Python DuckDB</span></span>
<span id="cb23-512"><a href="#cb23-512" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-513"><a href="#cb23-513" aria-hidden="true" tabindex="-1"></a>In Python, we can use <span class="in">`LlamaIndex`</span> to interact with our DuckDB vector store. In this step, we'll configure the embedding model and retrieve the top relevant chunks for our query, saving them to a file for inspection. We won't use an LLM for generation yet, focusing solely on verifying the retrieval quality.</span>
<span id="cb23-514"><a href="#cb23-514" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-517"><a href="#cb23-517" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb23-518"><a href="#cb23-518" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> os</span>
<span id="cb23-519"><a href="#cb23-519" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> llama_index.core <span class="im">import</span> VectorStoreIndex, Settings</span>
<span id="cb23-520"><a href="#cb23-520" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> llama_index.vector_stores.duckdb <span class="im">import</span> DuckDBVectorStore</span>
<span id="cb23-521"><a href="#cb23-521" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> llama_index.embeddings.openai <span class="im">import</span> OpenAIEmbedding</span>
<span id="cb23-522"><a href="#cb23-522" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> dotenv <span class="im">import</span> load_dotenv</span>
<span id="cb23-523"><a href="#cb23-523" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-524"><a href="#cb23-524" aria-hidden="true" tabindex="-1"></a><span class="co"># Load environment variables</span></span>
<span id="cb23-525"><a href="#cb23-525" aria-hidden="true" tabindex="-1"></a>load_dotenv()</span>
<span id="cb23-526"><a href="#cb23-526" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-527"><a href="#cb23-527" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-528"><a href="#cb23-528" aria-hidden="true" tabindex="-1"></a><span class="co"># Ensure your API key is available</span></span>
<span id="cb23-529"><a href="#cb23-529" aria-hidden="true" tabindex="-1"></a>openrouter_api_key <span class="op">=</span> os.getenv(<span class="st">"OPENROUTER_API_KEY"</span>)</span>
<span id="cb23-530"><a href="#cb23-530" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-531"><a href="#cb23-531" aria-hidden="true" tabindex="-1"></a><span class="co"># 1. Configure Embedding Model</span></span>
<span id="cb23-532"><a href="#cb23-532" aria-hidden="true" tabindex="-1"></a>embed_model <span class="op">=</span> OpenAIEmbedding(</span>
<span id="cb23-533"><a href="#cb23-533" aria-hidden="true" tabindex="-1"></a>    api_key<span class="op">=</span>openrouter_api_key,</span>
<span id="cb23-534"><a href="#cb23-534" aria-hidden="true" tabindex="-1"></a>    api_base<span class="op">=</span><span class="st">"https://openrouter.ai/api/v1"</span>,</span>
<span id="cb23-535"><a href="#cb23-535" aria-hidden="true" tabindex="-1"></a>    model_name<span class="op">=</span><span class="st">"qwen/qwen3-embedding-8b"</span></span>
<span id="cb23-536"><a href="#cb23-536" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb23-537"><a href="#cb23-537" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-538"><a href="#cb23-538" aria-hidden="true" tabindex="-1"></a><span class="co"># 2. Apply Settings</span></span>
<span id="cb23-539"><a href="#cb23-539" aria-hidden="true" tabindex="-1"></a>Settings.embed_model <span class="op">=</span> embed_model</span>
<span id="cb23-540"><a href="#cb23-540" aria-hidden="true" tabindex="-1"></a><span class="co">#Settings.llm = None # Disable LLM</span></span>
<span id="cb23-541"><a href="#cb23-541" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-542"><a href="#cb23-542" aria-hidden="true" tabindex="-1"></a><span class="co"># 3. Load and Retrieve</span></span>
<span id="cb23-543"><a href="#cb23-543" aria-hidden="true" tabindex="-1"></a><span class="co"># Load the existing DuckDB vector store</span></span>
<span id="cb23-544"><a href="#cb23-544" aria-hidden="true" tabindex="-1"></a>vector_store <span class="op">=</span> DuckDBVectorStore(database_name<span class="op">=</span><span class="st">"open.duckdb"</span>, persist_dir<span class="op">=</span><span class="st">"./persist/"</span>)</span>
<span id="cb23-545"><a href="#cb23-545" aria-hidden="true" tabindex="-1"></a>index <span class="op">=</span> VectorStoreIndex.from_vector_store(vector_store<span class="op">=</span>vector_store)</span>
<span id="cb23-546"><a href="#cb23-546" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-547"><a href="#cb23-547" aria-hidden="true" tabindex="-1"></a><span class="co"># Retrieve top 3 chunks</span></span>
<span id="cb23-548"><a href="#cb23-548" aria-hidden="true" tabindex="-1"></a>retriever <span class="op">=</span> index.as_retriever(similarity_top_k<span class="op">=</span><span class="dv">3</span>)</span>
<span id="cb23-549"><a href="#cb23-549" aria-hidden="true" tabindex="-1"></a>nodes <span class="op">=</span> retriever.retrieve(<span class="st">"What are model variants?"</span>)</span>
<span id="cb23-550"><a href="#cb23-550" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-551"><a href="#cb23-551" aria-hidden="true" tabindex="-1"></a><span class="co"># Save retrieved chunks to a markdown file for easy inspection</span></span>
<span id="cb23-552"><a href="#cb23-552" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> <span class="bu">open</span>(<span class="st">"retriever.md"</span>, <span class="st">"w"</span>, encoding<span class="op">=</span><span class="st">"utf-8"</span>) <span class="im">as</span> f:</span>
<span id="cb23-553"><a href="#cb23-553" aria-hidden="true" tabindex="-1"></a>    f.write(<span class="ss">f"# Retrieved </span><span class="sc">{</span><span class="bu">len</span>(nodes)<span class="sc">}</span><span class="ss"> chunks</span><span class="ch">\n\n</span><span class="ss">"</span>)</span>
<span id="cb23-554"><a href="#cb23-554" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> i, node <span class="kw">in</span> <span class="bu">enumerate</span>(nodes, <span class="dv">1</span>):</span>
<span id="cb23-555"><a href="#cb23-555" aria-hidden="true" tabindex="-1"></a>        content <span class="op">=</span> <span class="ss">f"## Chunk </span><span class="sc">{</span>i<span class="sc">}</span><span class="ch">\n\n</span><span class="sc">{</span>node<span class="sc">.</span>text<span class="sc">}</span><span class="ch">\n\n</span><span class="ss">"</span></span>
<span id="cb23-556"><a href="#cb23-556" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(content)</span>
<span id="cb23-557"><a href="#cb23-557" aria-hidden="true" tabindex="-1"></a>        f.write(content)</span>
<span id="cb23-558"><a href="#cb23-558" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb23-559"><a href="#cb23-559" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-560"><a href="#cb23-560" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-561"><a href="#cb23-561" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-562"><a href="#cb23-562" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-563"><a href="#cb23-563" aria-hidden="true" tabindex="-1"></a><span class="fu">## Python Chroma</span></span>
<span id="cb23-564"><a href="#cb23-564" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-565"><a href="#cb23-565" aria-hidden="true" tabindex="-1"></a>Now that our knowledge base is populated, we can test the retrieval system. We can ask a specific question, like "What are model variants?", and query the <span class="in">`Chroma`</span> store to see which text chunks are most relevant. This confirms that our embeddings and search are working correctly.</span>
<span id="cb23-566"><a href="#cb23-566" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-569"><a href="#cb23-569" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb23-570"><a href="#cb23-570" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> openai <span class="im">import</span> OpenAI</span>
<span id="cb23-571"><a href="#cb23-571" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> langchain_core.embeddings <span class="im">import</span> Embeddings</span>
<span id="cb23-572"><a href="#cb23-572" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> langchain_chroma <span class="im">import</span> Chroma</span>
<span id="cb23-573"><a href="#cb23-573" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> typing <span class="im">import</span> List</span>
<span id="cb23-574"><a href="#cb23-574" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> os</span>
<span id="cb23-575"><a href="#cb23-575" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> dotenv <span class="im">import</span> load_dotenv</span>
<span id="cb23-576"><a href="#cb23-576" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-577"><a href="#cb23-577" aria-hidden="true" tabindex="-1"></a>load_dotenv()</span>
<span id="cb23-578"><a href="#cb23-578" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-579"><a href="#cb23-579" aria-hidden="true" tabindex="-1"></a><span class="co"># Custom embeddings class for OpenRouter API</span></span>
<span id="cb23-580"><a href="#cb23-580" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> OpenRouterEmbeddings(Embeddings):</span>
<span id="cb23-581"><a href="#cb23-581" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Custom embeddings class for OpenRouter API."""</span></span>
<span id="cb23-582"><a href="#cb23-582" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb23-583"><a href="#cb23-583" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>, api_key: <span class="bu">str</span>, model: <span class="bu">str</span> <span class="op">=</span> <span class="st">"qwen/qwen3-embedding-8b"</span>):</span>
<span id="cb23-584"><a href="#cb23-584" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.client <span class="op">=</span> OpenAI(</span>
<span id="cb23-585"><a href="#cb23-585" aria-hidden="true" tabindex="-1"></a>            base_url<span class="op">=</span><span class="st">"https://openrouter.ai/api/v1"</span>,</span>
<span id="cb23-586"><a href="#cb23-586" aria-hidden="true" tabindex="-1"></a>            api_key<span class="op">=</span>api_key,</span>
<span id="cb23-587"><a href="#cb23-587" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb23-588"><a href="#cb23-588" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.model <span class="op">=</span> model</span>
<span id="cb23-589"><a href="#cb23-589" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb23-590"><a href="#cb23-590" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> embed_documents(<span class="va">self</span>, texts: List[<span class="bu">str</span>]) <span class="op">-&gt;</span> List[List[<span class="bu">float</span>]]:</span>
<span id="cb23-591"><a href="#cb23-591" aria-hidden="true" tabindex="-1"></a>        <span class="co">"""Embed a list of documents."""</span></span>
<span id="cb23-592"><a href="#cb23-592" aria-hidden="true" tabindex="-1"></a>        response <span class="op">=</span> <span class="va">self</span>.client.embeddings.create(</span>
<span id="cb23-593"><a href="#cb23-593" aria-hidden="true" tabindex="-1"></a>            extra_headers<span class="op">=</span>{</span>
<span id="cb23-594"><a href="#cb23-594" aria-hidden="true" tabindex="-1"></a>                <span class="st">"HTTP-Referer"</span>: <span class="st">"https://ai-blog.com"</span>,</span>
<span id="cb23-595"><a href="#cb23-595" aria-hidden="true" tabindex="-1"></a>                <span class="st">"X-Title"</span>: <span class="st">"AI Blog RAG"</span>,</span>
<span id="cb23-596"><a href="#cb23-596" aria-hidden="true" tabindex="-1"></a>            },</span>
<span id="cb23-597"><a href="#cb23-597" aria-hidden="true" tabindex="-1"></a>            model<span class="op">=</span><span class="va">self</span>.model,</span>
<span id="cb23-598"><a href="#cb23-598" aria-hidden="true" tabindex="-1"></a>            <span class="bu">input</span><span class="op">=</span>texts,</span>
<span id="cb23-599"><a href="#cb23-599" aria-hidden="true" tabindex="-1"></a>            encoding_format<span class="op">=</span><span class="st">"float"</span></span>
<span id="cb23-600"><a href="#cb23-600" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb23-601"><a href="#cb23-601" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> [item.embedding <span class="cf">for</span> item <span class="kw">in</span> response.data]</span>
<span id="cb23-602"><a href="#cb23-602" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb23-603"><a href="#cb23-603" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> embed_query(<span class="va">self</span>, text: <span class="bu">str</span>) <span class="op">-&gt;</span> List[<span class="bu">float</span>]:</span>
<span id="cb23-604"><a href="#cb23-604" aria-hidden="true" tabindex="-1"></a>        <span class="co">"""Embed a single query."""</span></span>
<span id="cb23-605"><a href="#cb23-605" aria-hidden="true" tabindex="-1"></a>        response <span class="op">=</span> <span class="va">self</span>.client.embeddings.create(</span>
<span id="cb23-606"><a href="#cb23-606" aria-hidden="true" tabindex="-1"></a>            extra_headers<span class="op">=</span>{</span>
<span id="cb23-607"><a href="#cb23-607" aria-hidden="true" tabindex="-1"></a>                <span class="st">"HTTP-Referer"</span>: <span class="st">"https://ai-blog.com"</span>,</span>
<span id="cb23-608"><a href="#cb23-608" aria-hidden="true" tabindex="-1"></a>                <span class="st">"X-Title"</span>: <span class="st">"AI Blog RAG"</span>,</span>
<span id="cb23-609"><a href="#cb23-609" aria-hidden="true" tabindex="-1"></a>            },</span>
<span id="cb23-610"><a href="#cb23-610" aria-hidden="true" tabindex="-1"></a>            model<span class="op">=</span><span class="va">self</span>.model,</span>
<span id="cb23-611"><a href="#cb23-611" aria-hidden="true" tabindex="-1"></a>            <span class="bu">input</span><span class="op">=</span>text,</span>
<span id="cb23-612"><a href="#cb23-612" aria-hidden="true" tabindex="-1"></a>            encoding_format<span class="op">=</span><span class="st">"float"</span></span>
<span id="cb23-613"><a href="#cb23-613" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb23-614"><a href="#cb23-614" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> response.data[<span class="dv">0</span>].embedding</span>
<span id="cb23-615"><a href="#cb23-615" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-616"><a href="#cb23-616" aria-hidden="true" tabindex="-1"></a><span class="co"># Get OpenRouter API key</span></span>
<span id="cb23-617"><a href="#cb23-617" aria-hidden="true" tabindex="-1"></a>openrouter_api_key <span class="op">=</span> os.getenv(<span class="st">"OPENROUTER_API_KEY"</span>)</span>
<span id="cb23-618"><a href="#cb23-618" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> <span class="kw">not</span> openrouter_api_key:</span>
<span id="cb23-619"><a href="#cb23-619" aria-hidden="true" tabindex="-1"></a>    <span class="cf">raise</span> <span class="pp">ValueError</span>(<span class="st">"OPENROUTER_API_KEY not found in environment variables"</span>)</span>
<span id="cb23-620"><a href="#cb23-620" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-621"><a href="#cb23-621" aria-hidden="true" tabindex="-1"></a><span class="co"># Create embeddings instance using OpenRouter</span></span>
<span id="cb23-622"><a href="#cb23-622" aria-hidden="true" tabindex="-1"></a>embeddings <span class="op">=</span> OpenRouterEmbeddings(</span>
<span id="cb23-623"><a href="#cb23-623" aria-hidden="true" tabindex="-1"></a>    api_key<span class="op">=</span>openrouter_api_key,</span>
<span id="cb23-624"><a href="#cb23-624" aria-hidden="true" tabindex="-1"></a>    model<span class="op">=</span><span class="st">"qwen/qwen3-embedding-8b"</span></span>
<span id="cb23-625"><a href="#cb23-625" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb23-626"><a href="#cb23-626" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-627"><a href="#cb23-627" aria-hidden="true" tabindex="-1"></a><span class="co"># Define vector store location</span></span>
<span id="cb23-628"><a href="#cb23-628" aria-hidden="true" tabindex="-1"></a>persist_directory <span class="op">=</span> <span class="st">"chroma_db_data"</span></span>
<span id="cb23-629"><a href="#cb23-629" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-630"><a href="#cb23-630" aria-hidden="true" tabindex="-1"></a><span class="co"># Load existing vector store</span></span>
<span id="cb23-631"><a href="#cb23-631" aria-hidden="true" tabindex="-1"></a>vectorstore <span class="op">=</span> Chroma(</span>
<span id="cb23-632"><a href="#cb23-632" aria-hidden="true" tabindex="-1"></a>    persist_directory<span class="op">=</span>persist_directory,</span>
<span id="cb23-633"><a href="#cb23-633" aria-hidden="true" tabindex="-1"></a>    embedding_function<span class="op">=</span>embeddings</span>
<span id="cb23-634"><a href="#cb23-634" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb23-635"><a href="#cb23-635" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-636"><a href="#cb23-636" aria-hidden="true" tabindex="-1"></a><span class="co"># Test query</span></span>
<span id="cb23-637"><a href="#cb23-637" aria-hidden="true" tabindex="-1"></a>query <span class="op">=</span> <span class="st">"What are model variants?"</span></span>
<span id="cb23-638"><a href="#cb23-638" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-639"><a href="#cb23-639" aria-hidden="true" tabindex="-1"></a><span class="co"># Perform similarity search</span></span>
<span id="cb23-640"><a href="#cb23-640" aria-hidden="true" tabindex="-1"></a>results <span class="op">=</span> vectorstore.similarity_search(query, k<span class="op">=</span><span class="dv">5</span>)</span>
<span id="cb23-641"><a href="#cb23-641" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-642"><a href="#cb23-642" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">Query: '</span><span class="sc">{</span>query<span class="sc">}</span><span class="ss">'"</span>)</span>
<span id="cb23-643"><a href="#cb23-643" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Found </span><span class="sc">{</span><span class="bu">len</span>(results)<span class="sc">}</span><span class="ss"> relevant chunks:</span><span class="ch">\n</span><span class="ss">"</span>)</span>
<span id="cb23-644"><a href="#cb23-644" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-645"><a href="#cb23-645" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> i, doc <span class="kw">in</span> <span class="bu">enumerate</span>(results, <span class="dv">1</span>):</span>
<span id="cb23-646"><a href="#cb23-646" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"Result </span><span class="sc">{</span>i<span class="sc">}</span><span class="ss">:"</span>)</span>
<span id="cb23-647"><a href="#cb23-647" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"Source: </span><span class="sc">{</span>doc<span class="sc">.</span>metadata<span class="sc">.</span>get(<span class="st">'source'</span>, <span class="st">'unknown'</span>)<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb23-648"><a href="#cb23-648" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"Content preview: </span><span class="sc">{</span>doc<span class="sc">.</span>page_content[:<span class="dv">800</span>]<span class="sc">}</span><span class="ss">..."</span>)</span>
<span id="cb23-649"><a href="#cb23-649" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb23-650"><a href="#cb23-650" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb23-651"><a href="#cb23-651" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-652"><a href="#cb23-652" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb23-653"><a href="#cb23-653" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-654"><a href="#cb23-654" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-655"><a href="#cb23-655" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-656"><a href="#cb23-656" aria-hidden="true" tabindex="-1"></a><span class="fu"># Chat with RAG</span></span>
<span id="cb23-657"><a href="#cb23-657" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-658"><a href="#cb23-658" aria-hidden="true" tabindex="-1"></a>::: {.panel-tabset}</span>
<span id="cb23-659"><a href="#cb23-659" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-660"><a href="#cb23-660" aria-hidden="true" tabindex="-1"></a><span class="fu">## R</span></span>
<span id="cb23-661"><a href="#cb23-661" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-662"><a href="#cb23-662" aria-hidden="true" tabindex="-1"></a>The final piece is to connect this retrieval capability to a chat interface. We use <span class="in">`ellmer`</span> to create a chat client. Crucially, we register a "retrieval tool" using <span class="in">`ragnar_register_tool_retrieve`</span>. This gives the LLM the ability to query our vector store whenever it needs information to answer a user's question.</span>
<span id="cb23-663"><a href="#cb23-663" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-664"><a href="#cb23-664" aria-hidden="true" tabindex="-1"></a>We also provide a system prompt that instructs the model to always check the knowledge base and cite its sources.</span>
<span id="cb23-665"><a href="#cb23-665" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-666"><a href="#cb23-666" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-669"><a href="#cb23-669" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb23-670"><a href="#cb23-670" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ellmer)</span>
<span id="cb23-671"><a href="#cb23-671" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(dotenv)</span>
<span id="cb23-672"><a href="#cb23-672" aria-hidden="true" tabindex="-1"></a><span class="fu">load_dot_env</span>(<span class="at">file =</span> <span class="st">".env"</span>)</span>
<span id="cb23-673"><a href="#cb23-673" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-674"><a href="#cb23-674" aria-hidden="true" tabindex="-1"></a>chat <span class="ot">&lt;-</span> <span class="fu">chat_openrouter</span>(</span>
<span id="cb23-675"><a href="#cb23-675" aria-hidden="true" tabindex="-1"></a>    <span class="at">api_key =</span> <span class="fu">Sys.getenv</span>(<span class="st">"OPENROUTER_API_KEY"</span>),</span>
<span id="cb23-676"><a href="#cb23-676" aria-hidden="true" tabindex="-1"></a>    <span class="at">model =</span> <span class="st">"openai/gpt-oss-120b"</span>,</span>
<span id="cb23-677"><a href="#cb23-677" aria-hidden="true" tabindex="-1"></a>    <span class="at">system_prompt =</span> glue<span class="sc">::</span><span class="fu">trim</span>(<span class="st">"</span></span>
<span id="cb23-678"><a href="#cb23-678" aria-hidden="true" tabindex="-1"></a><span class="st">  You are an assistant for question-answering tasks. You are concise.</span></span>
<span id="cb23-679"><a href="#cb23-679" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-680"><a href="#cb23-680" aria-hidden="true" tabindex="-1"></a><span class="st">  Before responding, retrieve relevant material from the knowledge store. Quote or</span></span>
<span id="cb23-681"><a href="#cb23-681" aria-hidden="true" tabindex="-1"></a><span class="st">  paraphrase passages, clearly marking your own words versus the source. Provide a</span></span>
<span id="cb23-682"><a href="#cb23-682" aria-hidden="true" tabindex="-1"></a><span class="st">  working link for every source cited, as well as any additional relevant links.</span></span>
<span id="cb23-683"><a href="#cb23-683" aria-hidden="true" tabindex="-1"></a><span class="st">  Do not answer unless you have retrieved and cited a source.If you do not find</span></span>
<span id="cb23-684"><a href="#cb23-684" aria-hidden="true" tabindex="-1"></a><span class="st">  relevant information, say 'I could not find anything relevant in the knowledge base</span></span>
<span id="cb23-685"><a href="#cb23-685" aria-hidden="true" tabindex="-1"></a><span class="st">    "</span>)</span>
<span id="cb23-686"><a href="#cb23-686" aria-hidden="true" tabindex="-1"></a>) <span class="sc">|&gt;</span></span>
<span id="cb23-687"><a href="#cb23-687" aria-hidden="true" tabindex="-1"></a>    <span class="fu">ragnar_register_tool_retrieve</span>(store, <span class="at">top_k =</span> <span class="dv">3</span>)</span>
<span id="cb23-688"><a href="#cb23-688" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-689"><a href="#cb23-689" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-690"><a href="#cb23-690" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb23-691"><a href="#cb23-691" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-692"><a href="#cb23-692" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-695"><a href="#cb23-695" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb23-696"><a href="#cb23-696" aria-hidden="true" tabindex="-1"></a><span class="co">#| results: asis</span></span>
<span id="cb23-697"><a href="#cb23-697" aria-hidden="true" tabindex="-1"></a>chat<span class="sc">$</span><span class="fu">chat</span>(<span class="st">"What are model variants?"</span>)</span>
<span id="cb23-698"><a href="#cb23-698" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb23-699"><a href="#cb23-699" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-700"><a href="#cb23-700" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-701"><a href="#cb23-701" aria-hidden="true" tabindex="-1"></a><span class="fu">## Python chatlas</span></span>
<span id="cb23-702"><a href="#cb23-702" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-703"><a href="#cb23-703" aria-hidden="true" tabindex="-1"></a>We can also use the <span class="in">`chatlas`</span> library to create a chat interface. Here, we define a custom tool <span class="in">`retrieve_trusted_content`</span> that queries our DuckDB index. We then register this tool with the chat model, allowing it to pull in relevant information when answering user questions.</span>
<span id="cb23-704"><a href="#cb23-704" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-705"><a href="#cb23-705" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-708"><a href="#cb23-708" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb23-709"><a href="#cb23-709" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> os</span>
<span id="cb23-710"><a href="#cb23-710" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> chatlas <span class="im">as</span> ctl</span>
<span id="cb23-711"><a href="#cb23-711" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> llama_index.core <span class="im">import</span> VectorStoreIndex, Settings</span>
<span id="cb23-712"><a href="#cb23-712" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> llama_index.vector_stores.duckdb <span class="im">import</span> DuckDBVectorStore</span>
<span id="cb23-713"><a href="#cb23-713" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> llama_index.embeddings.openai <span class="im">import</span> OpenAIEmbedding</span>
<span id="cb23-714"><a href="#cb23-714" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> dotenv <span class="im">import</span> load_dotenv</span>
<span id="cb23-715"><a href="#cb23-715" aria-hidden="true" tabindex="-1"></a>load_dotenv()</span>
<span id="cb23-716"><a href="#cb23-716" aria-hidden="true" tabindex="-1"></a><span class="co"># Ensure API key</span></span>
<span id="cb23-717"><a href="#cb23-717" aria-hidden="true" tabindex="-1"></a>openrouter_api_key <span class="op">=</span> os.getenv(<span class="st">"OPENROUTER_API_KEY"</span>)</span>
<span id="cb23-718"><a href="#cb23-718" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-719"><a href="#cb23-719" aria-hidden="true" tabindex="-1"></a><span class="co"># 1. Configure Embedding Model (LlamaIndex)</span></span>
<span id="cb23-720"><a href="#cb23-720" aria-hidden="true" tabindex="-1"></a>embed_model <span class="op">=</span> OpenAIEmbedding(</span>
<span id="cb23-721"><a href="#cb23-721" aria-hidden="true" tabindex="-1"></a>    api_key<span class="op">=</span>openrouter_api_key,</span>
<span id="cb23-722"><a href="#cb23-722" aria-hidden="true" tabindex="-1"></a>    api_base<span class="op">=</span><span class="st">"https://openrouter.ai/api/v1"</span>,</span>
<span id="cb23-723"><a href="#cb23-723" aria-hidden="true" tabindex="-1"></a>    model_name<span class="op">=</span><span class="st">"qwen/qwen3-embedding-8b"</span></span>
<span id="cb23-724"><a href="#cb23-724" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb23-725"><a href="#cb23-725" aria-hidden="true" tabindex="-1"></a>Settings.embed_model <span class="op">=</span> embed_model</span>
<span id="cb23-726"><a href="#cb23-726" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-727"><a href="#cb23-727" aria-hidden="true" tabindex="-1"></a><span class="co"># 2. Load Vector Store</span></span>
<span id="cb23-728"><a href="#cb23-728" aria-hidden="true" tabindex="-1"></a>vector_store <span class="op">=</span> DuckDBVectorStore(database_name<span class="op">=</span><span class="st">"open.duckdb"</span>, persist_dir<span class="op">=</span><span class="st">"./persist/"</span>)</span>
<span id="cb23-729"><a href="#cb23-729" aria-hidden="true" tabindex="-1"></a>index <span class="op">=</span> VectorStoreIndex.from_vector_store(vector_store<span class="op">=</span>vector_store)</span>
<span id="cb23-730"><a href="#cb23-730" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-731"><a href="#cb23-731" aria-hidden="true" tabindex="-1"></a><span class="co"># 3. Define Retrieval Tool</span></span>
<span id="cb23-732"><a href="#cb23-732" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> retrieve_trusted_content(query: <span class="bu">str</span>, top_k: <span class="bu">int</span> <span class="op">=</span> <span class="dv">5</span>):</span>
<span id="cb23-733"><a href="#cb23-733" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb23-734"><a href="#cb23-734" aria-hidden="true" tabindex="-1"></a><span class="co">    Retrieve relevant content from the knowledge store.</span></span>
<span id="cb23-735"><a href="#cb23-735" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-736"><a href="#cb23-736" aria-hidden="true" tabindex="-1"></a><span class="co">    Parameters</span></span>
<span id="cb23-737"><a href="#cb23-737" aria-hidden="true" tabindex="-1"></a><span class="co">    ----------</span></span>
<span id="cb23-738"><a href="#cb23-738" aria-hidden="true" tabindex="-1"></a><span class="co">    query</span></span>
<span id="cb23-739"><a href="#cb23-739" aria-hidden="true" tabindex="-1"></a><span class="co">        The query used to semantically search the knowledge store.</span></span>
<span id="cb23-740"><a href="#cb23-740" aria-hidden="true" tabindex="-1"></a><span class="co">    top_k</span></span>
<span id="cb23-741"><a href="#cb23-741" aria-hidden="true" tabindex="-1"></a><span class="co">        The number of results to retrieve from the knowledge store.</span></span>
<span id="cb23-742"><a href="#cb23-742" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb23-743"><a href="#cb23-743" aria-hidden="true" tabindex="-1"></a>    <span class="co">#print(f"Retrieving content for query: '{query}'")</span></span>
<span id="cb23-744"><a href="#cb23-744" aria-hidden="true" tabindex="-1"></a>    retriever <span class="op">=</span> index.as_retriever(similarity_top_k<span class="op">=</span>top_k)</span>
<span id="cb23-745"><a href="#cb23-745" aria-hidden="true" tabindex="-1"></a>    nodes <span class="op">=</span> retriever.retrieve(query)</span>
<span id="cb23-746"><a href="#cb23-746" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> [<span class="ss">f"&lt;excerpt&gt;</span><span class="sc">{</span>x<span class="sc">.</span>text<span class="sc">}</span><span class="ss">&lt;/excerpt&gt;"</span> <span class="cf">for</span> x <span class="kw">in</span> nodes]</span>
<span id="cb23-747"><a href="#cb23-747" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-748"><a href="#cb23-748" aria-hidden="true" tabindex="-1"></a><span class="co"># 4. Initialize Chat with System Prompt</span></span>
<span id="cb23-749"><a href="#cb23-749" aria-hidden="true" tabindex="-1"></a>chat <span class="op">=</span> ctl.ChatOpenAI(</span>
<span id="cb23-750"><a href="#cb23-750" aria-hidden="true" tabindex="-1"></a>    model<span class="op">=</span><span class="st">"openai/gpt-oss-120b"</span>,</span>
<span id="cb23-751"><a href="#cb23-751" aria-hidden="true" tabindex="-1"></a>    api_key<span class="op">=</span>openrouter_api_key,</span>
<span id="cb23-752"><a href="#cb23-752" aria-hidden="true" tabindex="-1"></a>    base_url<span class="op">=</span><span class="st">"https://openrouter.ai/api/v1"</span>,</span>
<span id="cb23-753"><a href="#cb23-753" aria-hidden="true" tabindex="-1"></a>    system_prompt<span class="op">=</span>(</span>
<span id="cb23-754"><a href="#cb23-754" aria-hidden="true" tabindex="-1"></a>        <span class="st">"You are an assistant for question-answering tasks. "</span></span>
<span id="cb23-755"><a href="#cb23-755" aria-hidden="true" tabindex="-1"></a>        <span class="st">"Use the retrieve_trusted_content tool to find relevant information from the knowledge store. "</span></span>
<span id="cb23-756"><a href="#cb23-756" aria-hidden="true" tabindex="-1"></a>        <span class="st">"Answer questions based on the retrieved content. "</span></span>
<span id="cb23-757"><a href="#cb23-757" aria-hidden="true" tabindex="-1"></a>        <span class="st">"If you cannot find relevant information, say so clearly."</span></span>
<span id="cb23-758"><a href="#cb23-758" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb23-759"><a href="#cb23-759" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb23-760"><a href="#cb23-760" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-761"><a href="#cb23-761" aria-hidden="true" tabindex="-1"></a>chat.register_tool(retrieve_trusted_content)</span>
<span id="cb23-762"><a href="#cb23-762" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb23-763"><a href="#cb23-763" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-764"><a href="#cb23-764" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-767"><a href="#cb23-767" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb23-768"><a href="#cb23-768" aria-hidden="true" tabindex="-1"></a><span class="co">#| output: false</span></span>
<span id="cb23-769"><a href="#cb23-769" aria-hidden="true" tabindex="-1"></a>response<span class="op">=</span>chat.chat(<span class="st">"What are model variants?"</span>, echo<span class="op">=</span><span class="st">"none"</span>)</span>
<span id="cb23-770"><a href="#cb23-770" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb23-771"><a href="#cb23-771" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-774"><a href="#cb23-774" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb23-775"><a href="#cb23-775" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(response)</span>
<span id="cb23-776"><a href="#cb23-776" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb23-777"><a href="#cb23-777" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-778"><a href="#cb23-778" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-779"><a href="#cb23-779" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-780"><a href="#cb23-780" aria-hidden="true" tabindex="-1"></a><span class="fu">## Python LangChain</span></span>
<span id="cb23-781"><a href="#cb23-781" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-782"><a href="#cb23-782" aria-hidden="true" tabindex="-1"></a>The final piece is to connect this retrieval capability to a chat interface. We use <span class="in">`LangChain`</span> to create a RAG chain. We create a <span class="in">`retriever`</span> from our vector store and combine it with a <span class="in">`ChatOpenAI`</span> model (using OpenRouter) and a prompt template. This gives the LLM the ability to query our vector store whenever it needs information to answer a user's question.</span>
<span id="cb23-783"><a href="#cb23-783" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-786"><a href="#cb23-786" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb23-787"><a href="#cb23-787" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> langchain_openai <span class="im">import</span> ChatOpenAI</span>
<span id="cb23-788"><a href="#cb23-788" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> langchain_core.prompts <span class="im">import</span> ChatPromptTemplate</span>
<span id="cb23-789"><a href="#cb23-789" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> langchain_core.runnables <span class="im">import</span> RunnablePassthrough</span>
<span id="cb23-790"><a href="#cb23-790" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> langchain_core.output_parsers <span class="im">import</span> StrOutputParser</span>
<span id="cb23-791"><a href="#cb23-791" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> openai <span class="im">import</span> OpenAI</span>
<span id="cb23-792"><a href="#cb23-792" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> langchain_core.embeddings <span class="im">import</span> Embeddings</span>
<span id="cb23-793"><a href="#cb23-793" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> langchain_chroma <span class="im">import</span> Chroma</span>
<span id="cb23-794"><a href="#cb23-794" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> typing <span class="im">import</span> List</span>
<span id="cb23-795"><a href="#cb23-795" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> os</span>
<span id="cb23-796"><a href="#cb23-796" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> dotenv <span class="im">import</span> load_dotenv</span>
<span id="cb23-797"><a href="#cb23-797" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-798"><a href="#cb23-798" aria-hidden="true" tabindex="-1"></a>load_dotenv()</span>
<span id="cb23-799"><a href="#cb23-799" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-800"><a href="#cb23-800" aria-hidden="true" tabindex="-1"></a><span class="co"># Custom embeddings class for OpenRouter API</span></span>
<span id="cb23-801"><a href="#cb23-801" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> OpenRouterEmbeddings(Embeddings):</span>
<span id="cb23-802"><a href="#cb23-802" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Custom embeddings class for OpenRouter API."""</span></span>
<span id="cb23-803"><a href="#cb23-803" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb23-804"><a href="#cb23-804" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>, api_key: <span class="bu">str</span>, model: <span class="bu">str</span> <span class="op">=</span> <span class="st">"qwen/qwen3-embedding-8b"</span>):</span>
<span id="cb23-805"><a href="#cb23-805" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.client <span class="op">=</span> OpenAI(</span>
<span id="cb23-806"><a href="#cb23-806" aria-hidden="true" tabindex="-1"></a>            base_url<span class="op">=</span><span class="st">"https://openrouter.ai/api/v1"</span>,</span>
<span id="cb23-807"><a href="#cb23-807" aria-hidden="true" tabindex="-1"></a>            api_key<span class="op">=</span>api_key,</span>
<span id="cb23-808"><a href="#cb23-808" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb23-809"><a href="#cb23-809" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.model <span class="op">=</span> model</span>
<span id="cb23-810"><a href="#cb23-810" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb23-811"><a href="#cb23-811" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> embed_documents(<span class="va">self</span>, texts: List[<span class="bu">str</span>]) <span class="op">-&gt;</span> List[List[<span class="bu">float</span>]]:</span>
<span id="cb23-812"><a href="#cb23-812" aria-hidden="true" tabindex="-1"></a>        <span class="co">"""Embed a list of documents."""</span></span>
<span id="cb23-813"><a href="#cb23-813" aria-hidden="true" tabindex="-1"></a>        response <span class="op">=</span> <span class="va">self</span>.client.embeddings.create(</span>
<span id="cb23-814"><a href="#cb23-814" aria-hidden="true" tabindex="-1"></a>            extra_headers<span class="op">=</span>{</span>
<span id="cb23-815"><a href="#cb23-815" aria-hidden="true" tabindex="-1"></a>                <span class="st">"HTTP-Referer"</span>: <span class="st">"https://ai-blog.com"</span>,</span>
<span id="cb23-816"><a href="#cb23-816" aria-hidden="true" tabindex="-1"></a>                <span class="st">"X-Title"</span>: <span class="st">"AI Blog RAG"</span>,</span>
<span id="cb23-817"><a href="#cb23-817" aria-hidden="true" tabindex="-1"></a>            },</span>
<span id="cb23-818"><a href="#cb23-818" aria-hidden="true" tabindex="-1"></a>            model<span class="op">=</span><span class="va">self</span>.model,</span>
<span id="cb23-819"><a href="#cb23-819" aria-hidden="true" tabindex="-1"></a>            <span class="bu">input</span><span class="op">=</span>texts,</span>
<span id="cb23-820"><a href="#cb23-820" aria-hidden="true" tabindex="-1"></a>            encoding_format<span class="op">=</span><span class="st">"float"</span></span>
<span id="cb23-821"><a href="#cb23-821" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb23-822"><a href="#cb23-822" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> [item.embedding <span class="cf">for</span> item <span class="kw">in</span> response.data]</span>
<span id="cb23-823"><a href="#cb23-823" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb23-824"><a href="#cb23-824" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> embed_query(<span class="va">self</span>, text: <span class="bu">str</span>) <span class="op">-&gt;</span> List[<span class="bu">float</span>]:</span>
<span id="cb23-825"><a href="#cb23-825" aria-hidden="true" tabindex="-1"></a>        <span class="co">"""Embed a single query."""</span></span>
<span id="cb23-826"><a href="#cb23-826" aria-hidden="true" tabindex="-1"></a>        response <span class="op">=</span> <span class="va">self</span>.client.embeddings.create(</span>
<span id="cb23-827"><a href="#cb23-827" aria-hidden="true" tabindex="-1"></a>            extra_headers<span class="op">=</span>{</span>
<span id="cb23-828"><a href="#cb23-828" aria-hidden="true" tabindex="-1"></a>                <span class="st">"HTTP-Referer"</span>: <span class="st">"https://ai-blog.com"</span>,</span>
<span id="cb23-829"><a href="#cb23-829" aria-hidden="true" tabindex="-1"></a>                <span class="st">"X-Title"</span>: <span class="st">"AI Blog RAG"</span>,</span>
<span id="cb23-830"><a href="#cb23-830" aria-hidden="true" tabindex="-1"></a>            },</span>
<span id="cb23-831"><a href="#cb23-831" aria-hidden="true" tabindex="-1"></a>            model<span class="op">=</span><span class="va">self</span>.model,</span>
<span id="cb23-832"><a href="#cb23-832" aria-hidden="true" tabindex="-1"></a>            <span class="bu">input</span><span class="op">=</span>text,</span>
<span id="cb23-833"><a href="#cb23-833" aria-hidden="true" tabindex="-1"></a>            encoding_format<span class="op">=</span><span class="st">"float"</span></span>
<span id="cb23-834"><a href="#cb23-834" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb23-835"><a href="#cb23-835" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> response.data[<span class="dv">0</span>].embedding</span>
<span id="cb23-836"><a href="#cb23-836" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-837"><a href="#cb23-837" aria-hidden="true" tabindex="-1"></a><span class="co"># Get OpenRouter API key</span></span>
<span id="cb23-838"><a href="#cb23-838" aria-hidden="true" tabindex="-1"></a>openrouter_api_key <span class="op">=</span> os.getenv(<span class="st">"OPENROUTER_API_KEY"</span>)</span>
<span id="cb23-839"><a href="#cb23-839" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> <span class="kw">not</span> openrouter_api_key:</span>
<span id="cb23-840"><a href="#cb23-840" aria-hidden="true" tabindex="-1"></a>    <span class="cf">raise</span> <span class="pp">ValueError</span>(<span class="st">"OPENROUTER_API_KEY not found in environment variables"</span>)</span>
<span id="cb23-841"><a href="#cb23-841" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-842"><a href="#cb23-842" aria-hidden="true" tabindex="-1"></a><span class="co"># Create embeddings instance using OpenRouter</span></span>
<span id="cb23-843"><a href="#cb23-843" aria-hidden="true" tabindex="-1"></a>embeddings <span class="op">=</span> OpenRouterEmbeddings(</span>
<span id="cb23-844"><a href="#cb23-844" aria-hidden="true" tabindex="-1"></a>    api_key<span class="op">=</span>openrouter_api_key,</span>
<span id="cb23-845"><a href="#cb23-845" aria-hidden="true" tabindex="-1"></a>    model<span class="op">=</span><span class="st">"qwen/qwen3-embedding-8b"</span></span>
<span id="cb23-846"><a href="#cb23-846" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb23-847"><a href="#cb23-847" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-848"><a href="#cb23-848" aria-hidden="true" tabindex="-1"></a><span class="co"># Define vector store location</span></span>
<span id="cb23-849"><a href="#cb23-849" aria-hidden="true" tabindex="-1"></a>persist_directory <span class="op">=</span> <span class="st">"chroma_db_data"</span></span>
<span id="cb23-850"><a href="#cb23-850" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-851"><a href="#cb23-851" aria-hidden="true" tabindex="-1"></a><span class="co"># Load existing vector store</span></span>
<span id="cb23-852"><a href="#cb23-852" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Loading existing vectorstore from </span><span class="sc">{</span>persist_directory<span class="sc">}</span><span class="ss">..."</span>)</span>
<span id="cb23-853"><a href="#cb23-853" aria-hidden="true" tabindex="-1"></a>vectorstore <span class="op">=</span> Chroma(</span>
<span id="cb23-854"><a href="#cb23-854" aria-hidden="true" tabindex="-1"></a>    persist_directory<span class="op">=</span>persist_directory,</span>
<span id="cb23-855"><a href="#cb23-855" aria-hidden="true" tabindex="-1"></a>    embedding_function<span class="op">=</span>embeddings</span>
<span id="cb23-856"><a href="#cb23-856" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb23-857"><a href="#cb23-857" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"✓ Loaded vectorstore"</span>)</span>
<span id="cb23-858"><a href="#cb23-858" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-859"><a href="#cb23-859" aria-hidden="true" tabindex="-1"></a><span class="co"># Initialize LLM using OpenRouter</span></span>
<span id="cb23-860"><a href="#cb23-860" aria-hidden="true" tabindex="-1"></a>llm <span class="op">=</span> ChatOpenAI(</span>
<span id="cb23-861"><a href="#cb23-861" aria-hidden="true" tabindex="-1"></a>    model<span class="op">=</span><span class="st">"openai/gpt-oss-120b"</span>,</span>
<span id="cb23-862"><a href="#cb23-862" aria-hidden="true" tabindex="-1"></a>    openai_api_key<span class="op">=</span>os.getenv(<span class="st">"OPENROUTER_API_KEY"</span>),</span>
<span id="cb23-863"><a href="#cb23-863" aria-hidden="true" tabindex="-1"></a>    openai_api_base<span class="op">=</span><span class="st">"https://openrouter.ai/api/v1"</span></span>
<span id="cb23-864"><a href="#cb23-864" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb23-865"><a href="#cb23-865" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-866"><a href="#cb23-866" aria-hidden="true" tabindex="-1"></a><span class="co"># Create prompt template</span></span>
<span id="cb23-867"><a href="#cb23-867" aria-hidden="true" tabindex="-1"></a>system_prompt <span class="op">=</span> (</span>
<span id="cb23-868"><a href="#cb23-868" aria-hidden="true" tabindex="-1"></a>    <span class="st">"You are an assistant for question-answering tasks. "</span></span>
<span id="cb23-869"><a href="#cb23-869" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Use the following pieces of retrieved context to answer "</span></span>
<span id="cb23-870"><a href="#cb23-870" aria-hidden="true" tabindex="-1"></a>    <span class="st">"the question. If you don't know the answer, say that you "</span></span>
<span id="cb23-871"><a href="#cb23-871" aria-hidden="true" tabindex="-1"></a>    <span class="st">"don't know. Use three sentences maximum and keep the "</span></span>
<span id="cb23-872"><a href="#cb23-872" aria-hidden="true" tabindex="-1"></a>    <span class="st">"answer concise."</span></span>
<span id="cb23-873"><a href="#cb23-873" aria-hidden="true" tabindex="-1"></a>    <span class="st">"</span><span class="ch">\n\n</span><span class="st">"</span></span>
<span id="cb23-874"><a href="#cb23-874" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Context: </span><span class="sc">{context}</span><span class="st">"</span></span>
<span id="cb23-875"><a href="#cb23-875" aria-hidden="true" tabindex="-1"></a>    <span class="st">"</span><span class="ch">\n\n</span><span class="st">"</span></span>
<span id="cb23-876"><a href="#cb23-876" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Question: </span><span class="sc">{question}</span><span class="st">"</span></span>
<span id="cb23-877"><a href="#cb23-877" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb23-878"><a href="#cb23-878" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-879"><a href="#cb23-879" aria-hidden="true" tabindex="-1"></a>prompt <span class="op">=</span> ChatPromptTemplate.from_template(system_prompt)</span>
<span id="cb23-880"><a href="#cb23-880" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-881"><a href="#cb23-881" aria-hidden="true" tabindex="-1"></a><span class="co"># Create retriever</span></span>
<span id="cb23-882"><a href="#cb23-882" aria-hidden="true" tabindex="-1"></a>retriever <span class="op">=</span> vectorstore.as_retriever(search_kwargs<span class="op">=</span>{<span class="st">"k"</span>: <span class="dv">3</span>})</span>
<span id="cb23-883"><a href="#cb23-883" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-884"><a href="#cb23-884" aria-hidden="true" tabindex="-1"></a><span class="co"># Helper function to format documents</span></span>
<span id="cb23-885"><a href="#cb23-885" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> format_docs(docs):</span>
<span id="cb23-886"><a href="#cb23-886" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="st">"</span><span class="ch">\n\n</span><span class="st">"</span>.join(doc.page_content <span class="cf">for</span> doc <span class="kw">in</span> docs)</span>
<span id="cb23-887"><a href="#cb23-887" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-888"><a href="#cb23-888" aria-hidden="true" tabindex="-1"></a><span class="co"># Create RAG chain using LCEL</span></span>
<span id="cb23-889"><a href="#cb23-889" aria-hidden="true" tabindex="-1"></a>rag_chain <span class="op">=</span> (</span>
<span id="cb23-890"><a href="#cb23-890" aria-hidden="true" tabindex="-1"></a>    {</span>
<span id="cb23-891"><a href="#cb23-891" aria-hidden="true" tabindex="-1"></a>        <span class="st">"context"</span>: retriever <span class="op">|</span> format_docs,</span>
<span id="cb23-892"><a href="#cb23-892" aria-hidden="true" tabindex="-1"></a>        <span class="st">"question"</span>: RunnablePassthrough()</span>
<span id="cb23-893"><a href="#cb23-893" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb23-894"><a href="#cb23-894" aria-hidden="true" tabindex="-1"></a>    <span class="op">|</span> prompt</span>
<span id="cb23-895"><a href="#cb23-895" aria-hidden="true" tabindex="-1"></a>    <span class="op">|</span> llm</span>
<span id="cb23-896"><a href="#cb23-896" aria-hidden="true" tabindex="-1"></a>    <span class="op">|</span> StrOutputParser()</span>
<span id="cb23-897"><a href="#cb23-897" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb23-898"><a href="#cb23-898" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-899"><a href="#cb23-899" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"✓ RAG chain created successfully!"</span>)</span>
<span id="cb23-900"><a href="#cb23-900" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-901"><a href="#cb23-901" aria-hidden="true" tabindex="-1"></a><span class="co"># Test the RAG chain</span></span>
<span id="cb23-902"><a href="#cb23-902" aria-hidden="true" tabindex="-1"></a>question <span class="op">=</span> <span class="st">"What are model variants?"</span></span>
<span id="cb23-903"><a href="#cb23-903" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-904"><a href="#cb23-904" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">Question: </span><span class="sc">{</span>question<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb23-905"><a href="#cb23-905" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-906"><a href="#cb23-906" aria-hidden="true" tabindex="-1"></a><span class="co"># Get context documents separately for display</span></span>
<span id="cb23-907"><a href="#cb23-907" aria-hidden="true" tabindex="-1"></a>context_docs <span class="op">=</span> retriever.invoke(question)</span>
<span id="cb23-908"><a href="#cb23-908" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-909"><a href="#cb23-909" aria-hidden="true" tabindex="-1"></a><span class="co"># Invoke the RAG chain</span></span>
<span id="cb23-910"><a href="#cb23-910" aria-hidden="true" tabindex="-1"></a>answer <span class="op">=</span> rag_chain.invoke(question)</span>
<span id="cb23-911"><a href="#cb23-911" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> textwrap</span>
<span id="cb23-912"><a href="#cb23-912" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-913"><a href="#cb23-913" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> line <span class="kw">in</span> answer.split(<span class="st">'</span><span class="ch">\n</span><span class="st">'</span>):</span>
<span id="cb23-914"><a href="#cb23-914" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(textwrap.fill(line, width<span class="op">=</span><span class="dv">80</span>))</span>
<span id="cb23-915"><a href="#cb23-915" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-916"><a href="#cb23-916" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-917"><a href="#cb23-917" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb23-918"><a href="#cb23-918" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-919"><a href="#cb23-919" aria-hidden="true" tabindex="-1"></a>:::</span>
</code></pre></div><button title="Copy to Clipboard" class="code-copy-button" data-in-quarto-modal=""><i class="bi"></i></button></div>
</div></div></div></div></div>
</div> <!-- /content -->




</body></html>